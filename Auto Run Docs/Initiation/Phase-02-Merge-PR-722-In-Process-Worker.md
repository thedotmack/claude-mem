# Phase 02: Resolve Conflicts and Merge PR #722 - In-Process Worker Architecture

PR #722 replaces spawn-based worker startup with in-process architecture. Hook processes become the worker when port 37777 is free, eliminating Windows spawn issues. This PR has merge conflicts that must be resolved before merging.

## Tasks

- [x] Checkout PR #722 and assess conflict scope:
  - `git fetch origin bugfix/claude-md-index`
  - `git checkout bugfix/claude-md-index`
  - `git merge main` to see conflicts
  - List all conflicting files

  **Completed 2026-02-04:** Identified 8 conflicting files:
  - `docs/CLAUDE.md` (delete/modify - accepted main)
  - `plugin/CLAUDE.md` (delete/modify - accepted main)
  - `plugin/hooks/hooks.json` (content conflict - merged both features)
  - `plugin/scripts/mcp-server.cjs` (build artifact - accepted main)
  - `plugin/scripts/worker-service.cjs` (build artifact - accepted main)
  - `src/services/domain/CLAUDE.md` (delete/modify - accepted main)
  - `src/services/sqlite/CLAUDE.md` (delete/modify - accepted main)
  - `src/utils/claude-md-utils.ts` (content conflict - preserved #794 fix from main)

- [x] Resolve merge conflicts in each affected file:
  - For each conflict, understand both sides:
    - Main branch changes (likely from PR #856 merge)
    - PR #722 changes (in-process worker architecture)
  - Preserve both sets of functionality where possible
  - Key files likely affected:
    - `src/services/worker-service.ts`
    - `src/services/queue/SessionQueueProcessor.ts`
    - `plugin/hooks/hooks.json`

  **Completed 2026-02-04:** All conflicts resolved:
  - CLAUDE.md files: Accepted main's versions (project uses these for context)
  - Build artifacts: Accepted main's versions (will be regenerated by build)
  - hooks.json: Combined PR #722's chained command (smart-install + stop + hook) with main's dual-hook structure
  - claude-md-utils.ts: Preserved main's #794 fix for empty CLAUDE.md handling

- [ ] Run tests after conflict resolution:
  - `npm test`
  - All tests must pass (761+ expected)
  - Report any failures with details

- [ ] Run build after conflict resolution:
  - `npm run build`
  - Verify no TypeScript errors
  - Verify all artifacts are generated

- [ ] Code review the in-process worker changes:
  - Verify `worker-service.ts` hook case starts WorkerService in-process when port free
  - Verify `hook-command.ts` has `skipExit` option
  - Verify `hooks.json` uses single chained command
  - Verify `worker-utils.ts` `ensureWorkerRunning()` returns boolean

- [ ] Commit conflict resolution and push:
  - `git add .`
  - `git commit -m "chore: resolve merge conflicts with main"`
  - `git push origin bugfix/claude-md-index`

- [ ] Merge PR #722 to main:
  - Wait for CI to pass after push
  - `gh pr merge 722 --squash --delete-branch`
  - Verify merge succeeded

- [ ] Run post-merge verification:
  - `git checkout main && git pull origin main`
  - `npm test` to confirm tests pass on main
  - `npm run build` to confirm build works
