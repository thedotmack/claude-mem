# claude-mem v5.1: Web UI Implementation Plan

**Status**: Draft
**Created**: 2025-11-05
**Revised**: 2025-11-05

---

## Goal

Add a real-time web viewer to claude-mem that displays observations and summaries as they're captured. Served from the worker at `localhost:37777`, using Server-Sent Events (SSE) for live updates.

**Key Principles**:
- Local-first: Zero external API calls
- Simple: Vanilla JS, no build step for UI
- Direct: Worker calls `broadcastSSE()` after DB writes
- Auditable: AGPL 3.0, readable code

---

## Phase 1: Understand Current Build System

### 1.1 Read Build Configuration
- Read `scripts/build-hooks.js` - understand what gets built and where it goes
- Read `package.json` - check build/sync commands
- Read `.gitignore` - understand what's source vs built
- Determine: Where should UI source files live?
- Determine: Where do they end up after build/sync?

### 1.2 Verify Current Worker Setup
- Read `src/services/worker-service.ts` - understand current routes and structure
- Find where the worker gets started
- Check what port it runs on
- Verify it's an Express app

---

## Phase 2: Add SSE Infrastructure to Worker

### 2.1 Read Observation Storage Code
- Read `src/services/worker-service.ts` - find `handleAgentMessage()`
- Understand how observations get stored to DB
- Understand how summaries get stored to DB
- Find the exact line where `storeObservation()` completes successfully

### 2.2 Add SSE Endpoint
- Add `GET /stream` endpoint to worker-service.ts
- Set proper SSE headers (`Content-Type: text/event-stream`, `Cache-Control: no-cache`, etc.)
- Create `sseClients: Set<Response>` to track connections
- On connect: send initial data snapshot (last 100 observations, 50 summaries)
- On disconnect: remove client from set

### 2.3 Add Broadcast Function
- Add `broadcastSSE(event: any)` function
- Loop through `sseClients` and write `data: ${JSON.stringify(event)}\n\n`
- Handle client disconnections gracefully

### 2.4 Integrate Broadcasts
- In `handleAgentMessage()`, after `storeObservation()` succeeds, call `broadcastSSE({ type: 'new_observation', observation: {...} })`
- In `handleAgentMessage()`, after `storeSummary()` succeeds, call `broadcastSSE({ type: 'new_summary', summary: {...} })`

### 2.5 Test SSE Works
- Build: `npm run build`
- Sync: `npm run sync-marketplace`
- Restart: `npm run worker:restart`
- Test: `curl -N http://localhost:37777/stream`
- Verify: See `data: {...}` with initial_load event
- Verify: Logs show "SSE Client connected"

---

## Phase 3: Create Viewer HTML with Settings UI

### 3.1 Determine File Location
- Based on Phase 1 findings, create UI directory in source tree
- Create `viewer.html` file

### 3.2 Build 2-Column Layout
- Terminal aesthetic: black background, green text, monospace font
- **Layout**: 2 columns (60% left, 40% right)
- **Left Column**: Live observation stream
  - Header: "claude-mem viewer" + connection status + project filter dropdown
  - Main feed: Scrolling list of observations/summaries
  - Observation cards: Type indicator (colored left border), title, subtitle, metadata, expandable details
  - Summary cards: Different styling, all fields visible
  - JavaScript: EventSource connection to `/stream`, handle `initial_load`, `new_observation`, `new_summary` events
- **Right Column**: Settings editor
  - Header: "Settings" + save button + status indicator
  - Editable form for `~/.claude/settings.json` env vars:
    - `CLAUDE_MEM_MODEL` (dropdown: haiku-4-5, sonnet-4-5, opus-4)
    - `CLAUDE_MEM_CONTEXT_OBSERVATIONS` (number input)
    - `CLAUDE_MEM_WORKER_PORT` (number input)
  - Stats section:
    - Worker status: version, uptime, active sessions, SSE clients
    - Database: path, size, observation count, session count, summary count
  - Keyboard shortcuts: `?` for help

### 3.3 Add Route to Serve Viewer
- In worker-service.ts, add `GET /` route
- Read viewer.html file and send as response
- Set `Content-Type: text/html`

### 3.4 Test Viewer
- Build, sync, restart worker
- Visit `http://localhost:37777` in browser
- Verify: Page loads with 2-column layout
- Verify: Left column shows "Connected" status
- Verify: Right column shows settings form
- Verify: Initial observations render in left column
- Trigger new observation (start Claude Code session, do something)
- Verify: New observation appears in left column without refresh

---

## Phase 4: Add Settings API Endpoints

### 4.1 Add Stats API Endpoint
- In worker-service.ts, add `GET /api/stats` route
- Query DB for counts (observations, sessions, summaries)
- Get DB file size
- Get worker status (version, uptime, active sessions, SSE client count)
- Return JSON with all stats

### 4.2 Add Settings Read API
- In worker-service.ts, add `GET /api/settings` route
- Read `~/.claude/settings.json` file
- Extract relevant env vars:
  - `CLAUDE_MEM_MODEL`
  - `CLAUDE_MEM_CONTEXT_OBSERVATIONS`
  - `CLAUDE_MEM_WORKER_PORT`
- Return JSON with current values

### 4.3 Add Settings Write API
- In worker-service.ts, add `POST /api/settings` route
- Validate incoming JSON (ensure valid model names, numeric values for counts/ports)
- Read current `~/.claude/settings.json`
- Merge incoming env vars with existing settings
- Write updated JSON back to file
- Return success/error response

### 4.4 Test Settings API
- Build, sync, restart worker
- Test stats: `curl http://localhost:37777/api/stats`
- Test read: `curl http://localhost:37777/api/settings`
- Test write: `curl -X POST -H "Content-Type: application/json" -d '{"CLAUDE_MEM_MODEL":"claude-sonnet-4-5"}' http://localhost:37777/api/settings`
- Verify: `~/.claude/settings.json` updated correctly
- Verify: Changes don't break existing settings

---

## Phase 5: Testing

### 5.1 SSE Connection Tests
- Start worker
- Connect with curl: `curl -N http://localhost:37777/stream`
- Verify initial_load event received
- Open browser, check DevTools Network tab
- Verify EventSource connection stays open

### 5.2 Real-time Update Tests
- Open viewer in browser
- Start Claude Code session
- Make changes that generate observations
- Verify observations appear in viewer without refresh
- Check latency (should be <200ms from DB write to UI update)

### 5.3 Multi-Client Tests
- Open viewer in 2 browser tabs
- Trigger observation
- Verify both tabs update simultaneously

### 5.4 Reconnection Tests
- Open viewer
- Restart worker: `npm run worker:restart`
- Verify browser reconnects automatically (EventSource handles this)
- Verify new initial_load event received

### 5.5 Settings Save/Load Tests
- Open viewer in browser
- Change setting in right column (e.g., change model from haiku to sonnet)
- Click save
- Verify: Success message appears
- Refresh browser
- Verify: Changed setting persists
- Check `~/.claude/settings.json` file directly
- Verify: File updated correctly

### 5.6 Settings Validation Tests
- Try invalid model name
- Verify: Error message, no save
- Try negative number for observation count
- Verify: Error message, no save
- Try non-numeric value for port
- Verify: Error message, no save

### 5.7 Project Filter Tests
- Load viewer with multi-project database
- Select project from dropdown in left column
- Verify only that project's observations shown

### 5.8 Performance Tests
- Database with 1000+ observations
- Load viewer
- Verify initial load <2s
- Verify smooth scrolling at 60fps in left column
- Verify settings UI in right column remains responsive

---

## Success Criteria

1. **Performance**: Initial load <2s with 1000+ observations, SSE latency <200ms
2. **Reliability**: Zero data loss, auto-reconnect within 5s, handles 10+ clients
3. **Privacy**: Zero external requests (verify in DevTools)
4. **Usability**: Works out of box at localhost:37777, no config required

---

## Implementation Order

1. Phase 1 (understand build) - 15 minutes
2. Phase 2 (SSE infrastructure) - 2 hours
3. Phase 3 (2-column viewer with settings UI) - 4 hours
4. Phase 4 (settings API endpoints) - 2 hours
5. Phase 5 (testing) - 2 hours

**Total: 10-11 hours**

---

## File Changes (Estimated, Will Verify in Phase 1)

**Modified**:
- `src/services/worker-service.ts` (add SSE, routes, broadcasts, settings APIs)
- `scripts/build-hooks.js` (possibly, if UI files need copying)

**New**:
- UI source files (location TBD in Phase 1)
- `viewer.html` (2-column layout with live stream + settings editor)

**Deployment**:
```bash
npm run build
npm run sync-marketplace
npm run worker:restart
```

---

## Settings API Design

### GET /api/settings
**Response**:
```json
{
  "CLAUDE_MEM_MODEL": "claude-haiku-4-5",
  "CLAUDE_MEM_CONTEXT_OBSERVATIONS": "50",
  "CLAUDE_MEM_WORKER_PORT": "37777"
}
```

### POST /api/settings
**Request**:
```json
{
  "CLAUDE_MEM_MODEL": "claude-sonnet-4-5",
  "CLAUDE_MEM_CONTEXT_OBSERVATIONS": "100"
}
```

**Response (success)**:
```json
{
  "success": true,
  "message": "Settings updated successfully"
}
```

**Response (error)**:
```json
{
  "success": false,
  "error": "Invalid model name: claude-invalid-model"
}
```

### GET /api/stats
**Response**:
```json
{
  "worker": {
    "version": "5.0.3",
    "uptime": 3600,
    "activeSessions": 2,
    "sseClients": 1,
    "port": 37777
  },
  "database": {
    "path": "~/.claude-mem/claude-mem.db",
    "size": 1048576,
    "observations": 1234,
    "sessions": 56,
    "summaries": 45
  }
}
```
