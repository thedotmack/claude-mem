# SDK Upgrade Proposal: @anthropic-ai/claude-agent-sdk 0.1.77 to 0.2.49

**Date**: 2026-02-20 (updated 2026-02-22)
**Author**: Generated by Claude Code analysis
**Status**: Draft
**Priority**: High - current version is end-of-life (0.1.x branch), latest is 0.2.49

---

## 1. Executive Summary

The claude-mem project currently depends on `@anthropic-ai/claude-agent-sdk@^0.1.76` (installed: 0.1.77). The SDK has undergone a major version bump to 0.2.x, with the latest release being 0.2.49 (corresponding to Claude Code v2.1.49). This is a significant upgrade spanning 49+ releases with both breaking changes and valuable new capabilities.

**Key findings:**

- The `query()` function signature and `Options` type are **largely backward-compatible** -- the core API surface claude-mem uses is preserved
- The type export structure **changed significantly** (single flat `sdk.d.ts` instead of multi-file entrypoints)
- Several new capabilities directly address claude-mem pain points: `Query.close()`, `stop_reason`, `sessionId` option, `debug`/`debugFile` options, and memory leak fixes
- The Zod peer dependency changed from `^3.25.0 || ^4.0.0` to `^4.0.0` only (breaking if claude-mem uses Zod 3 anywhere)
- **Risk level: Medium** -- the actual API surface claude-mem uses is stable, but type re-exports and edge cases need verification
- **Known upstream issues**: Several open GitHub issues affect process lifecycle, WSL2 compatibility, and orphan cleanup -- see Section 5.6

---

## 2. Current State Analysis

### 2.1 SDK Import Points

There are exactly **4 files** that import from `@anthropic-ai/claude-agent-sdk`:

| File | Import | Purpose |
|------|--------|---------|
| `src/services/worker/SDKAgent.ts` | `import { query } from '...'` | Core SDK usage: spawns Claude subprocess |
| `src/services/worker-types.ts` | `export type { SDKUserMessage } from '...'` | Re-exports the user message type |
| `scripts/translate-readme/index.ts` | `import { query, type SDKMessage, type SDKResultMessage } from '...'` | Translation script (non-core) |
| `scripts/bug-report/index.ts` | `import { query, type SDKMessage, type SDKResultMessage } from '...'` | Bug report generator (non-core) |

### 2.2 Core SDK API Usage in SDKAgent.ts

The `SDKAgent.startSession()` method calls `query()` with these options:

```typescript
const queryResult = query({
  prompt: messageGenerator,        // AsyncIterableIterator<SDKUserMessage>
  options: {
    model: modelId,                // string
    cwd: OBSERVER_SESSIONS_DIR,    // string
    resume: session.memorySessionId, // string (conditional)
    disallowedTools,               // string[]
    abortController: session.abortController, // AbortController
    pathToClaudeCodeExecutable: claudePath,   // string
    spawnClaudeCodeProcess: createPidCapturingSpawn(sessionDbId), // custom spawn
    env: isolatedEnv               // Record<string, string>
  }
});
```

The response iteration consumes:
- `message.session_id` (string) -- captured for resume
- `message.type === 'assistant'` -- extracts content, usage tokens
- `message.type === 'result' && message.subtype === 'success'` -- completion telemetry
- `message.message.content` (string | Array) -- text extraction
- `message.message.usage` -- token counting

### 2.3 SDKUserMessage Type Usage

The `SDKUserMessage` type is yielded from the async generator in `createMessageGenerator()`:

```typescript
yield {
  type: 'user',
  message: { role: 'user', content: initPrompt },
  session_id: session.contentSessionId,
  parent_tool_use_id: null,
  isSynthetic: true
};
```

### 2.4 SpawnedProcess Interface Usage

`ProcessRegistry.ts` implements a custom `spawnClaudeCodeProcess` that returns an object matching the `SpawnedProcess` interface:

```typescript
return {
  stdin: child.stdin,
  stdout: child.stdout,
  get killed() { return child.killed; },
  get exitCode() { return child.exitCode; },
  kill: child.kill.bind(child),
  on: child.on.bind(child),
  once: child.once.bind(child),
  off: child.off.bind(child)
};
```

### 2.5 Test Coverage

There is one dedicated test file for SDK integration: `tests/sdk-agent-resume.test.ts`. It tests the resume parameter logic in isolation (without actually calling the SDK). There are no integration tests that exercise the real `query()` function.

---

## 3. Breaking Changes Analysis

### 3.1 Type Export Structure (BREAKING)

**0.1.77**: Types spread across multiple entrypoint files:
```
sdk.d.ts -> entrypoints/agentSdkTypes.d.ts
           -> entrypoints/sdk/coreTypes.d.ts
           -> entrypoints/sdk/runtimeTypes.d.ts
           -> entrypoints/sdk/controlTypes.d.ts
           -> transport/processTransportTypes.d.ts
           -> transport/transport.d.ts
```

**0.2.49**: Single flat declaration file:
```
sdk.d.ts (all types in one file, ~2044 lines)
```

**Impact on claude-mem**: LOW. Both versions export `query`, `SDKUserMessage`, `SDKMessage`, `SDKResultMessage` from the top-level entry point. Claude-mem's imports (`import { query } from '...'` and `export type { SDKUserMessage } from '...'`) should resolve correctly in both versions.

### 3.2 Zod Peer Dependency (BREAKING)

**0.1.77**: `"zod": "^3.25.0 || ^4.0.0"`
**0.2.49**: `"zod": "^4.0.0"` (Zod 3 support dropped)

**Impact on claude-mem**: LOW. Claude-mem does not list `zod` as a direct dependency. The SDK uses Zod internally for schema validation (sandbox settings). However, if `zod-to-json-schema@^3.24.6` (which IS a dependency) depends on Zod 3, this could create a conflict. Need to verify.

### 3.3 PermissionMode Type Change (MINOR)

**0.1.77**: `'default' | 'acceptEdits' | 'bypassPermissions' | 'plan' | 'delegate' | 'dontAsk'`
**0.2.49**: `'default' | 'acceptEdits' | 'bypassPermissions' | 'plan' | 'dontAsk'`

The `'delegate'` mode was removed.

**Impact on claude-mem**: NONE. Claude-mem does not set `permissionMode`.

### 3.4 SDKHookResponseMessage Type Change (ADDITIVE)

**0.1.77**:
```typescript
type SDKHookResponseMessage = {
  type: 'system';
  subtype: 'hook_response';
  hook_name: string;
  hook_event: string;
  stdout: string;
  stderr: string;
  exit_code?: number;
  uuid: UUID;
  session_id: string;
};
```

**0.2.49** adds: `hook_id`, `output`, `outcome: 'success' | 'error' | 'cancelled'`

**Impact on claude-mem**: NONE. Claude-mem does not inspect hook response messages from the SDK stream.

### 3.5 SDKMessage Union Expansion (ADDITIVE)

**0.1.77** SDKMessage union:
```
SDKAssistantMessage | SDKUserMessage | SDKUserMessageReplay | SDKResultMessage |
SDKSystemMessage | SDKPartialAssistantMessage | SDKCompactBoundaryMessage |
SDKStatusMessage | SDKHookResponseMessage | SDKToolProgressMessage | SDKAuthStatusMessage
```

**0.2.49** adds:
```
SDKHookStartedMessage | SDKHookProgressMessage | SDKTaskNotificationMessage |
SDKTaskStartedMessage | SDKFilesPersistedEvent | SDKToolUseSummaryMessage |
SDKRateLimitEvent | SDKPromptSuggestionMessage
```

**Impact on claude-mem**: LOW. Claude-mem only checks for `message.type === 'assistant'` and `message.type === 'result'`. New message types will be silently ignored by the existing `for await` loop. However, this is a good opportunity to handle `SDKRateLimitEvent` for better error reporting.

### 3.6 SDKResultMessage Structure Change (POTENTIALLY BREAKING)

**0.1.77**: `SDKResultMessage` is a union of two inline objects.
**0.2.49**: `SDKResultMessage = SDKResultSuccess | SDKResultError` (named types) with a new `stop_reason: string | null` field on both variants.

**Impact on claude-mem**: LOW. Claude-mem only checks `message.type === 'result' && message.subtype === 'success'` and doesn't destructure further. The `stop_reason` field is additive. But this is a valuable new field to leverage (see Section 4.3).

### 3.7 SDKAssistantMessageError Expansion (ADDITIVE)

**0.1.77**: `'authentication_failed' | 'billing_error' | 'rate_limit' | 'invalid_request' | 'server_error' | 'unknown'`
**0.2.49** adds: `'max_output_tokens'`

**Impact on claude-mem**: NONE. Claude-mem does not inspect the `error` field on assistant messages.

### 3.8 ModelUsage Type Change (ADDITIVE)

**0.2.49** adds `maxOutputTokens: number` to `ModelUsage`.

**Impact on claude-mem**: NONE. Claude-mem accesses `message.message.usage` (the API-level usage), not the SDK-level `ModelUsage`.

### 3.9 PermissionResult.updatedInput Optionality Change (MINOR)

**0.1.77**: `updatedInput: Record<string, unknown>` (required in allow branch)
**0.2.49**: `updatedInput?: Record<string, unknown>` (optional in allow branch)

**Impact on claude-mem**: NONE. Claude-mem does not use `canUseTool` callback.

### 3.10 ApiKeySource Expansion (ADDITIVE)

**0.2.49** adds `'oauth'` to `ApiKeySource`.

**Impact on claude-mem**: NONE. Claude-mem does not inspect `apiKeySource`.

### 3.11 HookEvent Expansion (ADDITIVE)

**0.2.49** adds: `'Setup'`, `'TeammateIdle'`, `'TaskCompleted'`, `'ConfigChange'`

**Impact on claude-mem**: NONE. Claude-mem does not use SDK-level hooks (it uses its own Claude Code plugin hooks).

---

## 4. New Capabilities to Leverage

### 4.1 Query.close() (v0.2.15) -- HIGH VALUE

```typescript
interface Query {
  close(): void;
}
```

This method forcefully terminates the query, cleaning up all resources including pending requests, MCP transports, and the CLI subprocess. This is exactly what claude-mem needs for clean session shutdown.

**Current workaround**: `session.abortController.abort()` + manual subprocess verification via `ProcessRegistry.ensureProcessExit()` with SIGKILL escalation.

**Benefit**: Could simplify `SessionManager.deleteSession()` significantly, potentially making the ProcessRegistry's SIGKILL escalation unnecessary. The SDK would handle cleanup internally.

### 4.2 Options.sessionId (v0.2.33) -- HIGH VALUE

```typescript
type Options = {
  sessionId?: string; // Use a specific session ID instead of auto-generated
};
```

**Current pain**: Claude-mem must capture the `memorySessionId` from the first SDK response message, persist it to DB, then use it for `resume` on subsequent prompts. This is fragile and the source of multiple bugs (Issues #817, stale session IDs).

**Benefit**: By specifying a predictable `sessionId` upfront, claude-mem could eliminate the entire "capture memorySessionId from first response" flow. The session ID would be known before the query starts, simplifying the state machine.

**Caveat**: Need to verify that `sessionId` + `resume` work together correctly. The docs say `sessionId` cannot be used with `continue` or `resume` unless `forkSession` is also set. This may limit its applicability for claude-mem's multi-turn pattern.

### 4.3 stop_reason on SDKResultMessage (v0.2.31) -- MEDIUM VALUE

```typescript
type SDKResultSuccess = {
  stop_reason: string | null;
  // ...
};
```

**Benefit**: Claude-mem can use `stop_reason` to make better exit code decisions and improve logging. Currently, the result message processing is minimal (`// Usage telemetry is captured at SDK level`).

### 4.4 Options.debug and Options.debugFile (v0.2.30) -- MEDIUM VALUE

```typescript
type Options = {
  debug?: boolean;
  debugFile?: string;
};
```

**Benefit**: Could replace ad-hoc stderr debugging with structured SDK-level debug logs. Could be integrated with claude-mem's existing `logger` system for unified troubleshooting.

### 4.5 Memory Leak Fix (v0.2.45) -- HIGH VALUE

> "Improved memory usage for shell commands that produce large output -- RSS no longer grows unboundedly with command output size"

**Benefit**: Claude-mem runs the SDK as a long-lived worker service. Memory leaks from accumulated subprocess output would degrade performance over time. This fix directly addresses that risk.

### 4.6 V2 Session API Improvements -- LOW VALUE (for now)

The V2 API (`unstable_v2_createSession`, `unstable_v2_resumeSession`) remains unstable/alpha. However, `SDKSessionOptions` in 0.2.49 gained `allowedTools`, `disallowedTools`, `canUseTool`, `hooks`, and `permissionMode` -- making it more feature-complete.

**Assessment**: Not recommended for adoption yet since it's still marked `@alpha`. However, monitoring for stabilization is worthwhile since the V2 API's `await using session` pattern with `[Symbol.asyncDispose]` would provide automatic cleanup that would greatly benefit claude-mem's long-running worker.

### 4.7 New Hook Events -- LOW VALUE

New events like `Setup`, `TeammateIdle`, `TaskCompleted`, and `ConfigChange` are available. These are SDK-level hook callbacks, not Claude Code plugin hooks. Claude-mem uses its own plugin hook system, so these are not directly useful. However, if claude-mem ever wanted to pass-through some hook behavior to the SDK subprocess, these events could be relevant.

### 4.8 Enhanced MCP Server Management (v0.2.21) -- LOW VALUE

`reconnectMcpServer()`, `toggleMcpServer()`, enhanced `McpServerStatus` with `config`, `scope`, `tools`. Not directly relevant since claude-mem's observer agent doesn't use MCP tools, but useful knowledge for the ecosystem.

### 4.9 Options.agent (v0.2.49 area) -- LOW VALUE

```typescript
type Options = {
  agent?: string;
  agents?: Record<string, AgentDefinition>;
};
```

The new `agent` option allows specifying an agent name for the main thread. Combined with `agents` definitions, this could potentially be used to configure the observer agent's behavior more declaratively. Not a priority but worth noting.

### 4.10 Options.promptSuggestions (v0.2.47) -- NO VALUE

Prompt suggestions are irrelevant for claude-mem's observer agent use case.

### 4.11 Options.thinking and Options.effort (v0.2.49) -- LOW VALUE

```typescript
type Options = {
  thinking?: ThinkingConfig;
  effort?: 'low' | 'medium' | 'high' | 'max';
};
```

Could be used to set the observer agent to `effort: 'low'` for faster, cheaper observation processing. Worth experimenting with in a follow-up.

---

## 5. Risk Assessment

### 5.1 Compilation Risk: LOW

All SDK APIs used by claude-mem (`query`, `SDKUserMessage`, `Options`, `SpawnedProcess`, `SpawnOptions`) are present and structurally compatible in 0.2.49. The main risk is subtle type narrowing changes that might surface at compile time.

### 5.2 Runtime Risk: MEDIUM

- The SDK bundles its own Claude Code CLI (`cli.js`). Version 0.2.49 ships with Claude Code v2.1.49, while 0.1.77 ships with v2.0.78. The CLI behavior differences between v2.0.x and v2.1.x could affect subprocess behavior, output parsing, or session management.
- The `resume` option behavior may have changed subtly across 49 versions.
- The SpawnedProcess interface is identical between versions, so `ProcessRegistry.createPidCapturingSpawn` should work unchanged.

### 5.3 Dependency Risk: LOW-MEDIUM

- **Zod 4 peer dependency**: The 0.2.49 SDK requires `zod@^4.0.0`. Claude-mem has `zod-to-json-schema@^3.24.6` which may depend on Zod 3. This needs verification. If there's a conflict, `zod-to-json-schema` may need updating.
- **@anthropic-ai/sdk**: The SDK types reference `@anthropic-ai/sdk/resources` and `@anthropic-ai/sdk/resources/beta/messages/messages.mjs`. These are internal to the SDK bundle and should not require separate installation, but the types need to resolve correctly for TypeScript compilation.

### 5.4 Test Risk: HIGH -- Mitigated by Test Harness

There are no integration tests that exercise the actual `query()` function. The single test file (`sdk-agent-resume.test.ts`) only tests the resume parameter logic in isolation.

**Mitigation: `claude -p` Test Harness** (Phase 0)

A subprocess-based test harness using `claude -p` can validate the real SDK wire protocol without mocking:

```typescript
// tests/integration/sdk-harness.test.ts
import { spawn } from 'node:child_process';
import { describe, it, expect } from 'vitest';

describe('SDK subprocess harness', () => {
  it('spawns claude -p and receives valid JSON stream', async () => {
    const child = spawn('claude', ['-p', 'Say hello', '--max-turns', '1', '--output-format', 'stream-json'], {
      env: { ...process.env, DISABLE_MAGIC_CLAUDE_MEM: '1' },
    });
    const messages: unknown[] = [];
    for await (const chunk of child.stdout) {
      // Each line is a JSON message matching SDKMessage union
      for (const line of chunk.toString().split('\n').filter(Boolean)) {
        messages.push(JSON.parse(line));
      }
    }
    expect(messages.some(m => (m as any).type === 'assistant')).toBe(true);
    expect(messages.some(m => (m as any).type === 'result')).toBe(true);
  });

  it('validates process cleanup after abort', async () => {
    const child = spawn('claude', ['-p', 'Count to 100', '--max-turns', '1', '--output-format', 'stream-json']);
    // Kill after first message
    child.stdout.once('data', () => child.kill('SIGTERM'));
    const code = await new Promise(resolve => child.on('exit', resolve));
    // Verify no orphan processes remain
    // (child.pid should not appear in process table after exit)
    expect(code).not.toBeNull();
  });

  it('validates session resume round-trip', async () => {
    // Phase 1: Create session
    const create = spawn('claude', ['-p', 'Remember: apple', '--max-turns', '1', '--output-format', 'stream-json']);
    let sessionId: string | undefined;
    for await (const chunk of create.stdout) {
      for (const line of chunk.toString().split('\n').filter(Boolean)) {
        const msg = JSON.parse(line);
        if (msg.session_id) sessionId = msg.session_id;
      }
    }
    expect(sessionId).toBeDefined();

    // Phase 2: Resume session
    const resume = spawn('claude', ['-p', 'What did I ask you to remember?', '--resume', sessionId!, '--max-turns', '1', '--output-format', 'stream-json']);
    const messages: unknown[] = [];
    for await (const chunk of resume.stdout) {
      for (const line of chunk.toString().split('\n').filter(Boolean)) {
        messages.push(JSON.parse(line));
      }
    }
    expect(messages.some(m => (m as any).type === 'result')).toBe(true);
  });
});
```

**Harness advantages:**
- Tests the actual Claude Code CLI that the SDK bundles (not mocked)
- Validates subprocess spawn/IPC path end-to-end
- Can assert process cleanup (orphan detection, SIGTERM handling)
- Works as a pre/post upgrade regression gate
- `--max-turns 1` keeps tests fast and cheap
- `DISABLE_MAGIC_CLAUDE_MEM=1` prevents recursive plugin invocation

**Harness considerations:**
- Requires a real Claude API key (CI needs `ANTHROPIC_API_KEY` secret)
- Tests are inherently slow (~5-15s each) -- run separately from unit tests
- Use `vitest --project integration` or a separate test config

### 5.5 Rollback Risk: LOW

The dependency specifier can be trivially reverted in `package.json` since the change is contained to one package.

### 5.6 Known Upstream Issues (GitHub)

Research conducted 2026-02-20 across `anthropics/claude-agent-sdk-typescript` (118 open issues) and `anthropics/claude-agent-sdk-python` (273 open issues).

#### 5.6.1 Process Lifecycle -- Critical for claude-mem

| Issue | SDK | Severity | Description |
|-------|-----|----------|-------------|
| [TS #142](https://github.com/anthropics/claude-agent-sdk-typescript/issues/142) | TS | **HIGH** | Orphan process accumulation -- **explicitly mentions claude-mem**. 47 orphans consuming ~3GB observed. Proposes `PR_SET_PDEATHSIG` on Linux. |
| [TS #46](https://github.com/anthropics/claude-agent-sdk-typescript/issues/46) | TS | HIGH | `AbortController` kills **parent** Node.js process (SIGTERM propagation, Linux-only) |
| [TS #132](https://github.com/anthropics/claude-agent-sdk-typescript/issues/132) | TS | MEDIUM | Subagents don't stop when parent is stopped via `queryInstance.return()` |
| [PY #378](https://github.com/anthropics/claude-agent-sdk-python/issues/378) | PY | HIGH | `Query.close()` hangs at 100% CPU (missing timeout on task group cleanup) |
| [PY #573](https://github.com/anthropics/claude-agent-sdk-python/issues/573) | PY | HIGH | `CLAUDECODE=1` env var leaks into subprocess, blocking SDK use from plugins. Fix PR #594 submitted 2026-02-20. |

**Impact on upgrade**: TS #142 (orphans) and TS #46 (SIGTERM) are pre-existing issues that also affect 0.1.x. The upgrade does not introduce them but also does not fix them. Phase 2 (`Query.close()`) may help mitigate orphan cleanup, but the Python SDK's #378 shows `close()` itself can hang. **Defensive timeout wrapping around `close()` is recommended.**

#### 5.6.2 WSL2 Compatibility

| Issue | SDK | Description |
|-------|-----|-------------|
| [TS #20](https://github.com/anthropics/claude-agent-sdk-typescript/issues/20) | TS | Spawned child process exits code 1 before any IPC on WSL2. Open since Oct 2025. |
| [PY #208](https://github.com/anthropics/claude-agent-sdk-python/issues/208) | PY | Hangs during initialization -- fails to detect `claude.cmd` vs `claude` |
| [CC #19653](https://github.com/anthropics/claude-code/issues/19653) | CLI | Bash commands execute through Windows instead of WSL environment |
| [CC #18048](https://github.com/anthropics/claude-code/issues/18048) | CLI | Extreme memory and CPU usage on WSL2 |

**Impact on upgrade**: claude-mem currently uses `OpenAICompatAgent` (HTTP-based) as primary, avoiding these subprocess issues entirely. The SDK agent path would be affected. No regression expected from upgrade since these are pre-existing.

#### 5.6.3 TypeScript SDK Type/API Bugs

| Issue | Severity | Description |
|-------|----------|-------------|
| [TS #184](https://github.com/anthropics/claude-agent-sdk-typescript/issues/184) | MEDIUM | `SDKRateLimitEvent` type missing from `sdk.d.ts` in v0.2.45 |
| [TS #176](https://github.com/anthropics/claude-agent-sdk-typescript/issues/176) | HIGH | V2 Session API silently ignores `permissionMode`, `cwd`, `allowedTools` |
| [TS #172](https://github.com/anthropics/claude-agent-sdk-typescript/issues/172) | HIGH | `disallowedTools` not enforced for subagent children (security concern) |
| [TS #157](https://github.com/anthropics/claude-agent-sdk-typescript/issues/157) | MEDIUM | `ANTHROPIC_LOG=debug` corrupts JSON protocol (stdout vs stderr) |

**Impact on upgrade**: TS #184 affects our plan to handle `SDKRateLimitEvent` (Phase 4). TS #176 only affects the unstable V2 API (not recommended anyway). TS #172 is a security concern but claude-mem doesn't use subagents. TS #157 means we should avoid `debug: true` option until fixed -- use `debugFile` instead.

---

## 6. Migration Steps

### 6.1 Pre-Migration Verification

```bash
# Verify current SDK usage compiles cleanly
npm run build

# Run existing tests to establish baseline
npm test

# Check Zod dependency situation
npm ls zod
npm view zod-to-json-schema@3.24.6 peerDependencies
```

### 6.2 Core Dependency Update

```bash
# Update the dependency
npm install @anthropic-ai/claude-agent-sdk@^0.2.49

# If Zod conflict detected:
npm install zod@^4.0.0
# and verify zod-to-json-schema compatibility
```

### 6.3 Source Code Changes

#### 6.3.1 SDKAgent.ts (MINIMAL CHANGES)

No changes required for basic functionality. The `query()` call, `Options` fields, and response iteration all remain compatible.

**Optional enhancements**:
```typescript
// After the for-await loop completes:
// NEW: Use close() for clean shutdown instead of relying on abort
// (only if abort was used as cleanup mechanism, not as user-initiated cancel)

// NEW: Handle stop_reason in result messages
if (message.type === 'result') {
  if (message.subtype === 'success') {
    logger.info('SDK', 'Query completed', {
      stop_reason: message.stop_reason,  // NEW
      result: message.result?.substring(0, 100)
    });
  } else {
    logger.warn('SDK', 'Query ended with error', {
      subtype: message.subtype,
      stop_reason: message.stop_reason,  // NEW
      errors: message.errors
    });
  }
}
```

#### 6.3.2 worker-types.ts (NO CHANGES)

```typescript
export type { SDKUserMessage } from '@anthropic-ai/claude-agent-sdk';
```

This re-export remains valid. The `SDKUserMessage` type is structurally identical between versions.

#### 6.3.3 ProcessRegistry.ts (NO CHANGES)

The `SpawnedProcess` and `SpawnOptions` interfaces are identical between versions. The custom spawn function will continue to work.

#### 6.3.4 SessionManager.ts (FUTURE CHANGE -- Phase 2)

If `sessionId` option proves compatible with claude-mem's resume pattern, the session initialization could be simplified to pre-generate the memorySessionId:

```typescript
// Phase 2: Use sessionId option to eliminate post-hoc capture
const queryResult = query({
  prompt: messageGenerator,
  options: {
    ...existingOptions,
    sessionId: preGeneratedSessionId, // NEW: deterministic session ID
  }
});
```

This would eliminate the `memorySessionId` capture logic in `SDKAgent.ts` (lines 139-160) and simplify the resume decision logic.

#### 6.3.5 Scripts (MINIMAL CHANGES)

`scripts/translate-readme/index.ts` and `scripts/bug-report/index.ts` import `query`, `SDKMessage`, and `SDKResultMessage`. These remain compatible. If accessing `result` on `SDKResultMessage`, the code should handle the new `stop_reason` field gracefully (it's additive, so no breaking change).

### 6.4 Post-Migration Verification

```bash
# Compile check
npm run build

# Run all tests
npm test

# Run specific SDK tests
npm run test -- tests/sdk-agent-resume.test.ts

# Manual smoke test: start worker and verify observation processing
npm run build-and-sync
# In another terminal: start a Claude Code session and verify observations are captured
```

---

## 7. Implementation Plan

### Phase 0: SDK Test Harness (Pre-upgrade regression gate)

1. Create `tests/integration/sdk-harness.test.ts` with `claude -p` subprocess tests
2. Add vitest project config to separate integration tests from unit tests
3. Test cases:
   - Spawn `claude -p` and validate JSON stream message types
   - Validate process cleanup after SIGTERM (no orphans)
   - Validate session create/resume round-trip
   - Validate `--max-turns` respects limit
4. Run harness against **current** SDK (0.1.77) to establish baseline
5. After Phase 1 upgrade, re-run harness to catch regressions
6. Add `npm run test:sdk` script for targeted execution

**Note**: Requires `ANTHROPIC_API_KEY` in environment. Tests are slow (~5-15s each) and should not run in the default `npm test` suite.

### Phase 1: Core Upgrade

1. Update `package.json`: change `"@anthropic-ai/claude-agent-sdk": "^0.1.76"` to `"^0.2.49"`
2. Run `npm install` and resolve any dependency conflicts (Zod 4 peer dependency)
3. Run `npm run build` and fix any compilation errors
4. Run `npm test` and fix any test failures
5. Run `npm run test:sdk` harness against upgraded SDK
6. Manual smoke test with `npm run build-and-sync`
7. Verify observation processing works end-to-end

### Phase 2: Leverage Query.close() (Estimated: 1-2 hours)

1. Store the `Query` object reference on the `ActiveSession`
2. In `SessionManager.deleteSession()`, call `queryResult.close()` before or instead of `abortController.abort()`
3. Evaluate whether `ProcessRegistry.ensureProcessExit()` SIGKILL escalation is still needed
4. Update `shutdownAll()` to use `close()` for cleaner shutdown

### Phase 3: Leverage sessionId Option (Estimated: 2-3 hours, requires research)

1. Research whether `sessionId` + `resume` work together (the docs suggest mutual exclusivity)
2. If compatible: pre-generate session IDs in `SessionManager.initializeSession()`
3. Remove the memorySessionId capture logic from `SDKAgent.ts` response loop
4. Simplify the resume decision logic
5. Update resume tests

### Phase 4: Enhanced Telemetry (Estimated: 1 hour)

1. Handle `stop_reason` in result messages for better logging
2. Optionally handle `SDKRateLimitEvent` for user-facing rate limit reporting
3. Consider adding `debug: true` option behind a settings flag for troubleshooting

### Phase 5: Thinking/Effort Configuration (Estimated: 30 minutes)

1. Add `MAGIC_CLAUDE_MEM_THINKING` setting to control thinking behavior
2. Consider defaulting to `effort: 'low'` or `thinking: { type: 'disabled' }` for the observer agent to reduce costs
3. Make configurable via settings.json

---

## 8. Scope Summary

| Component | Change Type | Phase | Effort | Risk |
|-----------|-----------|-------|--------|------|
| `tests/integration/sdk-harness.test.ts` | New test harness | 0 | Medium | Low |
| `package.json` | Dependency bump | 1 | Trivial | Low |
| Zod compatibility | Dependency resolution | 1 | Low | Low-Medium |
| `SDKAgent.ts` | No required changes (optional enhancements) | 1/4 | Low | Low |
| `worker-types.ts` | No changes | 1 | None | None |
| `ProcessRegistry.ts` | No changes | 1 | None | None |
| `SessionManager.ts` | `Query.close()` + optional `sessionId` | 2-3 | Medium | Medium |
| `scripts/*.ts` | No changes | 1 | None | None |
| Test files | Update if needed | 0-1 | Low | Low |

**Total estimated effort**: Phase 0 (harness) + Phase 1 (core upgrade) is the minimum viable scope. Phases 2-5 are incremental improvements.

---

## 9. Decision

**Recommendation**: Start with Phase 0 (test harness) to establish a regression baseline against the current 0.1.77 SDK, then proceed with Phase 1 (core upgrade). The current 0.1.x SDK is end-of-life and will not receive further updates. The upgrade is low-risk for the core functionality and provides immediate benefits (memory leak fix, CLI parity with Claude Code v2.1.49, access to newer models).

**Upstream risk note**: Several open GitHub issues affect process lifecycle (TS #142 orphans, TS #46 SIGTERM propagation). These are pre-existing in 0.1.x and not introduced by the upgrade. Phase 2's `Query.close()` adoption should include a defensive timeout wrapper given PY #378 (close() can hang). Avoid `debug: true` option (TS #157 corrupts protocol) -- use `debugFile` instead.

Phases 2-5 can be implemented incrementally after the core upgrade is validated in production.

---

## Appendix A: Full Changelog (0.1.77 to 0.2.49)

### 0.2.49
- Model info includes `supportsEffort`, `supportedEffortLevels`, `supportsAdaptiveThinking`
- Permission suggestions populated for safety check responses
- `ConfigChange` hook event added

### 0.2.47
- `promptSuggestion()` method on Query
- `tool_use_id` on `task_notification` events

### 0.2.45
- Claude Sonnet 4.6 support
- `task_started` system message
- Fixed `Session.stream()` premature return with background subagents
- **Memory usage fix for large shell command output** (RSS no longer grows unboundedly)

### 0.2.33
- `TeammateIdle` and `TaskCompleted` hook events
- **`sessionId` option** for custom conversation IDs

### 0.2.31
- **`stop_reason` field** on `SDKResultSuccess` and `SDKResultError`

### 0.2.30
- **`debug` and `debugFile` options** for programmatic debug logging
- Fixed "(no content)" placeholder messages in SDK output

### 0.2.27
- `listSessions` function for session discovery
- `annotations` support for MCP tool definitions
- Fixed `mcpServerStatus()` for SDK and dynamic servers

### 0.2.21
- `config`, `scope`, `tools` on `McpServerStatus`
- `reconnectMcpServer()` and `toggleMcpServer()` methods
- `disabled` status for MCP servers
- Fixed PermissionRequest hooks in SDK mode

### 0.2.20
- CLAUDE.md loading from `additionalDirectories`
- `CLAUDE_CODE_ENABLE_TASKS` env var

### 0.2.15
- Notification hook support
- **`close()` method on Query** for forceful termination

### 0.2.10
- `skills` and `maxTurns` on agent definitions

### 0.2.6
- `claudeCodeVersion` field in package.json

### 0.2.0
- `error` field on `McpServerStatus`
- Parity with Claude Code v2.1.0

## Appendix B: Type Diff Summary

| Type | 0.1.77 | 0.2.49 | Breaking? |
|------|--------|--------|-----------|
| `SDKUserMessage` | Same fields | Same fields | No |
| `SDKResultMessage` | Inline union | `SDKResultSuccess \| SDKResultError` + `stop_reason` | No (additive) |
| `SDKMessage` | 11 variants | 19 variants | No (additive) |
| `Options` | Core fields present | Same + `sessionId`, `debug`, `debugFile`, `thinking`, `effort`, `agent`, `promptSuggestions` | No (additive) |
| `Query` | `interrupt()`, etc. | Same + `close()`, `stopTask()`, `reconnectMcpServer()`, etc. | No (additive) |
| `SpawnedProcess` | Interface | Identical | No |
| `SpawnOptions` | Interface | Identical | No |
| `PermissionMode` | Includes `'delegate'` | Excludes `'delegate'` | Only if using `'delegate'` (we don't) |
| `PermissionResult.updatedInput` | Required | Optional | Only if relying on presence (we don't) |
| `HookEvent` | 12 events | 16 events | No (additive) |
| `ApiKeySource` | 4 values | 5 values (+ `'oauth'`) | No (additive) |
| Package structure | Multi-file entrypoints | Single `sdk.d.ts` | Only for deep imports (we don't) |
| Zod peer | `^3.25.0 \|\| ^4.0.0` | `^4.0.0` | Only if using Zod 3 |
