---
title: "Architecture Overview"
description: "System components and data flow in Magic-Claude-Mem"
---

# Architecture Overview

## System Components

Magic-Claude-Mem operates as a Claude Code plugin with six core components:

1. **Plugin Hooks** - Capture lifecycle events (6 hook files)
2. **Smart Install** - Cached dependency checker (pre-hook script, runs before context-hook)
3. **Worker Service** - Process observations via Claude Agent SDK + HTTP API (10 search endpoints)
4. **Database Layer** - Store sessions and observations (SQLite + FTS5 + ChromaDB)
5. **MCP Search Tools** - 4 MCP tools with 3-layer progressive disclosure workflow
6. **Viewer UI** - Web-based memory visualization with search, filtering, activity timeline, and theme support

## Technology Stack

| Layer                  | Technology                                |
|------------------------|-------------------------------------------|
| **Language**           | TypeScript (ES2022, ESNext modules)       |
| **Runtime**            | Node.js 18+                               |
| **Database**           | SQLite 3 with better-sqlite3 driver       |
| **Vector Store**       | ChromaDB (optional, for semantic search)  |
| **HTTP Server**        | Express.js 4.18                           |
| **Real-time**          | Server-Sent Events (SSE)                  |
| **UI Framework**       | React + TypeScript                        |
| **AI SDK**             | @anthropic-ai/claude-agent-sdk 0.2.50     |
| **Build Tool**         | esbuild (bundles TypeScript)              |
| **Process Manager**    | Node.js                                   |
| **Testing**            | Vitest                                    |

## Data Flow

### Memory Pipeline
```
Hook (stdin) → Database → Worker Service → SDK Processor → Database → Next Session Hook
```

1. **Input**: Claude Code sends tool execution data via stdin to hooks
2. **Storage**: Hooks write observations to SQLite database
3. **Processing**: Worker service reads observations, processes via SDK
4. **Output**: Processed summaries written back to database
5. **Retrieval**: Next session's context hook reads summaries from database

### Search Pipeline
```
User Query → MCP Tools → HTTP API → SearchOrchestrator → Strategy Selection → Ranked Results → Claude
```

1. **User Query**: User asks naturally: "What bugs did we fix?"
2. **MCP Tools Invoked**: Claude recognizes intent and invokes MCP search tools
3. **HTTP API**: MCP tools call HTTP endpoint (e.g., `/api/search/observations`)
4. **SearchOrchestrator**: Selects the optimal search strategy based on query and available backends:
   - **BM25SearchStrategy** - FTS5 full-text search with BM25 ranking (default)
   - **ChromaSearchStrategy** - Vector semantic search via ChromaDB (when available)
   - **HybridBlendingStrategy** - Combines BM25 + Chroma results using Reciprocal Rank Fusion (RRF) scoring with top-rank bonus
   - **SQLiteSearchStrategy** - Direct SQLite queries for structured filters
   - **HybridSearchStrategy** - Legacy FTS5 + Chroma blending
5. **Scoring & Ranking**: RRF scoring merges results from multiple strategies, with configurable blending and deduplication
6. **Format**: ResultFormatter shapes output for MCP consumption
7. **Return**: Claude presents formatted results to user

Uses 3-layer progressive disclosure: search → timeline → get_observations

## Session Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│ 0. Smart Install Pre-Hook Fires                                 │
│    Checks dependencies (cached), only runs on version changes   │
│    Not a lifecycle hook - runs before context-hook starts       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 1. Session Starts → Context Hook Fires                          │
│    Starts Node.js worker if needed, injects context from previous│
│    sessions (configurable observation count)                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 2. User Types Prompt → UserPromptSubmit Hook Fires              │
│    Creates session in database, saves raw user prompt for FTS5  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 3. Claude Uses Tools → PostToolUse Hook Fires (100+ times)      │
│    Captures tool executions, sends to worker for AI compression │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 4. Worker Processes → Claude Agent SDK Analyzes                 │
│    Extracts structured learnings via iterative AI processing    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 5. Claude Stops → Summary Hook Fires                            │
│    Generates final summary with request, completions, learnings │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 6. Summary Stored → Session Marked Complete                       │
│    Status changes from 'active' to 'completed'. If new prompt    │
│    arrives in same session, status resets to 'active'            │
└─────────────────────────────────────────────────────────────────┘

              ── Alternative Path: UI-Initiated Close ──

┌─────────────────────────────────────────────────────────────────┐
│ 6a. User Closes Session via Viewer UI                             │
│     ActiveSessionRoutes receives close request, triggers          │
│     SummaryQueueService → generates summary → marks complete     │
│     Same summary quality as hook-driven path                     │
└─────────────────────────────────────────────────────────────────┘
```

<Note>
Sessions can be closed through two paths: the normal hook lifecycle (steps 5-6 above) or
manually via the Viewer UI. Both paths produce identical summaries through the
SummaryQueueService, ensuring no data loss regardless of how a session ends. This is
particularly useful for closing stale sessions that were interrupted before the
SessionEnd hook could fire.
</Note>

## Directory Structure

```
magic-claude-mem/
├── src/
│   ├── hooks/                  # Hook implementations (6 hooks)
│   │   ├── context-hook.ts     # SessionStart
│   │   ├── user-message-hook.ts # UserMessage (for debugging)
│   │   ├── new-hook.ts         # UserPromptSubmit
│   │   ├── save-hook.ts        # PostToolUse
│   │   ├── summary-hook.ts     # Stop
│   │   ├── cleanup-hook.ts     # SessionEnd
│   │   └── hook-response.ts    # Hook response utilities
│   │
│   ├── sdk/                    # Claude Agent SDK integration
│   │   ├── prompts.ts          # XML prompt builders
│   │   ├── parser.ts           # XML response parser
│   │   └── worker.ts           # Main SDK agent loop
│   │
│   ├── services/
│   │   ├── worker-service.ts   # Express HTTP + SSE service
│   │   ├── sqlite/             # Database layer
│   │   │   ├── SessionStore.ts # CRUD operations
│   │   │   ├── SessionSearch.ts # FTS5 search service
│   │   │   ├── migrations.ts
│   │   │   └── types.ts
│   │   └── worker/             # Worker subsystems
│   │       ├── search/         # Search orchestration (v9.5+)
│   │       │   ├── SearchOrchestrator.ts   # Strategy selection + RRF scoring
│   │       │   ├── ResultFormatter.ts      # Output formatting
│   │       │   ├── TimelineBuilder.ts      # Timeline construction
│   │       │   ├── strategies/             # Pluggable search strategies
│   │       │   │   ├── SearchStrategy.ts   # Interface + BaseSearchStrategy
│   │       │   │   ├── BM25SearchStrategy.ts
│   │       │   │   ├── ChromaSearchStrategy.ts
│   │       │   │   ├── HybridBlendingStrategy.ts  # RRF fusion
│   │       │   │   ├── HybridSearchStrategy.ts     # Legacy blending
│   │       │   │   ├── SQLiteSearchStrategy.ts
│   │       │   │   └── scoring.ts          # RRF, blending, normalization
│   │       │   ├── filters/                # Query filters
│   │       │   └── types.ts
│   │       ├── session/        # Session lifecycle (v9.8+)
│   │       │   ├── SummaryQueueService.ts      # Queue-based summary generation
│   │       │   └── SessionCompletionHandler.ts # SDK abort + completion flow
│   │       ├── http/routes/    # HTTP route handlers (8 route files)
│   │       │   ├── ActiveSessionRoutes.ts  # Stale session management
│   │       │   ├── ProjectRoutes.ts        # Project rename/merge/delete
│   │       │   └── ...                     # Search, Session, Data, etc.
│   │       ├── SearchManager.ts    # Delegates to SearchOrchestrator
│   │       ├── SessionManager.ts   # Session lifecycle coordination
│   │       └── SSEBroadcaster.ts   # Real-time event broadcasting
│   │
│   ├── ui/                     # Viewer UI
│   │   └── viewer/             # React + TypeScript web interface
│   │       ├── components/     # UI components
│   │       ├── hooks/          # React hooks
│   │       ├── utils/          # Utilities
│   │       └── assets/         # Fonts, logos
│   │
│   ├── shared/                 # Shared utilities
│   │   ├── config.ts
│   │   ├── paths.ts
│   │   └── storage.ts
│   │
│   └── utils/
│       ├── logger.ts
│       ├── platform.ts
│       └── port-allocator.ts
│
├── scripts/                    # Build and utility scripts
│   └── smart-install.js        # Cached dependency checker (pre-hook)
│
├── plugin/                     # Plugin distribution
│   ├── .claude-plugin/
│   │   └── plugin.json
│   ├── hooks/
│   │   └── hooks.json
│   ├── scripts/                # Built executables
│   │   ├── context-hook.js
│   │   ├── user-message-hook.js
│   │   ├── new-hook.js
│   │   ├── save-hook.js
│   │   ├── summary-hook.js
│   │   ├── cleanup-hook.js
│   │   └── worker-service.cjs  # Background worker + HTTP API
│   │
│   ├── skills/                 # Agent skills (v5.4.0+)
│   │   ├── mem-search/         # Search skill with progressive disclosure (v5.5.0)
│   │   │   ├── SKILL.md        # Skill frontmatter (~250 tokens)
│   │   │   ├── operations/     # 12 detailed operation docs
│   │   │   └── principles/     # 2 principle guides
│   │   ├── troubleshoot/       # Troubleshooting skill
│   │   │   ├── SKILL.md
│   │   │   └── operations/     # 6 operation docs
│   │   └── version-bump/       # Version management skill (deprecated)
│   │
│   └── ui/                     # Built viewer UI
│       └── viewer.html         # Self-contained bundle
│
├── tests/                      # Test suite
├── docs/                       # Documentation
└── ecosystem.config.cjs        # Process configuration (deprecated)
```

## Component Details

### 1. Plugin Hooks (6 Hooks)
- **context-hook.js** - SessionStart: Starts Node.js worker, injects context
- **user-message-hook.js** - UserMessage: Debugging hook
- **new-hook.js** - UserPromptSubmit: Creates session, saves prompt
- **save-hook.js** - PostToolUse: Captures tool executions
- **summary-hook.js** - Stop: Generates session summary
- **cleanup-hook.js** - SessionEnd: Marks session complete

**Note**: smart-install.js is a pre-hook dependency checker (not a lifecycle hook). It's called before context-hook via command chaining in hooks.json and only runs when dependencies need updating.

See [Plugin Hooks](/architecture/hooks) for detailed hook documentation.

### 2. Worker Service
Express.js HTTP server on port 37777 (configurable) with:
- 10 search HTTP API endpoints (v5.4.0+)
- 8 viewer UI HTTP/SSE endpoints
- Active session management endpoints (list, close, close-stale)
- Project management endpoints (rename, merge, delete, counts)
- Async observation processing via Claude Agent SDK 0.2.50
- Real-time updates via Server-Sent Events
- Auto-managed by Node.js

See [Worker Service](/architecture/worker-service) for HTTP API and endpoints.

### 2a. Search Orchestration (v9.7+)

The search subsystem uses a strategy pattern coordinated by `SearchOrchestrator`:

```
SearchManager → SearchOrchestrator → [Strategy Selection] → Ranked Results
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
              BM25Strategy        ChromaStrategy      HybridBlendingStrategy
             (FTS5 default)      (vector search)        (RRF fusion)
```

- **SearchOrchestrator** - Central coordinator that selects strategies based on query type and backend availability, with automatic fallback
- **BM25SearchStrategy** - FTS5 full-text search with BM25 ranking (primary strategy)
- **ChromaSearchStrategy** - Vector semantic search via ChromaDB embeddings
- **HybridBlendingStrategy** - Merges BM25 + Chroma results using Reciprocal Rank Fusion (RRF) scoring with top-rank bonus and deduplication
- **scoring.ts** - Shared scoring functions: `rrfScore`, `topRankBonus`, `blendScores`, `normalizeMinMax`

### 2b. Session Lifecycle Services (v9.8+)

Two new services support closing sessions outside the normal hook lifecycle:

- **SummaryQueueService** - Queues summary generation for sessions closed via the Viewer UI. Ensures summaries are generated asynchronously without blocking the HTTP response.
- **SessionCompletionHandler** - Handles the completion flow: aborts any running SDK agent for the session, triggers SSE broadcast, and marks the session as completed in the database.

See [Worker Service](/architecture/worker-service) for HTTP API and endpoints.

### 3. Database Layer
SQLite3 with better-sqlite3 driver featuring:
- FTS5 virtual tables with BM25 ranking for full-text search
- SessionStore for CRUD operations (including active session tracking)
- SessionSearch for FTS5 queries
- Location: `~/.magic-claude-mem/magic-claude-mem.db`

See [Database Architecture](/architecture/database) for schema and FTS5 search.

### 4. mem-search Skill (v5.4.0+)
Skill-based search with progressive disclosure providing 10 search operations:
- Search observations, sessions, prompts (full-text FTS5)
- Filter by type, concept, file
- Get recent context, timeline, timeline by query
- API help documentation

**Token Savings**: ~2,250 tokens per session vs MCP approach
- Skill frontmatter: ~250 tokens (loaded at session start)
- Full instructions: ~2,500 tokens (loaded on-demand when invoked)
- HTTP API endpoints instead of MCP tools

**Skill Enhancement (v5.5.0)**: Renamed from "search" to "mem-search" for better scope differentiation. Effectiveness increased from 67% to 100% with enhanced triggers and comprehensive documentation.

See [Search Architecture](/architecture/search-architecture) for technical details and examples.

### 5. Viewer UI
React + TypeScript web interface at http://localhost:37777 featuring:
- Real-time memory stream via Server-Sent Events
- Search bar with debounced text search and result count
- Filter bar with observation type, concept, item kind, and date range chips
- Activity bar: 90-day density timeline with click-to-select and drag-to-range
- Token analytics dashboard showing compression stats and token usage
- Active sessions badge with UI-driven session close (triggers summary generation)
- Project management: rename, merge, and delete projects via ProjectActionDialog
- Infinite scroll pagination with automatic deduplication
- Project filtering and settings persistence
- Theme toggle (light/dark/system with smart skip)
- Self-contained HTML bundle (viewer.html)

Built with esbuild into a single file deployment. See [Viewer UI Guide](/usage/viewer) for usage details.
