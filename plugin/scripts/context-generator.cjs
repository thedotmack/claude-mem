"use strict";var Mt=Object.create;var L=Object.defineProperty;var bt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var Tt=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty;var Pt=(n,e)=>{for(var t in e)L(n,t,{get:e[t],enumerable:!0})},me=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Et(e))!_t.call(n,s)&&s!==t&&L(n,s,{get:()=>e[s],enumerable:!(r=bt(e,s))||r.enumerable});return n};var P=(n,e,t)=>(t=n!=null?Mt(Tt(n)):{},me(e||!n||!n.__esModule?L(t,"default",{value:n,enumerable:!0}):t,n)),wt=n=>me(L({},"__esModule",{value:!0}),n);var Ht={};Pt(Ht,{generateContext:()=>ce});module.exports=wt(Ht);var ht=P(require("path"),1),St=require("os"),yt=require("fs");var M=require("fs"),w=require("path"),ue=require("os"),K=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(K||{}),le=(0,w.join)((0,ue.homedir)(),".claude-mem"),G=class{level=null;useColor;logFilePath=null;logFileInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}ensureLogFileInitialized(){if(!this.logFileInitialized){this.logFileInitialized=!0;try{let e=(0,w.join)(le,"logs");(0,M.existsSync)(e)||(0,M.mkdirSync)(e,{recursive:!0});let t=new Date().toISOString().split("T")[0];this.logFilePath=(0,w.join)(e,`claude-mem-${t}.log`)}catch(e){console.error("[LOGGER] Failed to initialize log file:",e),this.logFilePath=null}}}getLevel(){if(this.level===null)try{let e=(0,w.join)(le,"settings.json");if((0,M.existsSync)(e)){let t=(0,M.readFileSync)(e,"utf-8"),s=(JSON.parse(t).CLAUDE_MEM_LOG_LEVEL||"INFO").toUpperCase();this.level=K[s]??1}else this.level=1}catch{this.level=1}return this.level}correlationId(e,t){return`obs-${e}-${t}`}sessionId(e){return`session-${e}`}formatData(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="object"){if(e instanceof Error)return this.getLevel()===0?`${e.message}
${e.stack}`:e.message;if(Array.isArray(e))return`[${e.length} items]`;let t=Object.keys(e);return t.length===0?"{}":t.length<=3?JSON.stringify(e):`{${t.length} keys: ${t.slice(0,3).join(", ")}...}`}return String(e)}formatTool(e,t){if(!t)return e;let r=t;if(typeof t=="string")try{r=JSON.parse(t)}catch{r=t}if(e==="Bash"&&r.command)return`${e}(${r.command})`;if(r.file_path)return`${e}(${r.file_path})`;if(r.notebook_path)return`${e}(${r.notebook_path})`;if(e==="Glob"&&r.pattern)return`${e}(${r.pattern})`;if(e==="Grep"&&r.pattern)return`${e}(${r.pattern})`;if(r.url)return`${e}(${r.url})`;if(r.query)return`${e}(${r.query})`;if(e==="Task"){if(r.subagent_type)return`${e}(${r.subagent_type})`;if(r.description)return`${e}(${r.description})`}return e==="Skill"&&r.skill?`${e}(${r.skill})`:e==="LSP"&&r.operation?`${e}(${r.operation})`:e}formatTimestamp(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),m=String(e.getMilliseconds()).padStart(3,"0");return`${t}-${r}-${s} ${o}:${i}:${a}.${m}`}log(e,t,r,s,o){if(e<this.getLevel())return;this.ensureLogFileInitialized();let i=this.formatTimestamp(new Date),a=K[e].padEnd(5),m=t.padEnd(6),u="";s?.correlationId?u=`[${s.correlationId}] `:s?.sessionId&&(u=`[session-${s.sessionId}] `);let f="";o!=null&&(o instanceof Error?f=this.getLevel()===0?`
${o.message}
${o.stack}`:` ${o.message}`:this.getLevel()===0&&typeof o=="object"?f=`
`+JSON.stringify(o,null,2):f=" "+this.formatData(o));let g="";if(s){let{sessionId:p,memorySessionId:E,correlationId:_,...k}=s;Object.keys(k).length>0&&(g=` {${Object.entries(k).map(([vt,Ct])=>`${vt}=${Ct}`).join(", ")}}`)}let d=`[${i}] [${a}] [${m}] ${u}${r}${g}${f}`;if(this.logFilePath)try{(0,M.appendFileSync)(this.logFilePath,d+`
`,"utf8")}catch(p){process.stderr.write(`[LOGGER] Failed to write to log file: ${p}
`)}else process.stderr.write(d+`
`)}debug(e,t,r,s){this.log(0,e,t,r,s)}info(e,t,r,s){this.log(1,e,t,r,s)}warn(e,t,r,s){this.log(2,e,t,r,s)}error(e,t,r,s){this.log(3,e,t,r,s)}dataIn(e,t,r,s){this.info(e,`\u2192 ${t}`,r,s)}dataOut(e,t,r,s){this.info(e,`\u2190 ${t}`,r,s)}success(e,t,r,s){this.info(e,`\u2713 ${t}`,r,s)}failure(e,t,r,s){this.error(e,`\u2717 ${t}`,r,s)}timing(e,t,r,s){this.info(e,`\u23F1 ${t}`,s,{duration:`${r}ms`})}happyPathError(e,t,r,s,o=""){let u=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),f=u?`${u[1].split("/").pop()}:${u[2]}`:"unknown",g={...r,location:f};return this.warn(e,`[HAPPY-PATH] ${t}`,g,s),o}},l=new G;var Y="https://api.memu.so",Ot="v3",X=class{config;baseUrl;constructor(e){this.config=e,this.baseUrl=`${e.apiUrl||Y}/api/${Ot}`}get namespace(){return this.config.namespace}async request(e,t,r){let s=`${this.baseUrl}${t}`,o={"Content-Type":"application/json"};this.config.apiKey&&(o.Authorization=`Bearer ${this.config.apiKey}`),this.config.namespace&&(o["X-Memu-Namespace"]=this.config.namespace);try{let i=await fetch(s,{method:e,headers:o,body:r?JSON.stringify(r):void 0});if(!i.ok){let a=await i.text();throw new Error(`memU API error (${i.status}): ${a}`)}return await i.json()}catch(i){throw l.error("MEMU",`API request failed: ${e} ${t}`,{},i),i}}async memorize(e){return l.info("MEMU","Starting memorize task",{modality:e.modality,hasContent:!!e.content}),this.request("POST","/memory/memorize",{content:e.content,modality:e.modality,namespace:e.namespace||this.config.namespace})}async getMemorizeStatus(e){return this.request("GET",`/memory/memorize/status/${e}`)}async waitForMemorize(e,t=6e4,r=1e3){let s=Date.now();for(;Date.now()-s<t;){let o=await this.getMemorizeStatus(e);if(o.status==="completed"&&o.result)return o.result;if(o.status==="failed")throw new Error(`Memorize task failed: ${o.error||"Unknown error"}`);await new Promise(i=>setTimeout(i,r))}throw new Error(`Memorize task timed out after ${t}ms`)}async retrieve(e){return l.debug("MEMU","Retrieving memories",{queryCount:e.queries.length,method:e.method||"rag",limit:e.limit}),this.request("POST","/memory/retrieve",{queries:e.queries,method:e.method||"rag",limit:e.limit,where:e.where?{namespace:e.where.namespace||this.config.namespace,category_id:e.where.categoryId,memory_types:e.where.memoryTypes,tags:e.where.tags,date_from:e.where.dateFrom,date_to:e.where.dateTo}:{namespace:this.config.namespace}})}async listCategories(e){return this.request("POST","/memory/categories",{namespace:e||this.config.namespace})}async createCategory(e){return this.request("POST","/memory/categories/create",{name:e.name,description:e.description,namespace:this.config.namespace})}async createItem(e){return l.debug("MEMU","Creating memory item",{type:e.memoryType,hasCategory:!!e.categoryId,tagCount:e.tags?.length||0}),this.request("POST","/memory/items",{memory_type:e.memoryType,content:e.content,category_id:e.categoryId,tags:e.tags,metadata:e.metadata,namespace:this.config.namespace})}async getItem(e){return this.request("GET",`/memory/items/${e}`)}async deleteItem(e){await this.request("DELETE",`/memory/items/${e}`)}async healthCheck(){try{return(await fetch(`${this.config.apiUrl||Y}/health`)).ok}catch{return!1}}};function de(n){let e=n?.apiKey||process.env.CLAUDE_MEMU_API_KEY||"",t=n?.apiUrl||process.env.CLAUDE_MEMU_API_URL||Y,r=n?.namespace||process.env.CLAUDE_MEMU_NAMESPACE||"default";return new X({apiKey:e,apiUrl:t,namespace:r})}var R=class{client;ready=!1;sessions=new Map;sessionsByContentId=new Map;nextSessionId=1;projectCategories=new Map;constructor(e){this.client=de(e)}async initialize(){try{await this.client.healthCheck()?l.info("MEMU","MemuStore initialized",{namespace:this.client.namespace}):l.warn("MEMU","memU API not reachable, will retry on operations"),this.ready=!0}catch(e){l.error("MEMU","Failed to initialize MemuStore",{},e),this.ready=!0}}async close(){this.ready=!1,this.sessions.clear(),this.sessionsByContentId.clear(),this.projectCategories.clear(),l.info("MEMU","MemuStore closed")}isReady(){return this.ready}async createSession(e,t,r){let s=this.sessionsByContentId.get(e);if(s!==void 0)return this.sessions.get(s);let o=new Date,i={id:this.nextSessionId++,contentSessionId:e,memorySessionId:null,project:t,userPrompt:r,promptCounter:0,status:"active",createdAt:o.toISOString(),createdAtEpoch:o.getTime()};return this.sessions.set(i.id,i),this.sessionsByContentId.set(e,i.id),await this.ensureProjectCategory(t),l.info("MEMU","Session created",{sessionId:i.id,project:t}),i}getSession(e){return this.sessions.get(e)||null}getSessionByContentId(e){let t=this.sessionsByContentId.get(e);return t!==void 0&&this.sessions.get(t)||null}updateMemorySessionId(e,t){let r=this.sessions.get(e);r&&(r.memorySessionId=t)}incrementPromptCounter(e){let t=this.sessions.get(e);return t?(t.promptCounter++,t.promptCounter):0}async storeObservation(e,t,r){let s=await this.ensureProjectCategory(t),o=this.buildObservationContent(r);try{let i=await this.client.createItem({memoryType:r.type,content:o,categoryId:s,tags:[...r.concepts,`session:${e}`,`project:${t}`,`type:${r.type}`],metadata:{title:r.title,subtitle:r.subtitle,facts:r.facts,narrative:r.narrative,filesRead:r.filesRead,filesModified:r.filesModified,promptNumber:r.promptNumber,project:t,memorySessionId:e}});return l.info("MEMU","Observation stored",{itemId:i.id,type:r.type,project:t}),this.itemToObservation(i,e,t)}catch(i){throw l.error("MEMU","Failed to store observation",{project:t},i),i}}async getObservation(e){try{let t=await this.client.getItem(e),r=t.metadata||{};return this.itemToObservation(t,String(r.memorySessionId||""),String(r.project||""))}catch{return null}}async getRecentObservations(e,t=20){try{return(await this.client.retrieve({queries:[{role:"system",content:`project:${e}`}],method:"rag",limit:t,where:{namespace:this.client.namespace,tags:[`project:${e}`]}})).items.filter(s=>!s.metadata?.isSummary).map(s=>this.retrievedToObservation(s))}catch(r){return l.error("MEMU","Failed to get recent observations",{project:e},r),[]}}async storeSummary(e,t,r){let s=await this.ensureProjectCategory(t),o=this.buildSummaryContent(r);try{let i=await this.client.createItem({memoryType:"document",content:o,categoryId:s,tags:[`session:${e}`,`project:${t}`,"summary"],metadata:{...r,project:t,memorySessionId:e,isSummary:!0}});return l.info("MEMU","Summary stored",{itemId:i.id,project:t}),{id:i.id,memorySessionId:e,project:t,...r,createdAt:i.createdAt,createdAtEpoch:new Date(i.createdAt).getTime()}}catch(i){throw l.error("MEMU","Failed to store summary",{project:t},i),i}}async getSummary(e){try{let t=await this.client.retrieve({queries:[{role:"system",content:`session:${e}`}],method:"rag",limit:1,where:{namespace:this.client.namespace,tags:[`session:${e}`,"summary"]}});if(t.items.length===0)return null;let r=t.items[0],s=r.metadata||{};return{id:r.id,memorySessionId:e,project:String(s.project||""),request:s.request?String(s.request):null,investigated:s.investigated?String(s.investigated):null,learned:s.learned?String(s.learned):null,completed:s.completed?String(s.completed):null,nextSteps:s.nextSteps?String(s.nextSteps):null,notes:s.notes?String(s.notes):null,promptNumber:s.promptNumber?Number(s.promptNumber):void 0,createdAt:r.createdAt||new Date().toISOString(),createdAtEpoch:r.createdAt?new Date(r.createdAt).getTime():Date.now()}}catch{return null}}async getRecentSummaries(e,t=10){try{return(await this.client.retrieve({queries:[{role:"system",content:`project:${e}`}],method:"rag",limit:t,where:{namespace:this.client.namespace,tags:[`project:${e}`,"summary"]}})).items.map(s=>{let o=s.metadata||{};return{id:s.id,memorySessionId:String(o.memorySessionId||""),project:e,request:o.request?String(o.request):null,investigated:o.investigated?String(o.investigated):null,learned:o.learned?String(o.learned):null,completed:o.completed?String(o.completed):null,nextSteps:o.nextSteps?String(o.nextSteps):null,notes:o.notes?String(o.notes):null,createdAt:s.createdAt||new Date().toISOString(),createdAtEpoch:s.createdAt?new Date(s.createdAt).getTime():Date.now()}})}catch(r){return l.error("MEMU","Failed to get recent summaries",{project:e},r),[]}}async storeUserPrompt(e){let t=new Date;try{return{id:(await this.client.createItem({memoryType:"conversation",content:e.content,tags:["user-prompt",`session:${e.sessionId}`,`project:${e.project}`,`prompt:${e.promptNumber}`],metadata:{sessionId:e.sessionId,project:e.project,promptNumber:e.promptNumber}})).id,sessionId:e.sessionId,project:e.project,content:e.content,promptNumber:e.promptNumber,createdAt:t.toISOString(),createdAtEpoch:t.getTime()}}catch(r){throw l.error("MEMU","Failed to store user prompt",{},r),r}}async search(e){try{let t=[];e.text&&t.push({role:"user",content:e.text}),e.project&&t.push({role:"system",content:`project:${e.project}`}),t.length===0&&t.push({role:"system",content:"recent memories"});let r=await this.client.retrieve({queries:t,method:e.method||"rag",limit:e.limit||50,where:{namespace:this.client.namespace,memoryTypes:e.types,dateFrom:e.dateFrom,dateTo:e.dateTo}}),s=[],o=[],i=[];for(let a of r.items){let m=a.metadata||{};m.isSummary?o.push({id:a.id,memorySessionId:String(m.memorySessionId||""),project:String(m.project||""),request:m.request?String(m.request):null,investigated:m.investigated?String(m.investigated):null,learned:m.learned?String(m.learned):null,completed:m.completed?String(m.completed):null,nextSteps:m.nextSteps?String(m.nextSteps):null,notes:m.notes?String(m.notes):null,createdAt:a.createdAt||new Date().toISOString(),createdAtEpoch:a.createdAt?new Date(a.createdAt).getTime():Date.now()}):a.memoryType==="conversation"&&m.promptNumber!==void 0?i.push({id:a.id,sessionId:Number(m.sessionId||0),project:String(m.project||""),content:a.content||a.summary,promptNumber:Number(m.promptNumber),createdAt:a.createdAt||new Date().toISOString(),createdAtEpoch:a.createdAt?new Date(a.createdAt).getTime():Date.now()}):s.push(this.retrievedToObservation(a))}return{observations:s,summaries:o,prompts:i,proactiveContext:r.proactiveContext}}catch(t){return l.error("MEMU","Search failed",{},t),{observations:[],summaries:[],prompts:[]}}}async getContextForProject(e,t=10){try{let r=await this.client.retrieve({queries:[{role:"system",content:`project:${e}`},{role:"system",content:"recent work context"}],method:"llm",limit:t,where:{namespace:this.client.namespace,tags:[`project:${e}`]}}),s=[],o=[];for(let i of r.items){let a=i.metadata||{};a.isSummary?o.push({id:i.id,memorySessionId:String(a.memorySessionId||""),project:e,request:a.request?String(a.request):null,investigated:a.investigated?String(a.investigated):null,learned:a.learned?String(a.learned):null,completed:a.completed?String(a.completed):null,nextSteps:a.nextSteps?String(a.nextSteps):null,notes:a.notes?String(a.notes):null,createdAt:i.createdAt||new Date().toISOString(),createdAtEpoch:i.createdAt?new Date(i.createdAt).getTime():Date.now()}):s.push(this.retrievedToObservation(i))}return{recentObservations:s,recentSummaries:o,proactiveContext:r.proactiveContext,project:e,sessionCount:this.sessions.size}}catch(r){return l.error("MEMU","Failed to get context",{project:e},r),{recentObservations:[],recentSummaries:[],project:e,sessionCount:0}}}async getAllProjects(){try{return(await this.client.listCategories()).categories.map(t=>t.name)}catch{return Array.from(this.projectCategories.keys())}}async ensureProjectCategory(e){if(this.projectCategories.has(e))return this.projectCategories.get(e);try{let r=(await this.client.listCategories()).categories.find(o=>o.name===e);if(r)return this.projectCategories.set(e,r.id),r.id;let s=await this.client.createCategory({name:e,description:`Development memories for ${e}`});return this.projectCategories.set(e,s.id),s.id}catch{l.warn("MEMU","Failed to ensure project category",{project:e});return}}buildObservationContent(e){let t=[];return e.title&&t.push(`## ${e.title}`),e.subtitle&&t.push(e.subtitle),e.narrative&&t.push(e.narrative),e.facts.length>0&&(t.push("### Facts"),e.facts.forEach(r=>t.push(`- ${r}`))),e.filesRead.length>0&&t.push(`**Files Read:** ${e.filesRead.join(", ")}`),e.filesModified.length>0&&t.push(`**Files Modified:** ${e.filesModified.join(", ")}`),t.join(`

`)}buildSummaryContent(e){let t=["# Session Summary"];return e.request&&t.push(`## Request
${e.request}`),e.investigated&&t.push(`## Investigated
${e.investigated}`),e.learned&&t.push(`## Learned
${e.learned}`),e.completed&&t.push(`## Completed
${e.completed}`),e.nextSteps&&t.push(`## Next Steps
${e.nextSteps}`),e.notes&&t.push(`## Notes
${e.notes}`),t.join(`

`)}itemToObservation(e,t,r){let s=e.metadata||{};return{id:e.id,memorySessionId:t,project:r,type:e.memoryType,title:s.title?String(s.title):null,subtitle:s.subtitle?String(s.subtitle):null,facts:Array.isArray(s.facts)?s.facts:[],narrative:s.narrative?String(s.narrative):null,concepts:e.tags?.filter(o=>!o.startsWith("session:")&&!o.startsWith("project:")&&!o.startsWith("type:"))||[],filesRead:Array.isArray(s.filesRead)?s.filesRead:[],filesModified:Array.isArray(s.filesModified)?s.filesModified:[],promptNumber:s.promptNumber?Number(s.promptNumber):void 0,content:e.content,createdAt:e.createdAt,createdAtEpoch:new Date(e.createdAt).getTime()}}retrievedToObservation(e){let t=e.metadata||{};return{id:e.id,memorySessionId:String(t.memorySessionId||""),project:String(t.project||""),type:e.memoryType,title:t.title?String(t.title):null,subtitle:t.subtitle?String(t.subtitle):null,facts:Array.isArray(t.facts)?t.facts:[],narrative:t.narrative?String(t.narrative):null,concepts:Array.isArray(t.concepts)?t.concepts:[],filesRead:Array.isArray(t.filesRead)?t.filesRead:[],filesModified:Array.isArray(t.filesModified)?t.filesModified:[],promptNumber:t.promptNumber?Number(t.promptNumber):void 0,content:e.content||e.summary,createdAt:e.createdAt||new Date().toISOString(),createdAtEpoch:e.createdAt?new Date(e.createdAt).getTime():Date.now()}}};var v=require("fs"),V=require("path"),x=require("crypto");var y=require("fs"),O=require("path"),fe=require("os");var pe="bugfix,feature,refactor,discovery,decision,change",ge="how-it-works,why-it-exists,what-changed,problem-solution,gotcha,pattern,trade-off";var C=class{static DEFAULTS={CLAUDE_MEMU_MODE:"auto",CLAUDE_MEMU_API_KEY:"",CLAUDE_MEMU_API_URL:"https://api.memu.so",CLAUDE_MEMU_NAMESPACE:"default",CLAUDE_MEMU_WORKER_PORT:"37777",CLAUDE_MEMU_WORKER_HOST:"127.0.0.1",CLAUDE_MEMU_DATA_DIR:(0,O.join)((0,fe.homedir)(),".claude-memu"),CLAUDE_MEMU_LOG_LEVEL:"INFO",CLAUDE_MEMU_CONTEXT_LIMIT:"20",CLAUDE_MEMU_CONTEXT_TYPES:pe,CLAUDE_MEMU_CONTEXT_CONCEPTS:ge,CLAUDE_MEMU_PROACTIVE_CONTEXT:"true",CLAUDE_MEMU_SHOW_SUMMARIES:"true"};static getAllDefaults(){return{...this.DEFAULTS}}static get(e){return this.DEFAULTS[e]}static getWithEnv(e){return process.env[e]||this.DEFAULTS[e]}static getInt(e){let t=this.getWithEnv(e);return parseInt(t,10)}static getBool(e){return this.getWithEnv(e)==="true"}static getDataDir(){return this.getWithEnv("CLAUDE_MEMU_DATA_DIR")}static getWorkerPort(){return this.getInt("CLAUDE_MEMU_WORKER_PORT")}static getWorkerHost(){return this.getWithEnv("CLAUDE_MEMU_WORKER_HOST")}static getWorkerUrl(){return`http://${this.getWorkerHost()}:${this.getWorkerPort()}`}static loadFromFile(e){try{if(!(0,y.existsSync)(e)){let o=this.getAllDefaults();try{let i=(0,O.dirname)(e);(0,y.existsSync)(i)||(0,y.mkdirSync)(i,{recursive:!0}),(0,y.writeFileSync)(e,JSON.stringify(o,null,2),"utf-8"),console.log("[SETTINGS] Created settings file:",e)}catch(i){console.warn("[SETTINGS] Failed to create settings file:",i)}return o}let t=(0,y.readFileSync)(e,"utf-8"),r=JSON.parse(t),s={...this.DEFAULTS};for(let o of Object.keys(this.DEFAULTS))r[o]!==void 0&&(s[o]=r[o]);return s}catch(t){return console.warn("[SETTINGS] Failed to load settings, using defaults:",t),this.getAllDefaults()}}static saveToFile(e,t){try{let r=(0,O.dirname)(e);(0,y.existsSync)(r)||(0,y.mkdirSync)(r,{recursive:!0});let o={...this.loadFromFile(e),...t};(0,y.writeFileSync)(e,JSON.stringify(o,null,2),"utf-8")}catch(r){console.error("[SETTINGS] Failed to save settings:",r)}}};var U=class{dataDir;ready=!1;sessions=new Map;sessionsByContentId=new Map;nextSessionId=1;projectData=new Map;constructor(){this.dataDir=(0,V.join)(C.getDataDir(),"data")}async initialize(){try{(0,v.existsSync)(this.dataDir)||(0,v.mkdirSync)(this.dataDir,{recursive:!0}),this.loadAllProjects(),this.ready=!0,l.info("LOCAL","LocalStore initialized",{dataDir:this.dataDir})}catch(e){l.error("LOCAL","Failed to initialize LocalStore",{},e),this.ready=!0}}async close(){for(let[e,t]of this.projectData)this.saveProjectData(e,t);this.ready=!1,this.sessions.clear(),this.sessionsByContentId.clear(),this.projectData.clear(),l.info("LOCAL","LocalStore closed")}isReady(){return this.ready}async createSession(e,t,r){let s=this.sessionsByContentId.get(e);if(s!==void 0)return this.sessions.get(s);let o=new Date,i={id:this.nextSessionId++,contentSessionId:e,memorySessionId:`local-${(0,x.randomUUID)()}`,project:t,userPrompt:r,promptCounter:0,status:"active",createdAt:o.toISOString(),createdAtEpoch:o.getTime()};return this.sessions.set(i.id,i),this.sessionsByContentId.set(e,i.id),this.ensureProjectData(t),l.info("LOCAL","Session created",{sessionId:i.id,project:t}),i}getSession(e){return this.sessions.get(e)||null}getSessionByContentId(e){let t=this.sessionsByContentId.get(e);return t!==void 0&&this.sessions.get(t)||null}updateMemorySessionId(e,t){let r=this.sessions.get(e);r&&(r.memorySessionId=t)}incrementPromptCounter(e){let t=this.sessions.get(e);return t?(t.promptCounter++,t.promptCounter):0}async storeObservation(e,t,r){let s=new Date,o=this.ensureProjectData(t),i={...r,id:(0,x.randomUUID)(),memorySessionId:e,project:t,content:this.buildObservationContent(r),createdAt:s.toISOString(),createdAtEpoch:s.getTime()};return o.observations.push(i),this.saveProjectData(t,o),l.info("LOCAL","Observation stored",{id:i.id,type:r.type,project:t}),i}async getObservation(e){for(let t of this.projectData.values()){let r=t.observations.find(s=>s.id===e);if(r)return r}return null}async getRecentObservations(e,t=20){let r=this.getProjectData(e);return r?r.observations.sort((s,o)=>o.createdAtEpoch-s.createdAtEpoch).slice(0,t):[]}async storeSummary(e,t,r){let s=new Date,o=this.ensureProjectData(t),i={...r,id:(0,x.randomUUID)(),memorySessionId:e,project:t,createdAt:s.toISOString(),createdAtEpoch:s.getTime()};return o.summaries.push(i),this.saveProjectData(t,o),l.info("LOCAL","Summary stored",{id:i.id,project:t}),i}async getSummary(e){for(let t of this.projectData.values()){let r=t.summaries.find(s=>s.memorySessionId===e);if(r)return r}return null}async getRecentSummaries(e,t=10){let r=this.getProjectData(e);return r?r.summaries.sort((s,o)=>o.createdAtEpoch-s.createdAtEpoch).slice(0,t):[]}async storeUserPrompt(e){let t=new Date,r=this.ensureProjectData(e.project),s={...e,id:(0,x.randomUUID)(),createdAt:t.toISOString(),createdAtEpoch:t.getTime()};return r.prompts.push(s),this.saveProjectData(e.project,r),s}async search(e){let t=[],r=[],s=[],o=e.project?[e.project]:Array.from(this.projectData.keys());for(let a of o){let m=this.getProjectData(a);if(!m)continue;let u=m.observations;if(e.types&&e.types.length>0&&(u=u.filter(d=>e.types.includes(d.type))),e.concepts&&e.concepts.length>0&&(u=u.filter(d=>e.concepts.some(p=>d.concepts.includes(p)))),e.files&&e.files.length>0&&(u=u.filter(d=>e.files.some(p=>d.filesRead.includes(p)||d.filesModified.includes(p)))),e.dateFrom){let d=new Date(e.dateFrom).getTime();u=u.filter(p=>p.createdAtEpoch>=d)}if(e.dateTo){let d=new Date(e.dateTo).getTime();u=u.filter(p=>p.createdAtEpoch<=d)}if(e.text){let d=e.text.toLowerCase();u=u.filter(p=>p.title?.toLowerCase().includes(d)||p.narrative?.toLowerCase().includes(d)||p.content?.toLowerCase().includes(d)||p.facts.some(E=>E.toLowerCase().includes(d)))}t.push(...u);let f=m.summaries;if(e.dateFrom){let d=new Date(e.dateFrom).getTime();f=f.filter(p=>p.createdAtEpoch>=d)}if(e.dateTo){let d=new Date(e.dateTo).getTime();f=f.filter(p=>p.createdAtEpoch<=d)}if(e.text){let d=e.text.toLowerCase();f=f.filter(p=>p.request?.toLowerCase().includes(d)||p.completed?.toLowerCase().includes(d)||p.learned?.toLowerCase().includes(d))}r.push(...f);let g=m.prompts;if(e.text){let d=e.text.toLowerCase();g=g.filter(p=>p.content.toLowerCase().includes(d))}s.push(...g)}let i=e.limit||50;return{observations:t.sort((a,m)=>m.createdAtEpoch-a.createdAtEpoch).slice(0,i),summaries:r.sort((a,m)=>m.createdAtEpoch-a.createdAtEpoch).slice(0,i),prompts:s.sort((a,m)=>m.createdAtEpoch-a.createdAtEpoch).slice(0,i)}}async getContextForProject(e,t=10){let r=await this.getRecentObservations(e,t),s=await this.getRecentSummaries(e,Math.ceil(t/2));return{recentObservations:r,recentSummaries:s,project:e,sessionCount:this.sessions.size}}async getAllProjects(){return Array.from(this.projectData.keys())}getProjectFilePath(e){let t=e.replace(/[^a-zA-Z0-9_-]/g,"_");return(0,V.join)(this.dataDir,`${t}.json`)}loadAllProjects(){try{let e=(0,v.readdirSync)(this.dataDir);for(let t of e)if(t.endsWith(".json")){let r=t.replace(".json",""),s=this.loadProjectData(r);s&&this.projectData.set(r,s)}}catch{}}loadProjectData(e){try{let t=this.getProjectFilePath(e);if(!(0,v.existsSync)(t))return null;let r=(0,v.readFileSync)(t,"utf-8");return JSON.parse(r)}catch{return l.warn("LOCAL","Failed to load project data",{project:e}),null}}saveProjectData(e,t){try{let r=this.getProjectFilePath(e);(0,v.writeFileSync)(r,JSON.stringify(t,null,2),"utf-8")}catch(r){l.error("LOCAL","Failed to save project data",{project:e},r)}}getProjectData(e){let t=this.projectData.get(e);return t||(t=this.loadProjectData(e)||void 0,t&&this.projectData.set(e,t)),t||null}ensureProjectData(e){let t=this.projectData.get(e);return t||(t=this.loadProjectData(e)||this.createEmptyData(),this.projectData.set(e,t)),t}createEmptyData(){return{observations:[],summaries:[],prompts:[],categories:[],version:1}}buildObservationContent(e){let t=[];return e.title&&t.push(`## ${e.title}`),e.subtitle&&t.push(e.subtitle),e.narrative&&t.push(e.narrative),e.facts.length>0&&(t.push("### Facts"),e.facts.forEach(r=>t.push(`- ${r}`))),e.filesRead.length>0&&t.push(`**Files Read:** ${e.filesRead.join(", ")}`),e.filesModified.length>0&&t.push(`**Files Modified:** ${e.filesModified.join(", ")}`),t.join(`

`)}};var Q=class{store;mode;constructor(e){let t=e?.apiKey||C.getWithEnv("CLAUDE_MEMU_API_KEY");t&&t.trim()!==""?(this.mode="api",this.store=new R(e),l.info("STORE","Using API mode (memU cloud/self-hosted)")):(this.mode="local",this.store=new U,l.info("STORE","Using local mode (file-based storage)"))}getMode(){return this.mode}isLocalMode(){return this.mode==="local"}isApiMode(){return this.mode==="api"}async initialize(){return this.store.initialize()}async close(){return this.store.close()}isReady(){return this.store.isReady()}async createSession(e,t,r){return this.store.createSession(e,t,r)}getSession(e){return this.store.getSession(e)}getSessionByContentId(e){return this.store.getSessionByContentId(e)}updateMemorySessionId(e,t){return this.store.updateMemorySessionId(e,t)}incrementPromptCounter(e){return this.store.incrementPromptCounter(e)}async storeObservation(e,t,r){return this.store.storeObservation(e,t,r)}async getObservation(e){return this.store.getObservation(e)}async getRecentObservations(e,t){return this.store.getRecentObservations(e,t)}async storeSummary(e,t,r){return this.store.storeSummary(e,t,r)}async getSummary(e){return this.store.getSummary(e)}async getRecentSummaries(e,t){return this.store.getRecentSummaries(e,t)}async storeUserPrompt(e){return this.store.storeUserPrompt(e)}async search(e){return this.store.search(e)}async getContextForProject(e,t){return this.store.getContextForProject(e,t)}async getAllProjects(){return this.store.getAllProjects()}},J=null;function he(n){return J||(J=new Q(n)),J}var $=class{store;constructor(){this.store=he()}async initialize(){await this.store.initialize()}close(){}async createSession(e,t,r){let s=await this.store.createSession(e,t,r);return{id:s.id,content_session_id:s.contentSessionId,memory_session_id:s.memorySessionId,project:s.project,user_prompt:s.userPrompt}}getSessionById(e){let t=this.store.getSession(e);return t?{id:t.id,content_session_id:t.contentSessionId,memory_session_id:t.memorySessionId,project:t.project,user_prompt:t.userPrompt}:null}getSessionByContentId(e){let t=this.store.getSessionByContentId(e);return t?{id:t.id,content_session_id:t.contentSessionId,memory_session_id:t.memorySessionId,project:t.project,user_prompt:t.userPrompt}:null}updateMemorySessionId(e,t){this.store.updateMemorySessionId(e,t)}incrementPromptCounter(e){return this.store.incrementPromptCounter(e)}async storeObservation(e,t,r){return this.store.storeObservation(e,t,r)}async getObservationById(e){return this.store.getObservation(e)}async getRecentObservations(e,t){return this.store.getRecentObservations(e,t)}async storeSummary(e,t,r){return this.store.storeSummary(e,t,r)}async getSummaryForSession(e){return this.store.getSummary(e)}async getRecentSummaries(e,t){return this.store.getRecentSummaries(e,t)}async storeUserPrompt(e){return this.store.storeUserPrompt(e)}async getAllProjects(){return this.store.getAllProjects()}getStats(){return{observations:0,summaries:0,prompts:0,sessions:0}}get db(){return null}};var Se=P(require("path"),1);function ye(n){if(!n||n.trim()==="")return l.warn("PROJECT_NAME","Empty cwd provided, using fallback",{cwd:n}),"unknown-project";let e=Se.default.basename(n);if(e===""){if(process.platform==="win32"){let r=n.match(/^([A-Z]):\\/i);if(r){let o=`drive-${r[1].toUpperCase()}`;return l.info("PROJECT_NAME","Drive root detected",{cwd:n,projectName:o}),o}}return l.warn("PROJECT_NAME","Root directory detected, using fallback",{cwd:n}),"unknown-project"}return e}var be=P(require("path"),1),Ee=require("os");var A=require("fs"),j=require("path");var h=require("path"),ve=require("os");var Ce=require("url");var At={};function xt(){return typeof __dirname<"u"?__dirname:(0,h.dirname)((0,Ce.fileURLToPath)(At.url))}var $t=xt(),b=C.get("CLAUDE_MEM_DATA_DIR"),q=process.env.CLAUDE_CONFIG_DIR||(0,h.join)((0,ve.homedir)(),".claude"),br=(0,h.join)(b,"archives"),Er=(0,h.join)(b,"logs"),Tr=(0,h.join)(b,"trash"),_r=(0,h.join)(b,"backups"),Pr=(0,h.join)(b,"modes"),wr=(0,h.join)(b,"settings.json"),Or=(0,h.join)(b,"claude-mem.db"),xr=(0,h.join)(b,"vector-db"),$r=(0,h.join)(b,"observer-sessions"),Ar=(0,h.join)(q,"settings.json"),Dr=(0,h.join)(q,"commands"),Ir=(0,h.join)(q,"CLAUDE.md");function Me(){return(0,h.join)($t,"..")}var S=class n{static instance=null;activeMode=null;modesDir;constructor(){let e=Me(),t=[(0,j.join)(e,"modes"),(0,j.join)(e,"..","plugin","modes")],r=t.find(s=>(0,A.existsSync)(s));this.modesDir=r||t[0]}static getInstance(){return n.instance||(n.instance=new n),n.instance}parseInheritance(e){let t=e.split("--");if(t.length===1)return{hasParent:!1,parentId:"",overrideId:""};if(t.length>2)throw new Error(`Invalid mode inheritance: ${e}. Only one level of inheritance supported (parent--override)`);return{hasParent:!0,parentId:t[0],overrideId:e}}isPlainObject(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}deepMerge(e,t){let r={...e};for(let s in t){let o=t[s],i=e[s];this.isPlainObject(o)&&this.isPlainObject(i)?r[s]=this.deepMerge(i,o):r[s]=o}return r}loadModeFile(e){let t=(0,j.join)(this.modesDir,`${e}.json`);if(!(0,A.existsSync)(t))throw new Error(`Mode file not found: ${t}`);let r=(0,A.readFileSync)(t,"utf-8");return JSON.parse(r)}loadMode(e){let t=this.parseInheritance(e);if(!t.hasParent)try{let m=this.loadModeFile(e);return this.activeMode=m,l.debug("SYSTEM",`Loaded mode: ${m.name} (${e})`,void 0,{types:m.observation_types.map(u=>u.id),concepts:m.observation_concepts.map(u=>u.id)}),m}catch{if(l.warn("SYSTEM",`Mode file not found: ${e}, falling back to 'code'`),e==="code")throw new Error("Critical: code.json mode file missing");return this.loadMode("code")}let{parentId:r,overrideId:s}=t,o;try{o=this.loadMode(r)}catch{l.warn("SYSTEM",`Parent mode '${r}' not found for ${e}, falling back to 'code'`),o=this.loadMode("code")}let i;try{i=this.loadModeFile(s),l.debug("SYSTEM",`Loaded override file: ${s} for parent ${r}`)}catch{return l.warn("SYSTEM",`Override file '${s}' not found, using parent mode '${r}' only`),this.activeMode=o,o}if(!i)return l.warn("SYSTEM",`Invalid override file: ${s}, using parent mode '${r}' only`),this.activeMode=o,o;let a=this.deepMerge(o,i);return this.activeMode=a,l.debug("SYSTEM",`Loaded mode with inheritance: ${a.name} (${e} = ${r} + ${s})`,void 0,{parent:r,override:s,types:a.observation_types.map(m=>m.id),concepts:a.observation_concepts.map(m=>m.id)}),a}getActiveMode(){if(!this.activeMode)throw new Error("No mode loaded. Call loadMode() first.");return this.activeMode}getObservationTypes(){return this.getActiveMode().observation_types}getObservationConcepts(){return this.getActiveMode().observation_concepts}getTypeIcon(e){return this.getObservationTypes().find(r=>r.id===e)?.emoji||"\u{1F4DD}"}getWorkEmoji(e){return this.getObservationTypes().find(r=>r.id===e)?.work_emoji||"\u{1F4DD}"}validateType(e){return this.getObservationTypes().some(t=>t.id===e)}getTypeLabel(e){return this.getObservationTypes().find(r=>r.id===e)?.label||e}};function Z(){let n=be.default.join((0,Ee.homedir)(),".claude-mem","settings.json"),e=C.loadFromFile(n),t=e.CLAUDE_MEM_MODE,r=t==="code"||t.startsWith("code--"),s,o;if(r)s=new Set(e.CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES.split(",").map(i=>i.trim()).filter(Boolean)),o=new Set(e.CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS.split(",").map(i=>i.trim()).filter(Boolean));else{let i=S.getInstance().getActiveMode();s=new Set(i.observation_types.map(a=>a.id)),o=new Set(i.observation_concepts.map(a=>a.id))}return{totalObservationCount:parseInt(e.CLAUDE_MEM_CONTEXT_OBSERVATIONS,10),fullObservationCount:parseInt(e.CLAUDE_MEM_CONTEXT_FULL_COUNT,10),sessionCount:parseInt(e.CLAUDE_MEM_CONTEXT_SESSION_COUNT,10),showReadTokens:e.CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS==="true",showWorkTokens:e.CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS==="true",showSavingsAmount:e.CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT==="true",showSavingsPercent:e.CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT==="true",observationTypes:s,observationConcepts:o,fullObservationField:e.CLAUDE_MEM_CONTEXT_FULL_FIELD,showLastSummary:e.CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY==="true",showLastMessage:e.CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE==="true"}}var c={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",cyan:"\x1B[36m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",gray:"\x1B[90m",red:"\x1B[31m"},Te=4,ee=1;function te(n){let e=(n.title?.length||0)+(n.subtitle?.length||0)+(n.narrative?.length||0)+JSON.stringify(n.facts||[]).length;return Math.ceil(e/Te)}function re(n){let e=n.length,t=n.reduce((i,a)=>i+te(a),0),r=n.reduce((i,a)=>i+(a.discovery_tokens||0),0),s=r-t,o=r>0?Math.round(s/r*100):0;return{totalObservations:e,totalReadTokens:t,totalDiscoveryTokens:r,savings:s,savingsPercent:o}}function Dt(n){return S.getInstance().getWorkEmoji(n)}function T(n,e){let t=te(n),r=n.discovery_tokens||0,s=Dt(n.type),o=r>0?`${s} ${r.toLocaleString()}`:"-";return{readTokens:t,discoveryTokens:r,discoveryDisplay:o,workEmoji:s}}function F(n){return n.showReadTokens||n.showWorkTokens||n.showSavingsAmount||n.showSavingsPercent}var _e=P(require("path"),1),Pe=require("os"),N=require("fs");function ne(n,e,t){let r=Array.from(t.observationTypes),s=r.map(()=>"?").join(","),o=Array.from(t.observationConcepts),i=o.map(()=>"?").join(",");return n.db.prepare(`
    SELECT
      id, memory_session_id, type, title, subtitle, narrative,
      facts, concepts, files_read, files_modified, discovery_tokens,
      created_at, created_at_epoch
    FROM observations
    WHERE project = ?
      AND type IN (${s})
      AND EXISTS (
        SELECT 1 FROM json_each(concepts)
        WHERE value IN (${i})
      )
    ORDER BY created_at_epoch DESC
    LIMIT ?
  `).all(e,...r,...o,t.totalObservationCount)}function se(n,e,t){return n.db.prepare(`
    SELECT id, memory_session_id, request, investigated, learned, completed, next_steps, created_at, created_at_epoch
    FROM session_summaries
    WHERE project = ?
    ORDER BY created_at_epoch DESC
    LIMIT ?
  `).all(e,t.sessionCount+ee)}function we(n,e,t){let r=Array.from(t.observationTypes),s=r.map(()=>"?").join(","),o=Array.from(t.observationConcepts),i=o.map(()=>"?").join(","),a=e.map(()=>"?").join(",");return n.db.prepare(`
    SELECT
      id, memory_session_id, type, title, subtitle, narrative,
      facts, concepts, files_read, files_modified, discovery_tokens,
      created_at, created_at_epoch, project
    FROM observations
    WHERE project IN (${a})
      AND type IN (${s})
      AND EXISTS (
        SELECT 1 FROM json_each(concepts)
        WHERE value IN (${i})
      )
    ORDER BY created_at_epoch DESC
    LIMIT ?
  `).all(...e,...r,...o,t.totalObservationCount)}function Oe(n,e,t){let r=e.map(()=>"?").join(",");return n.db.prepare(`
    SELECT id, memory_session_id, request, investigated, learned, completed, next_steps, created_at, created_at_epoch, project
    FROM session_summaries
    WHERE project IN (${r})
    ORDER BY created_at_epoch DESC
    LIMIT ?
  `).all(...e,t.sessionCount+ee)}function It(n){return n.replace(/\//g,"-")}function kt(n){try{if(!(0,N.existsSync)(n))return{userMessage:"",assistantMessage:""};let e=(0,N.readFileSync)(n,"utf-8").trim();if(!e)return{userMessage:"",assistantMessage:""};let t=e.split(`
`).filter(s=>s.trim()),r="";for(let s=t.length-1;s>=0;s--)try{let o=t[s];if(!o.includes('"type":"assistant"'))continue;let i=JSON.parse(o);if(i.type==="assistant"&&i.message?.content&&Array.isArray(i.message.content)){let a="";for(let m of i.message.content)m.type==="text"&&(a+=m.text);if(a=a.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,"").trim(),a){r=a;break}}}catch(o){l.debug("PARSER","Skipping malformed transcript line",{lineIndex:s},o);continue}return{userMessage:"",assistantMessage:r}}catch(e){return l.failure("WORKER","Failed to extract prior messages from transcript",{transcriptPath:n},e),{userMessage:"",assistantMessage:""}}}function oe(n,e,t,r){if(!e.showLastMessage||n.length===0)return{userMessage:"",assistantMessage:""};let s=n.find(m=>m.memory_session_id!==t);if(!s)return{userMessage:"",assistantMessage:""};let o=s.memory_session_id,i=It(r),a=_e.default.join((0,Pe.homedir)(),".claude","projects",i,`${o}.jsonl`);return kt(a)}function xe(n,e){let t=e[0]?.id;return n.map((r,s)=>{let o=s===0?null:e[s+1];return{...r,displayEpoch:o?o.created_at_epoch:r.created_at_epoch,displayTime:o?o.created_at:r.created_at,shouldShowLink:r.id!==t}})}function ie(n,e){let t=[...n.map(r=>({type:"observation",data:r})),...e.map(r=>({type:"summary",data:r}))];return t.sort((r,s)=>{let o=r.type==="observation"?r.data.created_at_epoch:r.data.displayEpoch,i=s.type==="observation"?s.data.created_at_epoch:s.data.displayEpoch;return o-i}),t}function $e(n,e){return new Set(n.slice(0,e).map(t=>t.id))}function Ae(){let n=new Date,e=n.toLocaleDateString("en-CA"),t=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}).toLowerCase().replace(" ",""),r=n.toLocaleTimeString("en-US",{timeZoneName:"short"}).split(" ").pop();return`${e} ${t} ${r}`}function De(n){return[`# [${n}] recent context, ${Ae()}`,""]}function Ie(){return[`**Legend:** session-request | ${S.getInstance().getActiveMode().observation_types.map(t=>`${t.emoji} ${t.id}`).join(" | ")}`,""]}function ke(){return["**Column Key**:","- **Read**: Tokens to read this observation (cost to learn it now)","- **Work**: Tokens spent on work that produced this record ( research, building, deciding)",""]}function Le(){return["**Context Index:** This semantic index (titles, types, files, tokens) is usually sufficient to understand past work.","","When you need implementation details, rationale, or debugging context:","- Use MCP tools (search, get_observations) to fetch full observations on-demand","- Critical types ( bugfix, decision) often need detailed fetching","- Trust this index over re-reading code for past decisions and learnings",""]}function Re(n,e){let t=[];if(t.push("**Context Economics**:"),t.push(`- Loading: ${n.totalObservations} observations (${n.totalReadTokens.toLocaleString()} tokens to read)`),t.push(`- Work investment: ${n.totalDiscoveryTokens.toLocaleString()} tokens spent on research, building, and decisions`),n.totalDiscoveryTokens>0&&(e.showSavingsAmount||e.showSavingsPercent)){let r="- Your savings: ";e.showSavingsAmount&&e.showSavingsPercent?r+=`${n.savings.toLocaleString()} tokens (${n.savingsPercent}% reduction from reuse)`:e.showSavingsAmount?r+=`${n.savings.toLocaleString()} tokens`:r+=`${n.savingsPercent}% reduction from reuse`,t.push(r)}return t.push(""),t}function Ue(n){return[`### ${n}`,""]}function je(n){return[`**${n}**`,"| ID | Time | T | Title | Read | Work |","|----|------|---|-------|------|------|"]}function Fe(n,e,t){let r=n.title||"Untitled",s=S.getInstance().getTypeIcon(n.type),{readTokens:o,discoveryDisplay:i}=T(n,t),a=t.showReadTokens?`~${o}`:"",m=t.showWorkTokens?i:"";return`| #${n.id} | ${e||'"'} | ${s} | ${r} | ${a} | ${m} |`}function Ne(n,e,t,r){let s=[],o=n.title||"Untitled",i=S.getInstance().getTypeIcon(n.type),{readTokens:a,discoveryDisplay:m}=T(n,r);s.push(`**#${n.id}** ${e||'"'} ${i} **${o}**`),t&&(s.push(""),s.push(t),s.push(""));let u=[];return r.showReadTokens&&u.push(`Read: ~${a}`),r.showWorkTokens&&u.push(`Work: ${m}`),u.length>0&&s.push(u.join(", ")),s.push(""),s}function We(n,e){let t=`${n.request||"Session started"} (${e})`;return[`**#S${n.id}** ${t}`,""]}function D(n,e){return e?[`**${n}**: ${e}`,""]:[]}function He(n){return n.assistantMessage?["","---","","**Previously**","",`A: ${n.assistantMessage}`,""]:[]}function Be(n,e){return["",`Access ${Math.round(n/1e3)}k tokens of past research & decisions for just ${e.toLocaleString()}t. Use MCP search tools to access memories by ID.`]}function ze(n){return`# [${n}] recent context, ${Ae()}

No previous sessions found for this project yet.`}function Ke(){let n=new Date,e=n.toLocaleDateString("en-CA"),t=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}).toLowerCase().replace(" ",""),r=n.toLocaleTimeString("en-US",{timeZoneName:"short"}).split(" ").pop();return`${e} ${t} ${r}`}function Ge(n){return["",`${c.bright}${c.cyan}[${n}] recent context, ${Ke()}${c.reset}`,`${c.gray}${"\u2500".repeat(60)}${c.reset}`,""]}function Ye(){let e=S.getInstance().getActiveMode().observation_types.map(t=>`${t.emoji} ${t.id}`).join(" | ");return[`${c.dim}Legend: session-request | ${e}${c.reset}`,""]}function Xe(){return[`${c.bright}Column Key${c.reset}`,`${c.dim}  Read: Tokens to read this observation (cost to learn it now)${c.reset}`,`${c.dim}  Work: Tokens spent on work that produced this record ( research, building, deciding)${c.reset}`,""]}function Ve(){return[`${c.dim}Context Index: This semantic index (titles, types, files, tokens) is usually sufficient to understand past work.${c.reset}`,"",`${c.dim}When you need implementation details, rationale, or debugging context:${c.reset}`,`${c.dim}  - Use MCP tools (search, get_observations) to fetch full observations on-demand${c.reset}`,`${c.dim}  - Critical types ( bugfix, decision) often need detailed fetching${c.reset}`,`${c.dim}  - Trust this index over re-reading code for past decisions and learnings${c.reset}`,""]}function Je(n,e){let t=[];if(t.push(`${c.bright}${c.cyan}Context Economics${c.reset}`),t.push(`${c.dim}  Loading: ${n.totalObservations} observations (${n.totalReadTokens.toLocaleString()} tokens to read)${c.reset}`),t.push(`${c.dim}  Work investment: ${n.totalDiscoveryTokens.toLocaleString()} tokens spent on research, building, and decisions${c.reset}`),n.totalDiscoveryTokens>0&&(e.showSavingsAmount||e.showSavingsPercent)){let r="  Your savings: ";e.showSavingsAmount&&e.showSavingsPercent?r+=`${n.savings.toLocaleString()} tokens (${n.savingsPercent}% reduction from reuse)`:e.showSavingsAmount?r+=`${n.savings.toLocaleString()} tokens`:r+=`${n.savingsPercent}% reduction from reuse`,t.push(`${c.green}${r}${c.reset}`)}return t.push(""),t}function Qe(n){return[`${c.bright}${c.cyan}${n}${c.reset}`,""]}function qe(n){return[`${c.dim}${n}${c.reset}`]}function Ze(n,e,t,r){let s=n.title||"Untitled",o=S.getInstance().getTypeIcon(n.type),{readTokens:i,discoveryTokens:a,workEmoji:m}=T(n,r),u=t?`${c.dim}${e}${c.reset}`:" ".repeat(e.length),f=r.showReadTokens&&i>0?`${c.dim}(~${i}t)${c.reset}`:"",g=r.showWorkTokens&&a>0?`${c.dim}(${m} ${a.toLocaleString()}t)${c.reset}`:"";return`  ${c.dim}#${n.id}${c.reset}  ${u}  ${o}  ${s} ${f} ${g}`}function et(n,e,t,r,s){let o=[],i=n.title||"Untitled",a=S.getInstance().getTypeIcon(n.type),{readTokens:m,discoveryTokens:u,workEmoji:f}=T(n,s),g=t?`${c.dim}${e}${c.reset}`:" ".repeat(e.length),d=s.showReadTokens&&m>0?`${c.dim}(~${m}t)${c.reset}`:"",p=s.showWorkTokens&&u>0?`${c.dim}(${f} ${u.toLocaleString()}t)${c.reset}`:"";return o.push(`  ${c.dim}#${n.id}${c.reset}  ${g}  ${a}  ${c.bright}${i}${c.reset}`),r&&o.push(`    ${c.dim}${r}${c.reset}`),(d||p)&&o.push(`    ${d} ${p}`),o.push(""),o}function tt(n,e){let t=`${n.request||"Session started"} (${e})`;return[`${c.yellow}#S${n.id}${c.reset} ${t}`,""]}function I(n,e,t){return e?[`${t}${n}:${c.reset} ${e}`,""]:[]}function rt(n){return n.assistantMessage?["","---","",`${c.bright}${c.magenta}Previously${c.reset}`,"",`${c.dim}A: ${n.assistantMessage}${c.reset}`,""]:[]}function nt(n,e){let t=Math.round(n/1e3);return["",`${c.dim}Access ${t}k tokens of past research & decisions for just ${e.toLocaleString()}t. Use MCP search tools to access memories by ID.${c.reset}`]}function st(n){return`
${c.bright}${c.cyan}[${n}] recent context, ${Ke()}${c.reset}
${c.gray}${"\u2500".repeat(60)}${c.reset}

${c.dim}No previous sessions found for this project yet.${c.reset}
`}function ot(n,e,t,r){let s=[];return r?s.push(...Ge(n)):s.push(...De(n)),r?s.push(...Ye()):s.push(...Ie()),r?s.push(...Xe()):s.push(...ke()),r?s.push(...Ve()):s.push(...Le()),F(t)&&(r?s.push(...Je(e,t)):s.push(...Re(e,t))),s}var ae=P(require("path"),1);function B(n){if(!n)return[];try{let e=JSON.parse(n);return Array.isArray(e)?e:[]}catch(e){return l.debug("PARSER","Failed to parse JSON array, using empty fallback",{preview:n?.substring(0,50)},e),[]}}function at(n){return new Date(n).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function ct(n){return new Date(n).toLocaleString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}function mt(n){return new Date(n).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric"})}function it(n,e){return ae.default.isAbsolute(n)?ae.default.relative(e,n):n}function lt(n,e,t){let r=B(n);if(r.length>0)return it(r[0],e);if(t){let s=B(t);if(s.length>0)return it(s[0],e)}return"General"}function Lt(n){let e=new Map;for(let r of n){let s=r.type==="observation"?r.data.created_at:r.data.displayTime,o=mt(s);e.has(o)||e.set(o,[]),e.get(o).push(r)}let t=Array.from(e.entries()).sort((r,s)=>{let o=new Date(r[0]).getTime(),i=new Date(s[0]).getTime();return o-i});return new Map(t)}function Rt(n,e){return e.fullObservationField==="narrative"?n.narrative:n.facts?B(n.facts).join(`
`):null}function Ut(n,e,t,r,s,o){let i=[];o?i.push(...Qe(n)):i.push(...Ue(n));let a=null,m="",u=!1;for(let f of e)if(f.type==="summary"){u&&(i.push(""),u=!1,a=null,m="");let g=f.data,d=at(g.displayTime);o?i.push(...tt(g,d)):i.push(...We(g,d))}else{let g=f.data,d=lt(g.files_modified,s,g.files_read),p=ct(g.created_at),E=p!==m,_=E?p:"";m=p;let k=t.has(g.id);if(d!==a&&(u&&i.push(""),o?i.push(...qe(d)):i.push(...je(d)),a=d,u=!0),k){let z=Rt(g,r);o?i.push(...et(g,p,E,z,r)):(u&&!o&&(i.push(""),u=!1),i.push(...Ne(g,_,z,r)),a=null)}else o?i.push(Ze(g,p,E,r)):i.push(Fe(g,_,r))}return u&&i.push(""),i}function ut(n,e,t,r,s){let o=[],i=Lt(n);for(let[a,m]of i)o.push(...Ut(a,m,e,t,r,s));return o}function dt(n,e,t){return!(!n.showLastSummary||!e||!!!(e.investigated||e.learned||e.completed||e.next_steps)||t&&e.created_at_epoch<=t.created_at_epoch)}function pt(n,e){let t=[];return e?(t.push(...I("Investigated",n.investigated,c.blue)),t.push(...I("Learned",n.learned,c.yellow)),t.push(...I("Completed",n.completed,c.green)),t.push(...I("Next Steps",n.next_steps,c.magenta))):(t.push(...D("Investigated",n.investigated)),t.push(...D("Learned",n.learned)),t.push(...D("Completed",n.completed)),t.push(...D("Next Steps",n.next_steps))),t}function gt(n,e){return e?rt(n):He(n)}function ft(n,e,t){return!F(e)||n.totalDiscoveryTokens<=0||n.savings<=0?[]:t?nt(n.totalDiscoveryTokens,n.totalReadTokens):Be(n.totalDiscoveryTokens,n.totalReadTokens)}var jt=ht.default.join((0,St.homedir)(),".claude","plugins","marketplaces","thedotmack","plugin",".install-version");function Ft(){try{return new $}catch(n){if(n.code==="ERR_DLOPEN_FAILED"){try{(0,yt.unlinkSync)(jt)}catch(e){l.debug("SYSTEM","Marker file cleanup failed (may not exist)",{},e)}return l.error("SYSTEM","Native module rebuild needed - restart Claude Code to auto-fix"),null}throw n}}function Nt(n,e){return e?st(n):ze(n)}function Wt(n,e,t,r,s,o,i){let a=[],m=re(e);a.push(...ot(n,m,r,i));let u=t.slice(0,r.sessionCount),f=xe(u,t),g=ie(e,f),d=$e(e,r.fullObservationCount);a.push(...ut(g,d,r,s,i));let p=t[0],E=e[0];dt(r,p,E)&&a.push(...pt(p,i));let _=oe(e,r,o,s);return a.push(...gt(_,i)),a.push(...ft(m,r,i)),a.join(`
`).trimEnd()}async function ce(n,e=!1){let t=Z(),r=n?.cwd??process.cwd(),s=ye(r),o=n?.projects||[s],i=Ft();if(!i)return"";try{let a=o.length>1?we(i,o,t):ne(i,s,t),m=o.length>1?Oe(i,o,t):se(i,s,t);return a.length===0&&m.length===0?Nt(s,e):Wt(s,a,m,t,r,n?.session_id,e)}finally{i.close()}}0&&(module.exports={generateContext});
