#!/usr/bin/env node
import L from"path";import{stdin as T}from"process";import{execSync as f}from"child_process";import N from"path";import{homedir as R}from"os";import{join as o,dirname as l,basename as x}from"path";import{homedir as u}from"os";import{fileURLToPath as A}from"url";function g(){return typeof __dirname<"u"?__dirname:l(A(import.meta.url))}var v=g(),s=process.env.CLAUDE_MEM_DATA_DIR||o(u(),".claude-mem"),E=process.env.CLAUDE_CONFIG_DIR||o(u(),".claude"),k=o(s,"archives"),b=o(s,"logs"),W=o(s,"trash"),F=o(s,"backups"),H=o(s,"settings.json"),X=o(s,"claude-mem.db"),B=o(s,"vector-db"),V=o(E,"settings.json"),j=o(E,"commands"),G=o(E,"CLAUDE.md");import{readFileSync as D,existsSync as M}from"fs";var C=["bugfix","feature","refactor","discovery","decision","change"],d=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var p=C.join(","),S=d.join(",");var a=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:p,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:S,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return process.env[t]||this.DEFAULTS[t]}static getInt(t){let r=this.get(t);return parseInt(r,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){let r={...this.DEFAULTS};if(M(t)){let n=D(t,"utf-8"),i=JSON.parse(n).env||{};for(let c of Object.keys(this.DEFAULTS))i[c]!==void 0&&(r[c]=i[c])}for(let n of Object.keys(this.DEFAULTS))process.env[n]!==void 0&&(r[n]=process.env[n]);return r}};function m(){let e=N.join(R(),".claude-mem","settings.json"),t=a.loadFromFile(e);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function U(e,t=1e4){let r=Date.now(),n=100;for(;Date.now()-r<t;)try{return f(`curl -s -f -m 1 "http://127.0.0.1:${e}/api/health" > /dev/null 2>&1`,{timeout:1e3}),!0}catch{await new Promise(_=>setTimeout(_,n))}return!1}async function O(e){let t=e?.cwd??process.cwd(),r=t?L.basename(t):"unknown-project",n=m();if(!await U(n))throw new Error(`Worker service not available on port ${n} after 10s. Try: npm run worker:restart`);let i=`http://127.0.0.1:${n}/api/context/inject?project=${encodeURIComponent(r)}`;return f(`curl -s "${i}"`,{encoding:"utf-8",timeout:5e3}).trim()}var y=process.argv.includes("--colors");if(T.isTTY||y)O(void 0).then(e=>{console.log(e),process.exit(0)});else{let e="";T.on("data",t=>e+=t),T.on("end",async()=>{let t=e.trim()?JSON.parse(e):void 0,r=await O(t);console.log(JSON.stringify({hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:r}})),process.exit(0)})}
