#!/usr/bin/env node
import L from"path";import{stdin as u}from"process";import{execSync as f}from"child_process";import N from"path";import{homedir as R}from"os";import{join as n,dirname as l,basename as x}from"path";import{homedir as T}from"os";import{fileURLToPath as g}from"url";function A(){return typeof __dirname<"u"?__dirname:l(g(import.meta.url))}var v=A(),s=process.env.CLAUDE_MEM_DATA_DIR||n(T(),".claude-mem"),E=process.env.CLAUDE_CONFIG_DIR||n(T(),".claude"),k=n(s,"archives"),b=n(s,"logs"),W=n(s,"trash"),F=n(s,"backups"),H=n(s,"settings.json"),X=n(s,"claude-mem.db"),B=n(s,"vector-db"),V=n(E,"settings.json"),j=n(E,"commands"),G=n(E,"CLAUDE.md");import{readFileSync as D,existsSync as M}from"fs";var C=["bugfix","feature","refactor","discovery","decision","change"],d=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var p=C.join(","),S=d.join(",");var a=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:p,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:S,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return process.env[t]||this.DEFAULTS[t]}static getInt(t){let o=this.get(t);return parseInt(o,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){let o={...this.DEFAULTS};if(M(t))try{let e=D(t,"utf-8"),i=JSON.parse(e).env||{};for(let c of Object.keys(this.DEFAULTS))i[c]!==void 0&&(o[c]=String(i[c]))}catch(e){console.error(`[SettingsDefaultsManager] Failed to parse settings file at ${t}:`,e)}for(let e of Object.keys(this.DEFAULTS))process.env[e]!==void 0&&(o[e]=String(process.env[e]));return o}};function m(){let r=N.join(R(),".claude-mem","settings.json"),t=a.loadFromFile(r);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function U(r,t=1e4){let o=Date.now(),e=100;for(;Date.now()-o<t;)try{return f(`curl -s -f -m 1 "http://127.0.0.1:${r}/api/health" > /dev/null 2>&1`,{timeout:1e3}),!0}catch{await new Promise(_=>setTimeout(_,e))}return!1}async function O(r){let t=r?.cwd??process.cwd(),o=t?L.basename(t):"unknown-project",e=m();if(!await U(e))throw new Error(`Worker service not available on port ${e} after 10s. Try: npm run worker:restart`);let i=`http://127.0.0.1:${e}/api/context/inject?project=${encodeURIComponent(o)}`;return f(`curl -s "${i}"`,{encoding:"utf-8",timeout:5e3}).trim()}var y=process.argv.includes("--colors");if(u.isTTY||y)O(void 0).then(r=>{console.log(r),process.exit(0)});else{let r="";u.on("data",t=>r+=t),u.on("end",async()=>{let t=r.trim()?JSON.parse(r):void 0,o=await O(t);console.log(JSON.stringify({hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:o}})),process.exit(0)})}
