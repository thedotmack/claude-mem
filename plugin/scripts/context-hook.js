#!/usr/bin/env node
import u from"path";import{unlinkSync as p}from"fs";import{stdin as a}from"process";import{fileURLToPath as d}from"url";import{dirname as m}from"path";var f=d(import.meta.url),h=m(f),x=u.join(h,"../../.install-version"),c={reset:"\x1B[0m",red:"\x1B[31m"};function k(){return parseInt(process.env.CLAUDE_MEM_WORKER_PORT||"37777",10)}async function l(e,t=!1){let o=e?.cwd??process.cwd(),n=o?u.basename(o):"unknown-project";try{let r=k(),i=new URLSearchParams({project:n,useColors:String(t),cwd:o}),s=await fetch(`http://localhost:${r}/api/context/session-start?${i}`);if(!s.ok)throw new Error(`Worker returned ${s.status}`);return(await s.json())[0]?.text||""}catch(r){if(r.code==="ERR_DLOPEN_FAILED"){try{p(x)}catch{}console.error("\u26A0\uFE0F  Native module rebuild needed - restart Claude Code to auto-fix"),console.error("   (This happens after Node.js version upgrades)"),process.exit(0)}return console.error("[context-hook] Worker unavailable:",r.message),t?`${c.red}\u26A0\uFE0F  Context unavailable (worker offline)${c.reset}`:"\u26A0\uFE0F  Context unavailable (worker offline)"}}var _=process.argv.includes("--colors");if(a.isTTY||_)l(void 0,!0).then(e=>{console.log(e),process.exit(0)});else{let e="";a.on("data",t=>e+=t),a.on("end",async()=>{let t=e.trim()?JSON.parse(e):void 0,n={hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:await l(t,!1)}};console.log(JSON.stringify(n)),process.exit(0)})}
