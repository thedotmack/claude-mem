#!/usr/bin/env node
var Bt=Object.defineProperty;var Ht=(s,e)=>{for(var t in e)Bt(s,t,{get:e[t],enumerable:!0})};import tn from"path";import{stdin as Ut}from"process";import Qt from"better-sqlite3";import{join as M,dirname as Wt,basename as Xt}from"path";import{homedir as dt}from"os";import{existsSync as ln,mkdirSync as zt}from"fs";import{fileURLToPath as Vt}from"url";function Zt(){return typeof __dirname<"u"?__dirname:Wt(Vt(import.meta.url))}var Gt=Zt(),K=process.env.CLAUDE_MEM_DATA_DIR||M(dt(),".claude-mem"),Ke=process.env.CLAUDE_CONFIG_DIR||M(dt(),".claude"),pn=M(K,"archives"),mn=M(K,"logs"),fn=M(K,"trash"),ke=M(K,"backups"),_n=M(K,"settings.json"),lt=M(K,"claude-mem.db"),hn=M(K,"vector-db"),gn=M(Ke,"settings.json"),yn=M(Ke,"commands"),En=M(Ke,"CLAUDE.md");function xe(s){zt(s,{recursive:!0})}function ut(){return M(Gt,"..","..")}function pt(s){let e=new Date().toISOString().replace(/[:.]/g,"-").replace("T","_").slice(0,19),t=Xt(s);return M(ke,`${t}.backup.${e}`)}var Ye=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(Ye||{}),qe=class{level;useColor;constructor(){let e=process.env.CLAUDE_MEM_LOG_LEVEL?.toUpperCase()||"INFO";this.level=Ye[e]??1,this.useColor=process.stdout.isTTY??!1}correlationId(e,t){return`obs-${e}-${t}`}sessionId(e){return`session-${e}`}formatData(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="object"){if(e instanceof Error)return this.level===0?`${e.message}
${e.stack}`:e.message;if(Array.isArray(e))return`[${e.length} items]`;let t=Object.keys(e);return t.length===0?"{}":t.length<=3?JSON.stringify(e):`{${t.length} keys: ${t.slice(0,3).join(", ")}...}`}return String(e)}formatTool(e,t){if(!t)return e;try{let r=typeof t=="string"?JSON.parse(t):t;if(e==="Bash"&&r.command){let n=r.command.length>50?r.command.substring(0,50)+"...":r.command;return`${e}(${n})`}if(e==="Read"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}if(e==="Edit"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}if(e==="Write"&&r.file_path){let n=r.file_path.split("/").pop()||r.file_path;return`${e}(${n})`}return e}catch{return e}}log(e,t,r,n,o){if(e<this.level)return;let i=new Date().toISOString().replace("T"," ").substring(0,23),a=Ye[e].padEnd(5),c=t.padEnd(6),d="";n?.correlationId?d=`[${n.correlationId}] `:n?.sessionId&&(d=`[session-${n.sessionId}] `);let _="";o!=null&&(this.level===0&&typeof o=="object"?_=`
`+JSON.stringify(o,null,2):_=" "+this.formatData(o));let v="";if(n){let{sessionId:x,sdkSessionId:L,correlationId:N,...b}=n;Object.keys(b).length>0&&(v=` {${Object.entries(b).map(([$,W])=>`${$}=${W}`).join(", ")}}`)}let O=`[${i}] [${a}] [${c}] ${d}${r}${v}${_}`;e===3?console.error(O):console.log(O)}debug(e,t,r,n){this.log(0,e,t,r,n)}info(e,t,r,n){this.log(1,e,t,r,n)}warn(e,t,r,n){this.log(2,e,t,r,n)}error(e,t,r,n){this.log(3,e,t,r,n)}dataIn(e,t,r,n){this.info(e,`\u2192 ${t}`,r,n)}dataOut(e,t,r,n){this.info(e,`\u2190 ${t}`,r,n)}success(e,t,r,n){this.info(e,`\u2713 ${t}`,r,n)}failure(e,t,r,n){this.error(e,`\u2717 ${t}`,r,n)}timing(e,t,r,n){this.info(e,`\u23F1 ${t}`,n,{duration:`${r}ms`})}},y=new qe;import{appendFileSync as Kt}from"fs";import{homedir as Yt}from"os";import{join as qt}from"path";var Jt=qt(Yt(),".pm2","logs","claude-mem-worker-error.log");function R(s,e,t=""){let r=new Date().toISOString(),a=((new Error().stack?.split(`
`)??[])[2]??"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),c=a?`${a[1].split("/").pop()}:${a[2]}`:"unknown",d=`[${r}] [HAPPY-PATH-ERROR] [${c}] ${s}`;if(e!==void 0)try{d+=` ${JSON.stringify(e)}`}catch(_){d+=` [stringify error: ${_}]`}d+=`
`;try{Kt(Jt,d)}catch{}return t}var ie=class{db;constructor(){xe(K),this.db=new Qt(lt),this.db.pragma("journal_mode = WAL"),this.db.pragma("synchronous = NORMAL"),this.db.pragma("foreign_keys = ON"),this.initializeSchema(),this.ensureWorkerPortColumn(),this.ensurePromptTrackingColumns(),this.removeSessionSummariesUniqueConstraint(),this.addObservationHierarchicalFields(),this.makeObservationsTextNullable(),this.addEndlessModeStatsColumns(),this.createUserPromptsTable(),this.ensureDiscoveryTokensColumn(),this.addToolUseIdColumn(),this.removeToolUseIdUniqueConstraint()}initializeSchema(){try{this.db.exec(`
        CREATE TABLE IF NOT EXISTS schema_versions (
          id INTEGER PRIMARY KEY,
          version INTEGER UNIQUE NOT NULL,
          applied_at TEXT NOT NULL
        )
      `);let e=this.db.prepare("SELECT version FROM schema_versions ORDER BY version").all();(e.length>0?Math.max(...e.map(r=>r.version)):0)===0&&(console.error("[SessionStore] Initializing fresh database with migration004..."),this.db.exec(`
          CREATE TABLE IF NOT EXISTS sdk_sessions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            claude_session_id TEXT UNIQUE NOT NULL,
            sdk_session_id TEXT UNIQUE,
            project TEXT NOT NULL,
            user_prompt TEXT,
            started_at TEXT NOT NULL,
            started_at_epoch INTEGER NOT NULL,
            completed_at TEXT,
            completed_at_epoch INTEGER,
            status TEXT CHECK(status IN ('active', 'completed', 'failed')) NOT NULL DEFAULT 'active',
            endless_original_tokens INTEGER DEFAULT 0,
            endless_compressed_tokens INTEGER DEFAULT 0,
            endless_tokens_saved INTEGER DEFAULT 0
          );

          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_claude_id ON sdk_sessions(claude_session_id);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_sdk_id ON sdk_sessions(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_project ON sdk_sessions(project);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_status ON sdk_sessions(status);
          CREATE INDEX IF NOT EXISTS idx_sdk_sessions_started ON sdk_sessions(started_at_epoch DESC);

          CREATE TABLE IF NOT EXISTS observations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            text TEXT NOT NULL,
            type TEXT NOT NULL CHECK(type IN ('decision', 'bugfix', 'feature', 'refactor', 'discovery')),
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          );

          CREATE INDEX IF NOT EXISTS idx_observations_sdk_session ON observations(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_observations_project ON observations(project);
          CREATE INDEX IF NOT EXISTS idx_observations_type ON observations(type);
          CREATE INDEX IF NOT EXISTS idx_observations_created ON observations(created_at_epoch DESC);

          CREATE TABLE IF NOT EXISTS session_summaries (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT UNIQUE NOT NULL,
            project TEXT NOT NULL,
            request TEXT,
            investigated TEXT,
            learned TEXT,
            completed TEXT,
            next_steps TEXT,
            files_read TEXT,
            files_edited TEXT,
            notes TEXT,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          );

          CREATE INDEX IF NOT EXISTS idx_session_summaries_sdk_session ON session_summaries(sdk_session_id);
          CREATE INDEX IF NOT EXISTS idx_session_summaries_project ON session_summaries(project);
          CREATE INDEX IF NOT EXISTS idx_session_summaries_created ON session_summaries(created_at_epoch DESC);
        `),this.db.prepare("INSERT INTO schema_versions (version, applied_at) VALUES (?, ?)").run(4,new Date().toISOString()),console.error("[SessionStore] Migration004 applied successfully"))}catch(e){throw console.error("[SessionStore] Schema initialization error:",e.message),e}}ensureWorkerPortColumn(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(5))return;this.db.pragma("table_info(sdk_sessions)").some(n=>n.name==="worker_port")||(this.db.exec("ALTER TABLE sdk_sessions ADD COLUMN worker_port INTEGER"),console.error("[SessionStore] Added worker_port column to sdk_sessions table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(5,new Date().toISOString())}catch(e){console.error("[SessionStore] Migration error:",e.message)}}ensurePromptTrackingColumns(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(6))return;this.db.pragma("table_info(sdk_sessions)").some(c=>c.name==="prompt_counter")||(this.db.exec("ALTER TABLE sdk_sessions ADD COLUMN prompt_counter INTEGER DEFAULT 0"),console.error("[SessionStore] Added prompt_counter column to sdk_sessions table")),this.db.pragma("table_info(observations)").some(c=>c.name==="prompt_number")||(this.db.exec("ALTER TABLE observations ADD COLUMN prompt_number INTEGER"),console.error("[SessionStore] Added prompt_number column to observations table")),this.db.pragma("table_info(session_summaries)").some(c=>c.name==="prompt_number")||(this.db.exec("ALTER TABLE session_summaries ADD COLUMN prompt_number INTEGER"),console.error("[SessionStore] Added prompt_number column to session_summaries table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(6,new Date().toISOString())}catch(e){console.error("[SessionStore] Prompt tracking migration error:",e.message)}}removeSessionSummariesUniqueConstraint(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(7))return;if(!this.db.pragma("index_list(session_summaries)").some(n=>n.unique===1)){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(7,new Date().toISOString());return}console.error("[SessionStore] Removing UNIQUE constraint from session_summaries.sdk_session_id..."),this.db.exec("BEGIN TRANSACTION");try{this.db.exec(`
          CREATE TABLE session_summaries_new (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            request TEXT,
            investigated TEXT,
            learned TEXT,
            completed TEXT,
            next_steps TEXT,
            files_read TEXT,
            files_edited TEXT,
            notes TEXT,
            prompt_number INTEGER,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          )
        `),this.db.exec(`
          INSERT INTO session_summaries_new
          SELECT id, sdk_session_id, project, request, investigated, learned,
                 completed, next_steps, files_read, files_edited, notes,
                 prompt_number, created_at, created_at_epoch
          FROM session_summaries
        `),this.db.exec("DROP TABLE session_summaries"),this.db.exec("ALTER TABLE session_summaries_new RENAME TO session_summaries"),this.db.exec(`
          CREATE INDEX idx_session_summaries_sdk_session ON session_summaries(sdk_session_id);
          CREATE INDEX idx_session_summaries_project ON session_summaries(project);
          CREATE INDEX idx_session_summaries_created ON session_summaries(created_at_epoch DESC);
        `),this.db.exec("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(7,new Date().toISOString()),console.error("[SessionStore] Successfully removed UNIQUE constraint from session_summaries.sdk_session_id")}catch(n){throw this.db.exec("ROLLBACK"),n}}catch(e){console.error("[SessionStore] Migration error (remove UNIQUE constraint):",e.message)}}addObservationHierarchicalFields(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(8))return;if(this.db.pragma("table_info(observations)").some(n=>n.name==="title")){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(8,new Date().toISOString());return}console.error("[SessionStore] Adding hierarchical fields to observations table..."),this.db.exec(`
        ALTER TABLE observations ADD COLUMN title TEXT;
        ALTER TABLE observations ADD COLUMN subtitle TEXT;
        ALTER TABLE observations ADD COLUMN facts TEXT;
        ALTER TABLE observations ADD COLUMN narrative TEXT;
        ALTER TABLE observations ADD COLUMN concepts TEXT;
        ALTER TABLE observations ADD COLUMN files_read TEXT;
        ALTER TABLE observations ADD COLUMN files_modified TEXT;
      `),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(8,new Date().toISOString()),console.error("[SessionStore] Successfully added hierarchical fields to observations table")}catch(e){console.error("[SessionStore] Migration error (add hierarchical fields):",e.message)}}makeObservationsTextNullable(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(9))return;let r=this.db.pragma("table_info(observations)").find(n=>n.name==="text");if(!r||r.notnull===0){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(9,new Date().toISOString());return}console.error("[SessionStore] Making observations.text nullable..."),this.db.exec("BEGIN TRANSACTION");try{this.db.exec(`
          CREATE TABLE observations_new (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            sdk_session_id TEXT NOT NULL,
            project TEXT NOT NULL,
            text TEXT,
            type TEXT NOT NULL CHECK(type IN ('decision', 'bugfix', 'feature', 'refactor', 'discovery', 'change')),
            title TEXT,
            subtitle TEXT,
            facts TEXT,
            narrative TEXT,
            concepts TEXT,
            files_read TEXT,
            files_modified TEXT,
            prompt_number INTEGER,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(sdk_session_id) REFERENCES sdk_sessions(sdk_session_id) ON DELETE CASCADE
          )
        `),this.db.exec(`
          INSERT INTO observations_new
          SELECT id, sdk_session_id, project, text, type, title, subtitle, facts,
                 narrative, concepts, files_read, files_modified, prompt_number,
                 created_at, created_at_epoch
          FROM observations
        `),this.db.exec("DROP TABLE observations"),this.db.exec("ALTER TABLE observations_new RENAME TO observations"),this.db.exec(`
          CREATE INDEX idx_observations_sdk_session ON observations(sdk_session_id);
          CREATE INDEX idx_observations_project ON observations(project);
          CREATE INDEX idx_observations_type ON observations(type);
          CREATE INDEX idx_observations_created ON observations(created_at_epoch DESC);
        `),this.db.exec("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(9,new Date().toISOString()),console.error("[SessionStore] Successfully made observations.text nullable")}catch(n){throw this.db.exec("ROLLBACK"),n}}catch(e){console.error("[SessionStore] Migration error (make text nullable):",e.message)}}createUserPromptsTable(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(10))return;if(this.db.pragma("table_info(user_prompts)").length>0){this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(10,new Date().toISOString());return}console.error("[SessionStore] Creating user_prompts table with FTS5 support..."),this.db.exec("BEGIN TRANSACTION");try{this.db.exec(`
          CREATE TABLE user_prompts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            claude_session_id TEXT NOT NULL,
            prompt_number INTEGER NOT NULL,
            prompt_text TEXT NOT NULL,
            created_at TEXT NOT NULL,
            created_at_epoch INTEGER NOT NULL,
            FOREIGN KEY(claude_session_id) REFERENCES sdk_sessions(claude_session_id) ON DELETE CASCADE
          );

          CREATE INDEX idx_user_prompts_claude_session ON user_prompts(claude_session_id);
          CREATE INDEX idx_user_prompts_created ON user_prompts(created_at_epoch DESC);
          CREATE INDEX idx_user_prompts_prompt_number ON user_prompts(prompt_number);
        `),this.db.exec(`
          CREATE VIRTUAL TABLE user_prompts_fts USING fts5(
            prompt_text,
            content='user_prompts',
            content_rowid='id'
          );
        `),this.db.exec(`
          CREATE TRIGGER user_prompts_ai AFTER INSERT ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(rowid, prompt_text)
            VALUES (new.id, new.prompt_text);
          END;

          CREATE TRIGGER user_prompts_ad AFTER DELETE ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(user_prompts_fts, rowid, prompt_text)
            VALUES('delete', old.id, old.prompt_text);
          END;

          CREATE TRIGGER user_prompts_au AFTER UPDATE ON user_prompts BEGIN
            INSERT INTO user_prompts_fts(user_prompts_fts, rowid, prompt_text)
            VALUES('delete', old.id, old.prompt_text);
            INSERT INTO user_prompts_fts(rowid, prompt_text)
            VALUES (new.id, new.prompt_text);
          END;
        `),this.db.exec("COMMIT"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(10,new Date().toISOString()),console.error("[SessionStore] Successfully created user_prompts table with FTS5 support")}catch(r){throw this.db.exec("ROLLBACK"),r}}catch(e){console.error("[SessionStore] Migration error (create user_prompts table):",e.message)}}ensureDiscoveryTokensColumn(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(11))return;this.db.pragma("table_info(observations)").some(i=>i.name==="discovery_tokens")||(this.db.exec("ALTER TABLE observations ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),console.error("[SessionStore] Added discovery_tokens column to observations table")),this.db.pragma("table_info(session_summaries)").some(i=>i.name==="discovery_tokens")||(this.db.exec("ALTER TABLE session_summaries ADD COLUMN discovery_tokens INTEGER DEFAULT 0"),console.error("[SessionStore] Added discovery_tokens column to session_summaries table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(11,new Date().toISOString())}catch(e){throw console.error("[SessionStore] Discovery tokens migration error:",e.message),e}}addToolUseIdColumn(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(12))return;this.db.pragma("table_info(observations)").some(n=>n.name==="tool_use_id")||(this.db.exec("ALTER TABLE observations ADD COLUMN tool_use_id TEXT"),console.error("[SessionStore] Added tool_use_id column to observations table"),this.db.exec("CREATE INDEX IF NOT EXISTS idx_observations_tool_use_id ON observations(tool_use_id) WHERE tool_use_id IS NOT NULL"),console.error("[SessionStore] Created index on tool_use_id column")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(12,new Date().toISOString())}catch(e){console.error("[SessionStore] Tool use ID migration error:",e.message)}}addEndlessModeStatsColumns(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(13))return;let t=this.db.pragma("table_info(sdk_sessions)"),r=t.some(i=>i.name==="endless_original_tokens"),n=t.some(i=>i.name==="endless_compressed_tokens"),o=t.some(i=>i.name==="endless_tokens_saved");r||(this.db.exec("ALTER TABLE sdk_sessions ADD COLUMN endless_original_tokens INTEGER DEFAULT 0"),console.error("[SessionStore] Added endless_original_tokens column to sdk_sessions table")),n||(this.db.exec("ALTER TABLE sdk_sessions ADD COLUMN endless_compressed_tokens INTEGER DEFAULT 0"),console.error("[SessionStore] Added endless_compressed_tokens column to sdk_sessions table")),o||(this.db.exec("ALTER TABLE sdk_sessions ADD COLUMN endless_tokens_saved INTEGER DEFAULT 0"),console.error("[SessionStore] Added endless_tokens_saved column to sdk_sessions table")),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(13,new Date().toISOString())}catch(e){console.error("[SessionStore] Endless Mode stats migration error:",e.message)}}removeToolUseIdUniqueConstraint(){try{if(this.db.prepare("SELECT version FROM schema_versions WHERE version = ?").get(14))return;this.db.exec("DROP INDEX IF EXISTS idx_observations_tool_use_id"),console.error("[SessionStore] Dropped UNIQUE index on tool_use_id"),this.db.exec("CREATE INDEX IF NOT EXISTS idx_observations_tool_use_id ON observations(tool_use_id) WHERE tool_use_id IS NOT NULL"),console.error("[SessionStore] Recreated tool_use_id index without UNIQUE constraint"),this.db.prepare("INSERT OR IGNORE INTO schema_versions (version, applied_at) VALUES (?, ?)").run(14,new Date().toISOString())}catch(e){console.error("[SessionStore] Remove UNIQUE constraint migration error:",e.message)}}getRecentSummaries(e,t=10){return this.db.prepare(`
      SELECT
        request, investigated, learned, completed, next_steps,
        files_read, files_edited, notes, prompt_number, created_at
      FROM session_summaries
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getRecentSummariesWithSessionInfo(e,t=3){return this.db.prepare(`
      SELECT
        sdk_session_id, request, learned, completed, next_steps,
        prompt_number, created_at
      FROM session_summaries
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getRecentObservations(e,t=20){return this.db.prepare(`
      SELECT type, text, prompt_number, created_at
      FROM observations
      WHERE project = ?
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e,t)}getAllRecentObservations(e=100){return this.db.prepare(`
      SELECT id, type, title, subtitle, text, project, prompt_number, created_at, created_at_epoch
      FROM observations
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllRecentSummaries(e=50){return this.db.prepare(`
      SELECT id, request, investigated, learned, completed, next_steps,
             files_read, files_edited, notes, project, prompt_number,
             created_at, created_at_epoch
      FROM session_summaries
      ORDER BY created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllRecentUserPrompts(e=100){return this.db.prepare(`
      SELECT
        up.id,
        up.claude_session_id,
        s.project,
        up.prompt_number,
        up.prompt_text,
        up.created_at,
        up.created_at_epoch
      FROM user_prompts up
      LEFT JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      ORDER BY up.created_at_epoch DESC
      LIMIT ?
    `).all(e)}getAllProjects(){return this.db.prepare(`
      SELECT DISTINCT project
      FROM sdk_sessions
      WHERE project IS NOT NULL AND project != ''
      ORDER BY project ASC
    `).all().map(r=>r.project)}getRecentSessionsWithStatus(e,t=3){return this.db.prepare(`
      SELECT * FROM (
        SELECT
          s.sdk_session_id,
          s.status,
          s.started_at,
          s.started_at_epoch,
          s.user_prompt,
          CASE WHEN sum.sdk_session_id IS NOT NULL THEN 1 ELSE 0 END as has_summary
        FROM sdk_sessions s
        LEFT JOIN session_summaries sum ON s.sdk_session_id = sum.sdk_session_id
        WHERE s.project = ? AND s.sdk_session_id IS NOT NULL
        GROUP BY s.sdk_session_id
        ORDER BY s.started_at_epoch DESC
        LIMIT ?
      )
      ORDER BY started_at_epoch ASC
    `).all(e,t)}getObservationsForSession(e){return this.db.prepare(`
      SELECT title, subtitle, type, prompt_number
      FROM observations
      WHERE sdk_session_id = ?
      ORDER BY created_at_epoch ASC
    `).all(e)}getObservationById(e){return this.db.prepare(`
      SELECT *
      FROM observations
      WHERE id = ?
    `).get(e)||R("SessionStore.getObservationById: No observation found",{id:e},null)}getObservationsByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n}=t,o=r==="date_asc"?"ASC":"DESC",i=n?`LIMIT ${n}`:"",a=e.map(()=>"?").join(",");return this.db.prepare(`
      SELECT *
      FROM observations
      WHERE id IN (${a})
      ORDER BY created_at_epoch ${o}
      ${i}
    `).all(...e)}getSummaryForSession(e){return this.db.prepare(`
      SELECT
        request, investigated, learned, completed, next_steps,
        files_read, files_edited, notes, prompt_number, created_at
      FROM session_summaries
      WHERE sdk_session_id = ?
      ORDER BY created_at_epoch DESC
      LIMIT 1
    `).get(e)||R("SessionStore.getSummaryForSession: No summary found",{sdkSessionId:e},null)}getFilesForSession(e){let r=this.db.prepare(`
      SELECT files_read, files_modified
      FROM observations
      WHERE sdk_session_id = ?
    `).all(e),n=new Set,o=new Set;for(let i of r){if(i.files_read)try{let a=JSON.parse(i.files_read);Array.isArray(a)&&a.forEach(c=>n.add(c))}catch{}if(i.files_modified)try{let a=JSON.parse(i.files_modified);Array.isArray(a)&&a.forEach(c=>o.add(c))}catch{}}return{filesRead:Array.from(n),filesModified:Array.from(o)}}getSessionById(e){return this.db.prepare(`
      SELECT id, claude_session_id, sdk_session_id, project, user_prompt
      FROM sdk_sessions
      WHERE id = ?
      LIMIT 1
    `).get(e)||R("SessionStore.getSessionById: No session found",{id:e},null)}findActiveSDKSession(e){return this.db.prepare(`
      SELECT id, sdk_session_id, project, worker_port
      FROM sdk_sessions
      WHERE claude_session_id = ? AND status = 'active'
      LIMIT 1
    `).get(e)||R("SessionStore.findActiveSDKSession: No active session found",{claudeSessionId:e},null)}findAnySDKSession(e){return this.db.prepare(`
      SELECT id
      FROM sdk_sessions
      WHERE claude_session_id = ?
      LIMIT 1
    `).get(e)||R("SessionStore.findAnySDKSession: No session found",{claudeSessionId:e},null)}reactivateSession(e,t){this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'active', user_prompt = ?, worker_port = NULL
      WHERE id = ?
    `).run(t,e)}incrementPromptCounter(e){return this.db.prepare(`
      UPDATE sdk_sessions
      SET prompt_counter = COALESCE(prompt_counter, 0) + 1
      WHERE id = ?
    `).run(e),this.db.prepare(`
      SELECT prompt_counter FROM sdk_sessions WHERE id = ?
    `).get(e)?.prompt_counter||R("SessionStore.incrementPromptCounter: result or prompt_counter is null",{id:e},1)}getPromptCounter(e){return this.db.prepare(`
      SELECT prompt_counter FROM sdk_sessions WHERE id = ?
    `).get(e)?.prompt_counter||R("SessionStore.getPromptCounter: prompt_counter is null",{id:e},0)}createSDKSession(e,t,r){let n=new Date,o=n.getTime(),a=this.db.prepare(`
      INSERT OR IGNORE INTO sdk_sessions
      (claude_session_id, sdk_session_id, project, user_prompt, started_at, started_at_epoch, status)
      VALUES (?, ?, ?, ?, ?, ?, 'active')
    `).run(e,e,t,r,n.toISOString(),o);return a.lastInsertRowid===0||a.changes===0?(t&&t.trim()!==""&&this.db.prepare(`
          UPDATE sdk_sessions
          SET project = ?, user_prompt = ?
          WHERE claude_session_id = ?
        `).run(t,r,e),this.db.prepare(`
        SELECT id FROM sdk_sessions WHERE claude_session_id = ? LIMIT 1
      `).get(e).id):a.lastInsertRowid}updateSDKSessionId(e,t){return this.db.prepare(`
      UPDATE sdk_sessions
      SET sdk_session_id = ?
      WHERE id = ? AND sdk_session_id IS NULL
    `).run(t,e).changes===0?(y.debug("DB","sdk_session_id already set, skipping update",{sessionId:e,sdkSessionId:t}),!1):!0}setWorkerPort(e,t){this.db.prepare(`
      UPDATE sdk_sessions
      SET worker_port = ?
      WHERE id = ?
    `).run(t,e)}getWorkerPort(e){return this.db.prepare(`
      SELECT worker_port
      FROM sdk_sessions
      WHERE id = ?
      LIMIT 1
    `).get(e)?.worker_port||R("SessionStore.getWorkerPort: worker_port is null",{id:e},null)}saveUserPrompt(e,t,r){let n=new Date,o=n.getTime();return this.db.prepare(`
      INSERT INTO user_prompts
      (claude_session_id, prompt_number, prompt_text, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?)
    `).run(e,t,r,n.toISOString(),o).lastInsertRowid}storeObservation(e,t,r,n,o=0){let i=new Date,a=i.getTime();this.db.prepare(`
      SELECT id FROM sdk_sessions WHERE sdk_session_id = ?
    `).get(e)||(this.db.prepare(`
        INSERT INTO sdk_sessions
        (claude_session_id, sdk_session_id, project, started_at, started_at_epoch, status)
        VALUES (?, ?, ?, ?, ?, 'active')
      `).run(e,e,t,i.toISOString(),a),console.error(`[SessionStore] Auto-created session record for session_id: ${e}`));let v=this.db.prepare(`
      INSERT INTO observations
      (sdk_session_id, project, type, title, subtitle, facts, narrative, concepts,
       files_read, files_modified, prompt_number, discovery_tokens, tool_use_id, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e,t,r.type,r.title,r.subtitle,JSON.stringify(r.facts),r.narrative,JSON.stringify(r.concepts),JSON.stringify(r.files_read),JSON.stringify(r.files_modified),n||R("SessionStore.storeObservation: promptNumber is null",{sdkSessionId:e},null),o,r.tool_use_id||R("SessionStore.storeObservation: tool_use_id is null",{sdkSessionId:e},null),i.toISOString(),a);return{id:Number(v.lastInsertRowid),createdAtEpoch:a}}getObservationByToolUseId(e){return this.db.prepare(`
      SELECT * FROM observations
      WHERE tool_use_id = ?
      LIMIT 1
    `).get(e)||R("SessionStore.getObservationByToolUseId: No observation found",{toolUseId:e},null)}getAllObservationsForToolUseId(e){return this.db.prepare(`
      SELECT * FROM observations
      WHERE tool_use_id = ?
      ORDER BY created_at_epoch ASC
    `).all(e)}getObservationsByToolUseIds(e){if(e.length===0)return new Map;let t=e.map(()=>"?").join(","),n=this.db.prepare(`
      SELECT * FROM observations
      WHERE tool_use_id IN (${t})
    `).all(...e),o=new Map;for(let i of n)i.tool_use_id&&o.set(i.tool_use_id,i);return o}storeSummary(e,t,r,n,o=0){let i=new Date,a=i.getTime();this.db.prepare(`
      SELECT id FROM sdk_sessions WHERE sdk_session_id = ?
    `).get(e)||(this.db.prepare(`
        INSERT INTO sdk_sessions
        (claude_session_id, sdk_session_id, project, started_at, started_at_epoch, status)
        VALUES (?, ?, ?, ?, ?, 'active')
      `).run(e,e,t,i.toISOString(),a),console.error(`[SessionStore] Auto-created session record for session_id: ${e}`));let v=this.db.prepare(`
      INSERT INTO session_summaries
      (sdk_session_id, project, request, investigated, learned, completed,
       next_steps, notes, prompt_number, discovery_tokens, created_at, created_at_epoch)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e,t,r.request,r.investigated,r.learned,r.completed,r.next_steps,r.notes,n||R("SessionStore.storeSummary: promptNumber is null",{sdkSessionId:e},null),o,i.toISOString(),a);return{id:Number(v.lastInsertRowid),createdAtEpoch:a}}markSessionCompleted(e){let t=new Date,r=t.getTime();this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'completed', completed_at = ?, completed_at_epoch = ?
      WHERE id = ?
    `).run(t.toISOString(),r,e)}markSessionFailed(e){let t=new Date,r=t.getTime();this.db.prepare(`
      UPDATE sdk_sessions
      SET status = 'failed', completed_at = ?, completed_at_epoch = ?
      WHERE id = ?
    `).run(t.toISOString(),r,e)}getSessionSummariesByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n}=t,o=r==="date_asc"?"ASC":"DESC",i=n?`LIMIT ${n}`:"",a=e.map(()=>"?").join(",");return this.db.prepare(`
      SELECT * FROM session_summaries
      WHERE id IN (${a})
      ORDER BY created_at_epoch ${o}
      ${i}
    `).all(...e)}getUserPromptsByIds(e,t={}){if(e.length===0)return[];let{orderBy:r="date_desc",limit:n}=t,o=r==="date_asc"?"ASC":"DESC",i=n?`LIMIT ${n}`:"",a=e.map(()=>"?").join(",");return this.db.prepare(`
      SELECT
        up.*,
        s.project,
        s.sdk_session_id
      FROM user_prompts up
      JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      WHERE up.id IN (${a})
      ORDER BY up.created_at_epoch ${o}
      ${i}
    `).all(...e)}getTimelineAroundTimestamp(e,t=10,r=10,n){return this.getTimelineAroundObservation(null,e,t,r,n)}getTimelineAroundObservation(e,t,r=10,n=10,o){let i=o?"AND project = ?":"",a=o?[o]:[],c,d;if(e!==null){let x=`
        SELECT id, created_at_epoch
        FROM observations
        WHERE id <= ? ${i}
        ORDER BY id DESC
        LIMIT ?
      `,L=`
        SELECT id, created_at_epoch
        FROM observations
        WHERE id >= ? ${i}
        ORDER BY id ASC
        LIMIT ?
      `;try{let N=this.db.prepare(x).all(e,...a,r+1),b=this.db.prepare(L).all(e,...a,n+1);if(N.length===0&&b.length===0)return{observations:[],sessions:[],prompts:[]};c=N.length>0?N[N.length-1].created_at_epoch:t,d=b.length>0?b[b.length-1].created_at_epoch:t}catch(N){return console.error("[SessionStore] Error getting boundary observations:",N.message),{observations:[],sessions:[],prompts:[]}}}else{let x=`
        SELECT created_at_epoch
        FROM observations
        WHERE created_at_epoch <= ? ${i}
        ORDER BY created_at_epoch DESC
        LIMIT ?
      `,L=`
        SELECT created_at_epoch
        FROM observations
        WHERE created_at_epoch >= ? ${i}
        ORDER BY created_at_epoch ASC
        LIMIT ?
      `;try{let N=this.db.prepare(x).all(t,...a,r),b=this.db.prepare(L).all(t,...a,n+1);if(N.length===0&&b.length===0)return{observations:[],sessions:[],prompts:[]};c=N.length>0?N[N.length-1].created_at_epoch:t,d=b.length>0?b[b.length-1].created_at_epoch:t}catch(N){return console.error("[SessionStore] Error getting boundary timestamps:",N.message),{observations:[],sessions:[],prompts:[]}}}let _=`
      SELECT *
      FROM observations
      WHERE created_at_epoch >= ? AND created_at_epoch <= ? ${i}
      ORDER BY created_at_epoch ASC
    `,v=`
      SELECT *
      FROM session_summaries
      WHERE created_at_epoch >= ? AND created_at_epoch <= ? ${i}
      ORDER BY created_at_epoch ASC
    `,O=`
      SELECT up.*, s.project, s.sdk_session_id
      FROM user_prompts up
      JOIN sdk_sessions s ON up.claude_session_id = s.claude_session_id
      WHERE up.created_at_epoch >= ? AND up.created_at_epoch <= ? ${i.replace("project","s.project")}
      ORDER BY up.created_at_epoch ASC
    `;try{let x=this.db.prepare(_).all(c,d,...a),L=this.db.prepare(v).all(c,d,...a),N=this.db.prepare(O).all(c,d,...a);return{observations:x,sessions:L.map(b=>({id:b.id,sdk_session_id:b.sdk_session_id,project:b.project,request:b.request,completed:b.completed,next_steps:b.next_steps,created_at:b.created_at,created_at_epoch:b.created_at_epoch})),prompts:N.map(b=>({id:b.id,claude_session_id:b.claude_session_id,project:b.project,prompt:b.prompt_text,created_at:b.created_at,created_at_epoch:b.created_at_epoch}))}}catch(x){return console.error("[SessionStore] Error querying timeline records:",x.message),{observations:[],sessions:[],prompts:[]}}}incrementEndlessModeStats(e,t,r){let n=t-r;this.db.prepare(`
      UPDATE sdk_sessions
      SET
        endless_original_tokens = COALESCE(endless_original_tokens, 0) + ?,
        endless_compressed_tokens = COALESCE(endless_compressed_tokens, 0) + ?,
        endless_tokens_saved = COALESCE(endless_tokens_saved, 0) + ?
      WHERE claude_session_id = ?
    `).run(t,r,n,e)}getEndlessModeStats(e){let r=this.db.prepare(`
      SELECT
        endless_original_tokens,
        endless_compressed_tokens,
        endless_tokens_saved
      FROM sdk_sessions
      WHERE claude_session_id = ?
    `).get(e);return r?{originalTokens:r.endless_original_tokens||R("SessionStore.getEndlessModeStats: endless_original_tokens is null",{claudeSessionId:e},0),compressedTokens:r.endless_compressed_tokens||R("SessionStore.getEndlessModeStats: endless_compressed_tokens is null",{claudeSessionId:e},0),tokensSaved:r.endless_tokens_saved||R("SessionStore.getEndlessModeStats: endless_tokens_saved is null",{claudeSessionId:e},0)}:null}close(){this.db.close()}};function es(s,e,t){return s==="PreCompact"?e?{continue:!0,suppressOutput:!0}:{continue:!1,stopReason:t.reason||R("hook-response: options.reason is null",{},"Pre-compact operation failed"),suppressOutput:!0}:s==="SessionStart"?e&&t.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:t.context}}:{continue:!0,suppressOutput:!0}:s==="UserPromptSubmit"||s==="PostToolUse"?{continue:!0,suppressOutput:!0}:s==="Stop"?{continue:!0,suppressOutput:!0}:{continue:e,suppressOutput:!0,...t.reason&&!e?{stopReason:t.reason}:{}}}function X(s,e,t={}){let r=es(s,e,t);return JSON.stringify(r)}import mt from"path";import{homedir as ts}from"os";import{existsSync as ft,readFileSync as ss}from"fs";import{execSync as rs}from"child_process";var ns=100,os=500,is=10;function Re(){try{let s=mt.join(ts(),".claude-mem","settings.json");if(ft(s)){let e=JSON.parse(ss(s,"utf-8")),t=parseInt(e.env?.CLAUDE_MEM_WORKER_PORT,10);if(!isNaN(t))return t}}catch{}return parseInt(process.env.CLAUDE_MEM_WORKER_PORT||"37777",10)}async function _t(){try{let s=Re();return(await fetch(`http://127.0.0.1:${s}/health`,{signal:AbortSignal.timeout(ns)})).ok}catch{return!1}}async function as(){try{let s=ut(),e=mt.join(s,"ecosystem.config.cjs");if(!ft(e))throw new Error(`Ecosystem config not found at ${e}`);rs(`pm2 start "${e}"`,{cwd:s,stdio:"pipe",encoding:"utf-8"});for(let t=0;t<is;t++)if(await new Promise(r=>setTimeout(r,os)),await _t())return!0;return!1}catch{return!1}}async function Be(){if(await _t())return;if(!await as()){let e=Re();throw new Error(`Worker service failed to start on port ${e}.

Try manually running: pm2 start ecosystem.config.cjs
Or restart: pm2 restart claude-mem-worker`)}}import{stdin as Dt}from"process";import{readFileSync as wt,writeFileSync as Hr,renameSync as Wr,copyFileSync as Xr,existsSync as zr,createReadStream as Vr}from"fs";import{dirname as Zr,join as Gr,basename as Kr}from"path";import{createInterface as Yr}from"readline";import{existsSync as cs,readFileSync as ds}from"fs";import{homedir as ls}from"os";import us from"path";function Je(s,e,t){if(s!==void 0){if(typeof s=="boolean")return s;if(typeof s=="string")return s.toLowerCase()==="true"}return e!==void 0?e.toLowerCase()==="true":t}function Qe(s,e,t){if(s!==void 0){if(typeof s=="number")return s;if(typeof s=="string"){let r=parseInt(s,10);if(!isNaN(r))return r}}if(e!==void 0){let r=parseInt(e,10);if(!isNaN(r))return r}return t}function ps(){let s=us.join(ls(),".claude-mem","settings.json"),e={};if(cs(s))try{e=JSON.parse(ds(s,"utf-8"))}catch(d){y.warn("CONFIG","Failed to parse settings.json, using environment/defaults",{},d)}let t=Je(e.env?.CLAUDE_MEM_ENDLESS_MODE,process.env.CLAUDE_MEM_ENDLESS_MODE,!1),r=Je(e.env?.CLAUDE_MEM_TRANSFORM_FALLBACK,process.env.CLAUDE_MEM_TRANSFORM_FALLBACK,!0),n=Qe(e.env?.CLAUDE_MEM_TRANSFORM_TIMEOUT,process.env.CLAUDE_MEM_TRANSFORM_TIMEOUT,500),o=Qe(e.env?.CLAUDE_MEM_TRANSFORM_KEEP_RECENT,process.env.CLAUDE_MEM_TRANSFORM_KEEP_RECENT,0),i=Qe(e.env?.CLAUDE_MEM_ENDLESS_MODE__MAX_TOOL_HISTORY__MB,process.env.CLAUDE_MEM_ENDLESS_MODE__MAX_TOOL_HISTORY__MB,50),a=Je(e.env?.CLAUDE_MEM_ENABLE_SYNCHRONOUS_MODE,process.env.CLAUDE_MEM_ENABLE_SYNCHRONOUS_MODE,t),c={enabled:t,fallbackToOriginal:r,maxLookupTime:n,keepRecentToolUses:o,maxToolHistoryMB:i,enableSynchronousMode:a};return t?y.info("CONFIG","Endless Mode enabled",{fallback:r,maxLookupTime:`${n}ms`,keepRecent:o,maxToolHistoryMB:`${i}MB`,syncMode:a}):y.debug("CONFIG","Endless Mode disabled"),c}var ae=class{static getConfig=ps;static clearCache(){}};import{existsSync as ms,readFileSync as fs,writeFileSync as _s,appendFileSync as hs,statSync as gs}from"fs";import{join as ys}from"path";var je=ys(ke,"tool-outputs.jsonl");function et(s,e,t=Date.now()){xe(ke);let r=typeof e=="string"?e:JSON.stringify(e),n=Buffer.byteLength(r,"utf8"),i=JSON.stringify({tool_use_id:s,content:e,timestamp:t,size_bytes:n})+`
`;hs(je,i,"utf8")}function ht(s){if(!ms(je)||gs(je).size/(1024*1024)<=s)return;let n=fs(je,"utf8").trim().split(`
`).filter(v=>v.length>0),o=[];for(let v of n)try{o.push(JSON.parse(v))}catch{continue}o.sort((v,O)=>v.timestamp-O.timestamp);let i=s*1024*1024,a=0,c=0;for(let v=o.length-1;v>=0;v--){let O=o[v].size_bytes+100;if(a+O>i){c=v+1;break}a+=O}let _=o.slice(c).map(v=>JSON.stringify(v)).join(`
`)+`
`;_s(je,_,"utf8")}var u={};Ht(u,{BRAND:()=>Xs,DIRTY:()=>ce,EMPTY_PATH:()=>bs,INVALID:()=>h,NEVER:()=>Nr,OK:()=>w,ParseStatus:()=>A,Schema:()=>T,ZodAny:()=>re,ZodArray:()=>Q,ZodBigInt:()=>le,ZodBoolean:()=>ue,ZodBranded:()=>$e,ZodCatch:()=>be,ZodDate:()=>pe,ZodDefault:()=>Te,ZodDiscriminatedUnion:()=>Xe,ZodEffects:()=>H,ZodEnum:()=>Ee,ZodError:()=>U,ZodFirstPartyTypeKind:()=>g,ZodFunction:()=>Ve,ZodIntersection:()=>he,ZodIssueCode:()=>l,ZodLazy:()=>ge,ZodLiteral:()=>ye,ZodMap:()=>Le,ZodNaN:()=>Me,ZodNativeEnum:()=>ve,ZodNever:()=>z,ZodNull:()=>fe,ZodNullable:()=>G,ZodNumber:()=>de,ZodObject:()=>j,ZodOptional:()=>P,ZodParsedType:()=>m,ZodPipeline:()=>Pe,ZodPromise:()=>ne,ZodReadonly:()=>Se,ZodRecord:()=>ze,ZodSchema:()=>T,ZodSet:()=>De,ZodString:()=>se,ZodSymbol:()=>Ce,ZodTransformer:()=>H,ZodTuple:()=>Z,ZodType:()=>T,ZodUndefined:()=>me,ZodUnion:()=>_e,ZodUnknown:()=>J,ZodVoid:()=>we,addIssueToContext:()=>p,any:()=>Qs,array:()=>rr,bigint:()=>Gs,boolean:()=>Rt,coerce:()=>Rr,custom:()=>Ot,date:()=>Ks,datetimeRegex:()=>bt,defaultErrorMap:()=>Y,discriminatedUnion:()=>ar,effect:()=>Er,enum:()=>hr,function:()=>mr,getErrorMap:()=>Ne,getParsedType:()=>V,instanceof:()=>Vs,intersection:()=>cr,isAborted:()=>He,isAsync:()=>Ie,isDirty:()=>We,isValid:()=>te,late:()=>zs,lazy:()=>fr,literal:()=>_r,makeIssue:()=>Fe,map:()=>ur,nan:()=>Zs,nativeEnum:()=>gr,never:()=>tr,null:()=>Js,nullable:()=>Tr,number:()=>xt,object:()=>nr,objectUtil:()=>tt,oboolean:()=>xr,onumber:()=>kr,optional:()=>vr,ostring:()=>Or,pipeline:()=>Sr,preprocess:()=>br,promise:()=>yr,quotelessJson:()=>Es,record:()=>lr,set:()=>pr,setErrorMap:()=>Ts,strictObject:()=>or,string:()=>kt,symbol:()=>Ys,transformer:()=>Er,tuple:()=>dr,undefined:()=>qs,union:()=>ir,unknown:()=>er,util:()=>k,void:()=>sr});var k;(function(s){s.assertEqual=n=>{};function e(n){}s.assertIs=e;function t(n){throw new Error}s.assertNever=t,s.arrayToEnum=n=>{let o={};for(let i of n)o[i]=i;return o},s.getValidEnumValues=n=>{let o=s.objectKeys(n).filter(a=>typeof n[n[a]]!="number"),i={};for(let a of o)i[a]=n[a];return s.objectValues(i)},s.objectValues=n=>s.objectKeys(n).map(function(o){return n[o]}),s.objectKeys=typeof Object.keys=="function"?n=>Object.keys(n):n=>{let o=[];for(let i in n)Object.prototype.hasOwnProperty.call(n,i)&&o.push(i);return o},s.find=(n,o)=>{for(let i of n)if(o(i))return i},s.isInteger=typeof Number.isInteger=="function"?n=>Number.isInteger(n):n=>typeof n=="number"&&Number.isFinite(n)&&Math.floor(n)===n;function r(n,o=" | "){return n.map(i=>typeof i=="string"?`'${i}'`:i).join(o)}s.joinValues=r,s.jsonStringifyReplacer=(n,o)=>typeof o=="bigint"?o.toString():o})(k||(k={}));var tt;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(tt||(tt={}));var m=k.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),V=s=>{switch(typeof s){case"undefined":return m.undefined;case"string":return m.string;case"number":return Number.isNaN(s)?m.nan:m.number;case"boolean":return m.boolean;case"function":return m.function;case"bigint":return m.bigint;case"symbol":return m.symbol;case"object":return Array.isArray(s)?m.array:s===null?m.null:s.then&&typeof s.then=="function"&&s.catch&&typeof s.catch=="function"?m.promise:typeof Map<"u"&&s instanceof Map?m.map:typeof Set<"u"&&s instanceof Set?m.set:typeof Date<"u"&&s instanceof Date?m.date:m.object;default:return m.unknown}};var l=k.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Es=s=>JSON.stringify(s,null,2).replace(/"([^"]+)":/g,"$1:"),U=class s extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(o){return o.message},r={_errors:[]},n=o=>{for(let i of o.issues)if(i.code==="invalid_union")i.unionErrors.map(n);else if(i.code==="invalid_return_type")n(i.returnTypeError);else if(i.code==="invalid_arguments")n(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let a=r,c=0;for(;c<i.path.length;){let d=i.path[c];c===i.path.length-1?(a[d]=a[d]||{_errors:[]},a[d]._errors.push(t(i))):a[d]=a[d]||{_errors:[]},a=a[d],c++}}};return n(this),r}static assert(e){if(!(e instanceof s))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,k.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let n of this.issues)if(n.path.length>0){let o=n.path[0];t[o]=t[o]||[],t[o].push(e(n))}else r.push(e(n));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};U.create=s=>new U(s);var vs=(s,e)=>{let t;switch(s.code){case l.invalid_type:s.received===m.undefined?t="Required":t=`Expected ${s.expected}, received ${s.received}`;break;case l.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(s.expected,k.jsonStringifyReplacer)}`;break;case l.unrecognized_keys:t=`Unrecognized key(s) in object: ${k.joinValues(s.keys,", ")}`;break;case l.invalid_union:t="Invalid input";break;case l.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${k.joinValues(s.options)}`;break;case l.invalid_enum_value:t=`Invalid enum value. Expected ${k.joinValues(s.options)}, received '${s.received}'`;break;case l.invalid_arguments:t="Invalid function arguments";break;case l.invalid_return_type:t="Invalid function return type";break;case l.invalid_date:t="Invalid date";break;case l.invalid_string:typeof s.validation=="object"?"includes"in s.validation?(t=`Invalid input: must include "${s.validation.includes}"`,typeof s.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${s.validation.position}`)):"startsWith"in s.validation?t=`Invalid input: must start with "${s.validation.startsWith}"`:"endsWith"in s.validation?t=`Invalid input: must end with "${s.validation.endsWith}"`:k.assertNever(s.validation):s.validation!=="regex"?t=`Invalid ${s.validation}`:t="Invalid";break;case l.too_small:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at least":"more than"} ${s.minimum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at least":"over"} ${s.minimum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="bigint"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(s.minimum))}`:t="Invalid input";break;case l.too_big:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at most":"less than"} ${s.maximum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at most":"under"} ${s.maximum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="bigint"?t=`BigInt must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly":s.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(s.maximum))}`:t="Invalid input";break;case l.custom:t="Invalid input";break;case l.invalid_intersection_types:t="Intersection results could not be merged";break;case l.not_multiple_of:t=`Number must be a multiple of ${s.multipleOf}`;break;case l.not_finite:t="Number must be finite";break;default:t=e.defaultError,k.assertNever(s)}return{message:t}},Y=vs;var gt=Y;function Ts(s){gt=s}function Ne(){return gt}var Fe=s=>{let{data:e,path:t,errorMaps:r,issueData:n}=s,o=[...t,...n.path||[]],i={...n,path:o};if(n.message!==void 0)return{...n,path:o,message:n.message};let a="",c=r.filter(d=>!!d).slice().reverse();for(let d of c)a=d(i,{data:e,defaultError:a}).message;return{...n,path:o,message:a}},bs=[];function p(s,e){let t=Ne(),r=Fe({issueData:e,data:s.data,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,t,t===Y?void 0:Y].filter(n=>!!n)});s.common.issues.push(r)}var A=class s{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let n of t){if(n.status==="aborted")return h;n.status==="dirty"&&e.dirty(),r.push(n.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let n of t){let o=await n.key,i=await n.value;r.push({key:o,value:i})}return s.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let n of t){let{key:o,value:i}=n;if(o.status==="aborted"||i.status==="aborted")return h;o.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),o.value!=="__proto__"&&(typeof i.value<"u"||n.alwaysSet)&&(r[o.value]=i.value)}return{status:e.value,value:r}}},h=Object.freeze({status:"aborted"}),ce=s=>({status:"dirty",value:s}),w=s=>({status:"valid",value:s}),He=s=>s.status==="aborted",We=s=>s.status==="dirty",te=s=>s.status==="valid",Ie=s=>typeof Promise<"u"&&s instanceof Promise;var f;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e?.message})(f||(f={}));var B=class{constructor(e,t,r,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=n}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},yt=(s,e)=>{if(te(e))return{success:!0,data:e.value};if(!s.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new U(s.common.issues);return this._error=t,this._error}}};function E(s){if(!s)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:n}=s;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:n}:{errorMap:(i,a)=>{let{message:c}=s;return i.code==="invalid_enum_value"?{message:c??a.defaultError}:typeof a.data>"u"?{message:c??r??a.defaultError}:i.code!=="invalid_type"?{message:a.defaultError}:{message:c??t??a.defaultError}},description:n}}var T=class{get description(){return this._def.description}_getType(e){return V(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:V(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new A,ctx:{common:e.parent.common,data:e.data,parsedType:V(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(Ie(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){let r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:V(e)},n=this._parseSync({data:e,path:r.path,parent:r});return yt(r,n)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:V(e)};if(!this["~standard"].async)try{let r=this._parseSync({data:e,path:[],parent:t});return te(r)?{value:r.value}:{issues:t.common.issues}}catch(r){r?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(r=>te(r)?{value:r.value}:{issues:t.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:V(e)},n=this._parse({data:e,path:r.path,parent:r}),o=await(Ie(n)?n:Promise.resolve(n));return yt(r,o)}refine(e,t){let r=n=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(n):t;return this._refinement((n,o)=>{let i=e(n),a=()=>o.addIssue({code:l.custom,...r(n)});return typeof Promise<"u"&&i instanceof Promise?i.then(c=>c?!0:(a(),!1)):i?!0:(a(),!1)})}refinement(e,t){return this._refinement((r,n)=>e(r)?!0:(n.addIssue(typeof t=="function"?t(r,n):t),!1))}_refinement(e){return new H({schema:this,typeName:g.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return P.create(this,this._def)}nullable(){return G.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Q.create(this)}promise(){return ne.create(this,this._def)}or(e){return _e.create([this,e],this._def)}and(e){return he.create(this,e,this._def)}transform(e){return new H({...E(this._def),schema:this,typeName:g.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new Te({...E(this._def),innerType:this,defaultValue:t,typeName:g.ZodDefault})}brand(){return new $e({typeName:g.ZodBranded,type:this,...E(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new be({...E(this._def),innerType:this,catchValue:t,typeName:g.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Pe.create(this,e)}readonly(){return Se.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Ss=/^c[^\s-]{8,}$/i,Os=/^[0-9a-z]+$/,ks=/^[0-9A-HJKMNP-TV-Z]{26}$/i,xs=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Rs=/^[a-z0-9_-]{21}$/i,Ns=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Is=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,As=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Cs="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",st,ws=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ls=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Ds=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ms=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Us=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,js=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,vt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Fs=new RegExp(`^${vt}$`);function Tt(s){let e="[0-5]\\d";s.precision?e=`${e}\\.\\d{${s.precision}}`:s.precision==null&&(e=`${e}(\\.\\d+)?`);let t=s.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function $s(s){return new RegExp(`^${Tt(s)}$`)}function bt(s){let e=`${vt}T${Tt(s)}`,t=[];return t.push(s.local?"Z?":"Z"),s.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Ps(s,e){return!!((e==="v4"||!e)&&ws.test(s)||(e==="v6"||!e)&&Ds.test(s))}function Bs(s,e){if(!Ns.test(s))return!1;try{let[t]=s.split(".");if(!t)return!1;let r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),n=JSON.parse(atob(r));return!(typeof n!="object"||n===null||"typ"in n&&n?.typ!=="JWT"||!n.alg||e&&n.alg!==e)}catch{return!1}}function Hs(s,e){return!!((e==="v4"||!e)&&Ls.test(s)||(e==="v6"||!e)&&Ms.test(s))}var se=class s extends T{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==m.string){let o=this._getOrReturnCtx(e);return p(o,{code:l.invalid_type,expected:m.string,received:o.parsedType}),h}let r=new A,n;for(let o of this._def.checks)if(o.kind==="min")e.data.length<o.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:l.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),r.dirty());else if(o.kind==="max")e.data.length>o.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:l.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),r.dirty());else if(o.kind==="length"){let i=e.data.length>o.value,a=e.data.length<o.value;(i||a)&&(n=this._getOrReturnCtx(e,n),i?p(n,{code:l.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}):a&&p(n,{code:l.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}),r.dirty())}else if(o.kind==="email")As.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"email",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="emoji")st||(st=new RegExp(Cs,"u")),st.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"emoji",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="uuid")xs.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"uuid",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="nanoid")Rs.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"nanoid",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="cuid")Ss.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cuid",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="cuid2")Os.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cuid2",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="ulid")ks.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"ulid",code:l.invalid_string,message:o.message}),r.dirty());else if(o.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),p(n,{validation:"url",code:l.invalid_string,message:o.message}),r.dirty()}else o.kind==="regex"?(o.regex.lastIndex=0,o.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"regex",code:l.invalid_string,message:o.message}),r.dirty())):o.kind==="trim"?e.data=e.data.trim():o.kind==="includes"?e.data.includes(o.value,o.position)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:{includes:o.value,position:o.position},message:o.message}),r.dirty()):o.kind==="toLowerCase"?e.data=e.data.toLowerCase():o.kind==="toUpperCase"?e.data=e.data.toUpperCase():o.kind==="startsWith"?e.data.startsWith(o.value)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:{startsWith:o.value},message:o.message}),r.dirty()):o.kind==="endsWith"?e.data.endsWith(o.value)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:{endsWith:o.value},message:o.message}),r.dirty()):o.kind==="datetime"?bt(o).test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:"datetime",message:o.message}),r.dirty()):o.kind==="date"?Fs.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:"date",message:o.message}),r.dirty()):o.kind==="time"?$s(o).test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:l.invalid_string,validation:"time",message:o.message}),r.dirty()):o.kind==="duration"?Is.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"duration",code:l.invalid_string,message:o.message}),r.dirty()):o.kind==="ip"?Ps(e.data,o.version)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"ip",code:l.invalid_string,message:o.message}),r.dirty()):o.kind==="jwt"?Bs(e.data,o.alg)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"jwt",code:l.invalid_string,message:o.message}),r.dirty()):o.kind==="cidr"?Hs(e.data,o.version)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cidr",code:l.invalid_string,message:o.message}),r.dirty()):o.kind==="base64"?Us.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"base64",code:l.invalid_string,message:o.message}),r.dirty()):o.kind==="base64url"?js.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"base64url",code:l.invalid_string,message:o.message}),r.dirty()):k.assertNever(o);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(n=>e.test(n),{validation:t,code:l.invalid_string,...f.errToObj(r)})}_addCheck(e){return new s({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...f.errToObj(e)})}url(e){return this._addCheck({kind:"url",...f.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...f.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...f.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...f.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...f.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...f.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...f.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...f.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...f.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...f.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...f.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...f.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...f.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...f.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...f.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...f.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...f.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...f.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...f.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...f.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...f.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...f.errToObj(t)})}nonempty(e){return this.min(1,f.errToObj(e))}trim(){return new s({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new s({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new s({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};se.create=s=>new se({checks:[],typeName:g.ZodString,coerce:s?.coerce??!1,...E(s)});function Ws(s,e){let t=(s.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,n=t>r?t:r,o=Number.parseInt(s.toFixed(n).replace(".","")),i=Number.parseInt(e.toFixed(n).replace(".",""));return o%i/10**n}var de=class s extends T{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==m.number){let o=this._getOrReturnCtx(e);return p(o,{code:l.invalid_type,expected:m.number,received:o.parsedType}),h}let r,n=new A;for(let o of this._def.checks)o.kind==="int"?k.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{code:l.invalid_type,expected:"integer",received:"float",message:o.message}),n.dirty()):o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.too_small,minimum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.too_big,maximum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="multipleOf"?Ws(e.data,o.value)!==0&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):o.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),p(r,{code:l.not_finite,message:o.message}),n.dirty()):k.assertNever(o);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,f.toString(t))}gt(e,t){return this.setLimit("min",e,!1,f.toString(t))}lte(e,t){return this.setLimit("max",e,!0,f.toString(t))}lt(e,t){return this.setLimit("max",e,!1,f.toString(t))}setLimit(e,t,r,n){return new s({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:f.toString(n)}]})}_addCheck(e){return new s({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:f.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:f.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:f.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:f.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:f.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:f.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:f.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:f.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:f.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&k.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};de.create=s=>new de({checks:[],typeName:g.ZodNumber,coerce:s?.coerce||!1,...E(s)});var le=class s extends T{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==m.bigint)return this._getInvalidInput(e);let r,n=new A;for(let o of this._def.checks)o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.too_small,type:"bigint",minimum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.too_big,type:"bigint",maximum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="multipleOf"?e.data%o.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),p(r,{code:l.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):k.assertNever(o);return{status:n.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return p(t,{code:l.invalid_type,expected:m.bigint,received:t.parsedType}),h}gte(e,t){return this.setLimit("min",e,!0,f.toString(t))}gt(e,t){return this.setLimit("min",e,!1,f.toString(t))}lte(e,t){return this.setLimit("max",e,!0,f.toString(t))}lt(e,t){return this.setLimit("max",e,!1,f.toString(t))}setLimit(e,t,r,n){return new s({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:f.toString(n)}]})}_addCheck(e){return new s({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:f.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:f.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:f.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:f.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:f.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};le.create=s=>new le({checks:[],typeName:g.ZodBigInt,coerce:s?.coerce??!1,...E(s)});var ue=class extends T{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==m.boolean){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.boolean,received:r.parsedType}),h}return w(e.data)}};ue.create=s=>new ue({typeName:g.ZodBoolean,coerce:s?.coerce||!1,...E(s)});var pe=class s extends T{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==m.date){let o=this._getOrReturnCtx(e);return p(o,{code:l.invalid_type,expected:m.date,received:o.parsedType}),h}if(Number.isNaN(e.data.getTime())){let o=this._getOrReturnCtx(e);return p(o,{code:l.invalid_date}),h}let r=new A,n;for(let o of this._def.checks)o.kind==="min"?e.data.getTime()<o.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:l.too_small,message:o.message,inclusive:!0,exact:!1,minimum:o.value,type:"date"}),r.dirty()):o.kind==="max"?e.data.getTime()>o.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:l.too_big,message:o.message,inclusive:!0,exact:!1,maximum:o.value,type:"date"}),r.dirty()):k.assertNever(o);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new s({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:f.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:f.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};pe.create=s=>new pe({checks:[],coerce:s?.coerce||!1,typeName:g.ZodDate,...E(s)});var Ce=class extends T{_parse(e){if(this._getType(e)!==m.symbol){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.symbol,received:r.parsedType}),h}return w(e.data)}};Ce.create=s=>new Ce({typeName:g.ZodSymbol,...E(s)});var me=class extends T{_parse(e){if(this._getType(e)!==m.undefined){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.undefined,received:r.parsedType}),h}return w(e.data)}};me.create=s=>new me({typeName:g.ZodUndefined,...E(s)});var fe=class extends T{_parse(e){if(this._getType(e)!==m.null){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.null,received:r.parsedType}),h}return w(e.data)}};fe.create=s=>new fe({typeName:g.ZodNull,...E(s)});var re=class extends T{constructor(){super(...arguments),this._any=!0}_parse(e){return w(e.data)}};re.create=s=>new re({typeName:g.ZodAny,...E(s)});var J=class extends T{constructor(){super(...arguments),this._unknown=!0}_parse(e){return w(e.data)}};J.create=s=>new J({typeName:g.ZodUnknown,...E(s)});var z=class extends T{_parse(e){let t=this._getOrReturnCtx(e);return p(t,{code:l.invalid_type,expected:m.never,received:t.parsedType}),h}};z.create=s=>new z({typeName:g.ZodNever,...E(s)});var we=class extends T{_parse(e){if(this._getType(e)!==m.undefined){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.void,received:r.parsedType}),h}return w(e.data)}};we.create=s=>new we({typeName:g.ZodVoid,...E(s)});var Q=class s extends T{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),n=this._def;if(t.parsedType!==m.array)return p(t,{code:l.invalid_type,expected:m.array,received:t.parsedType}),h;if(n.exactLength!==null){let i=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(i||a)&&(p(t,{code:i?l.too_big:l.too_small,minimum:a?n.exactLength.value:void 0,maximum:i?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(n.minLength!==null&&t.data.length<n.minLength.value&&(p(t,{code:l.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),n.maxLength!==null&&t.data.length>n.maxLength.value&&(p(t,{code:l.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,a)=>n.type._parseAsync(new B(t,i,t.path,a)))).then(i=>A.mergeArray(r,i));let o=[...t.data].map((i,a)=>n.type._parseSync(new B(t,i,t.path,a)));return A.mergeArray(r,o)}get element(){return this._def.type}min(e,t){return new s({...this._def,minLength:{value:e,message:f.toString(t)}})}max(e,t){return new s({...this._def,maxLength:{value:e,message:f.toString(t)}})}length(e,t){return new s({...this._def,exactLength:{value:e,message:f.toString(t)}})}nonempty(e){return this.min(1,e)}};Q.create=(s,e)=>new Q({type:s,minLength:null,maxLength:null,exactLength:null,typeName:g.ZodArray,...E(e)});function Ae(s){if(s instanceof j){let e={};for(let t in s.shape){let r=s.shape[t];e[t]=P.create(Ae(r))}return new j({...s._def,shape:()=>e})}else return s instanceof Q?new Q({...s._def,type:Ae(s.element)}):s instanceof P?P.create(Ae(s.unwrap())):s instanceof G?G.create(Ae(s.unwrap())):s instanceof Z?Z.create(s.items.map(e=>Ae(e))):s}var j=class s extends T{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=k.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==m.object){let d=this._getOrReturnCtx(e);return p(d,{code:l.invalid_type,expected:m.object,received:d.parsedType}),h}let{status:r,ctx:n}=this._processInputParams(e),{shape:o,keys:i}=this._getCached(),a=[];if(!(this._def.catchall instanceof z&&this._def.unknownKeys==="strip"))for(let d in n.data)i.includes(d)||a.push(d);let c=[];for(let d of i){let _=o[d],v=n.data[d];c.push({key:{status:"valid",value:d},value:_._parse(new B(n,v,n.path,d)),alwaysSet:d in n.data})}if(this._def.catchall instanceof z){let d=this._def.unknownKeys;if(d==="passthrough")for(let _ of a)c.push({key:{status:"valid",value:_},value:{status:"valid",value:n.data[_]}});else if(d==="strict")a.length>0&&(p(n,{code:l.unrecognized_keys,keys:a}),r.dirty());else if(d!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let d=this._def.catchall;for(let _ of a){let v=n.data[_];c.push({key:{status:"valid",value:_},value:d._parse(new B(n,v,n.path,_)),alwaysSet:_ in n.data})}}return n.common.async?Promise.resolve().then(async()=>{let d=[];for(let _ of c){let v=await _.key,O=await _.value;d.push({key:v,value:O,alwaysSet:_.alwaysSet})}return d}).then(d=>A.mergeObjectSync(r,d)):A.mergeObjectSync(r,c)}get shape(){return this._def.shape()}strict(e){return f.errToObj,new s({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{let n=this._def.errorMap?.(t,r).message??r.defaultError;return t.code==="unrecognized_keys"?{message:f.errToObj(e).message??n}:{message:n}}}:{}})}strip(){return new s({...this._def,unknownKeys:"strip"})}passthrough(){return new s({...this._def,unknownKeys:"passthrough"})}extend(e){return new s({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new s({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:g.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new s({...this._def,catchall:e})}pick(e){let t={};for(let r of k.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new s({...this._def,shape:()=>t})}omit(e){let t={};for(let r of k.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new s({...this._def,shape:()=>t})}deepPartial(){return Ae(this)}partial(e){let t={};for(let r of k.objectKeys(this.shape)){let n=this.shape[r];e&&!e[r]?t[r]=n:t[r]=n.optional()}return new s({...this._def,shape:()=>t})}required(e){let t={};for(let r of k.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let o=this.shape[r];for(;o instanceof P;)o=o._def.innerType;t[r]=o}return new s({...this._def,shape:()=>t})}keyof(){return St(k.objectKeys(this.shape))}};j.create=(s,e)=>new j({shape:()=>s,unknownKeys:"strip",catchall:z.create(),typeName:g.ZodObject,...E(e)});j.strictCreate=(s,e)=>new j({shape:()=>s,unknownKeys:"strict",catchall:z.create(),typeName:g.ZodObject,...E(e)});j.lazycreate=(s,e)=>new j({shape:s,unknownKeys:"strip",catchall:z.create(),typeName:g.ZodObject,...E(e)});var _e=class extends T{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function n(o){for(let a of o)if(a.result.status==="valid")return a.result;for(let a of o)if(a.result.status==="dirty")return t.common.issues.push(...a.ctx.common.issues),a.result;let i=o.map(a=>new U(a.ctx.common.issues));return p(t,{code:l.invalid_union,unionErrors:i}),h}if(t.common.async)return Promise.all(r.map(async o=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await o._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(n);{let o,i=[];for(let c of r){let d={...t,common:{...t.common,issues:[]},parent:null},_=c._parseSync({data:t.data,path:t.path,parent:d});if(_.status==="valid")return _;_.status==="dirty"&&!o&&(o={result:_,ctx:d}),d.common.issues.length&&i.push(d.common.issues)}if(o)return t.common.issues.push(...o.ctx.common.issues),o.result;let a=i.map(c=>new U(c));return p(t,{code:l.invalid_union,unionErrors:a}),h}}get options(){return this._def.options}};_e.create=(s,e)=>new _e({options:s,typeName:g.ZodUnion,...E(e)});var q=s=>s instanceof ge?q(s.schema):s instanceof H?q(s.innerType()):s instanceof ye?[s.value]:s instanceof Ee?s.options:s instanceof ve?k.objectValues(s.enum):s instanceof Te?q(s._def.innerType):s instanceof me?[void 0]:s instanceof fe?[null]:s instanceof P?[void 0,...q(s.unwrap())]:s instanceof G?[null,...q(s.unwrap())]:s instanceof $e||s instanceof Se?q(s.unwrap()):s instanceof be?q(s._def.innerType):[],Xe=class s extends T{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==m.object)return p(t,{code:l.invalid_type,expected:m.object,received:t.parsedType}),h;let r=this.discriminator,n=t.data[r],o=this.optionsMap.get(n);return o?t.common.async?o._parseAsync({data:t.data,path:t.path,parent:t}):o._parseSync({data:t.data,path:t.path,parent:t}):(p(t,{code:l.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),h)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let n=new Map;for(let o of t){let i=q(o.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let a of i){if(n.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);n.set(a,o)}}return new s({typeName:g.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:n,...E(r)})}};function rt(s,e){let t=V(s),r=V(e);if(s===e)return{valid:!0,data:s};if(t===m.object&&r===m.object){let n=k.objectKeys(e),o=k.objectKeys(s).filter(a=>n.indexOf(a)!==-1),i={...s,...e};for(let a of o){let c=rt(s[a],e[a]);if(!c.valid)return{valid:!1};i[a]=c.data}return{valid:!0,data:i}}else if(t===m.array&&r===m.array){if(s.length!==e.length)return{valid:!1};let n=[];for(let o=0;o<s.length;o++){let i=s[o],a=e[o],c=rt(i,a);if(!c.valid)return{valid:!1};n.push(c.data)}return{valid:!0,data:n}}else return t===m.date&&r===m.date&&+s==+e?{valid:!0,data:s}:{valid:!1}}var he=class extends T{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),n=(o,i)=>{if(He(o)||He(i))return h;let a=rt(o.value,i.value);return a.valid?((We(o)||We(i))&&t.dirty(),{status:t.value,value:a.data}):(p(r,{code:l.invalid_intersection_types}),h)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([o,i])=>n(o,i)):n(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};he.create=(s,e,t)=>new he({left:s,right:e,typeName:g.ZodIntersection,...E(t)});var Z=class s extends T{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m.array)return p(r,{code:l.invalid_type,expected:m.array,received:r.parsedType}),h;if(r.data.length<this._def.items.length)return p(r,{code:l.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),h;!this._def.rest&&r.data.length>this._def.items.length&&(p(r,{code:l.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let o=[...r.data].map((i,a)=>{let c=this._def.items[a]||this._def.rest;return c?c._parse(new B(r,i,r.path,a)):null}).filter(i=>!!i);return r.common.async?Promise.all(o).then(i=>A.mergeArray(t,i)):A.mergeArray(t,o)}get items(){return this._def.items}rest(e){return new s({...this._def,rest:e})}};Z.create=(s,e)=>{if(!Array.isArray(s))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Z({items:s,typeName:g.ZodTuple,rest:null,...E(e)})};var ze=class s extends T{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m.object)return p(r,{code:l.invalid_type,expected:m.object,received:r.parsedType}),h;let n=[],o=this._def.keyType,i=this._def.valueType;for(let a in r.data)n.push({key:o._parse(new B(r,a,r.path,a)),value:i._parse(new B(r,r.data[a],r.path,a)),alwaysSet:a in r.data});return r.common.async?A.mergeObjectAsync(t,n):A.mergeObjectSync(t,n)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof T?new s({keyType:e,valueType:t,typeName:g.ZodRecord,...E(r)}):new s({keyType:se.create(),valueType:e,typeName:g.ZodRecord,...E(t)})}},Le=class extends T{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m.map)return p(r,{code:l.invalid_type,expected:m.map,received:r.parsedType}),h;let n=this._def.keyType,o=this._def.valueType,i=[...r.data.entries()].map(([a,c],d)=>({key:n._parse(new B(r,a,r.path,[d,"key"])),value:o._parse(new B(r,c,r.path,[d,"value"]))}));if(r.common.async){let a=new Map;return Promise.resolve().then(async()=>{for(let c of i){let d=await c.key,_=await c.value;if(d.status==="aborted"||_.status==="aborted")return h;(d.status==="dirty"||_.status==="dirty")&&t.dirty(),a.set(d.value,_.value)}return{status:t.value,value:a}})}else{let a=new Map;for(let c of i){let d=c.key,_=c.value;if(d.status==="aborted"||_.status==="aborted")return h;(d.status==="dirty"||_.status==="dirty")&&t.dirty(),a.set(d.value,_.value)}return{status:t.value,value:a}}}};Le.create=(s,e,t)=>new Le({valueType:e,keyType:s,typeName:g.ZodMap,...E(t)});var De=class s extends T{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==m.set)return p(r,{code:l.invalid_type,expected:m.set,received:r.parsedType}),h;let n=this._def;n.minSize!==null&&r.data.size<n.minSize.value&&(p(r,{code:l.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),n.maxSize!==null&&r.data.size>n.maxSize.value&&(p(r,{code:l.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());let o=this._def.valueType;function i(c){let d=new Set;for(let _ of c){if(_.status==="aborted")return h;_.status==="dirty"&&t.dirty(),d.add(_.value)}return{status:t.value,value:d}}let a=[...r.data.values()].map((c,d)=>o._parse(new B(r,c,r.path,d)));return r.common.async?Promise.all(a).then(c=>i(c)):i(a)}min(e,t){return new s({...this._def,minSize:{value:e,message:f.toString(t)}})}max(e,t){return new s({...this._def,maxSize:{value:e,message:f.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};De.create=(s,e)=>new De({valueType:s,minSize:null,maxSize:null,typeName:g.ZodSet,...E(e)});var Ve=class s extends T{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==m.function)return p(t,{code:l.invalid_type,expected:m.function,received:t.parsedType}),h;function r(a,c){return Fe({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ne(),Y].filter(d=>!!d),issueData:{code:l.invalid_arguments,argumentsError:c}})}function n(a,c){return Fe({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ne(),Y].filter(d=>!!d),issueData:{code:l.invalid_return_type,returnTypeError:c}})}let o={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof ne){let a=this;return w(async function(...c){let d=new U([]),_=await a._def.args.parseAsync(c,o).catch(x=>{throw d.addIssue(r(c,x)),d}),v=await Reflect.apply(i,this,_);return await a._def.returns._def.type.parseAsync(v,o).catch(x=>{throw d.addIssue(n(v,x)),d})})}else{let a=this;return w(function(...c){let d=a._def.args.safeParse(c,o);if(!d.success)throw new U([r(c,d.error)]);let _=Reflect.apply(i,this,d.data),v=a._def.returns.safeParse(_,o);if(!v.success)throw new U([n(_,v.error)]);return v.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new s({...this._def,args:Z.create(e).rest(J.create())})}returns(e){return new s({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new s({args:e||Z.create([]).rest(J.create()),returns:t||J.create(),typeName:g.ZodFunction,...E(r)})}},ge=class extends T{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};ge.create=(s,e)=>new ge({getter:s,typeName:g.ZodLazy,...E(e)});var ye=class extends T{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return p(t,{received:t.data,code:l.invalid_literal,expected:this._def.value}),h}return{status:"valid",value:e.data}}get value(){return this._def.value}};ye.create=(s,e)=>new ye({value:s,typeName:g.ZodLiteral,...E(e)});function St(s,e){return new Ee({values:s,typeName:g.ZodEnum,...E(e)})}var Ee=class s extends T{_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return p(t,{expected:k.joinValues(r),received:t.parsedType,code:l.invalid_type}),h}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return p(t,{received:t.data,code:l.invalid_enum_value,options:r}),h}return w(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return s.create(e,{...this._def,...t})}exclude(e,t=this._def){return s.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}};Ee.create=St;var ve=class extends T{_parse(e){let t=k.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==m.string&&r.parsedType!==m.number){let n=k.objectValues(t);return p(r,{expected:k.joinValues(n),received:r.parsedType,code:l.invalid_type}),h}if(this._cache||(this._cache=new Set(k.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let n=k.objectValues(t);return p(r,{received:r.data,code:l.invalid_enum_value,options:n}),h}return w(e.data)}get enum(){return this._def.values}};ve.create=(s,e)=>new ve({values:s,typeName:g.ZodNativeEnum,...E(e)});var ne=class extends T{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==m.promise&&t.common.async===!1)return p(t,{code:l.invalid_type,expected:m.promise,received:t.parsedType}),h;let r=t.parsedType===m.promise?t.data:Promise.resolve(t.data);return w(r.then(n=>this._def.type.parseAsync(n,{path:t.path,errorMap:t.common.contextualErrorMap})))}};ne.create=(s,e)=>new ne({type:s,typeName:g.ZodPromise,...E(e)});var H=class extends T{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===g.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),n=this._def.effect||null,o={addIssue:i=>{p(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(o.addIssue=o.addIssue.bind(o),n.type==="preprocess"){let i=n.transform(r.data,o);if(r.common.async)return Promise.resolve(i).then(async a=>{if(t.value==="aborted")return h;let c=await this._def.schema._parseAsync({data:a,path:r.path,parent:r});return c.status==="aborted"?h:c.status==="dirty"?ce(c.value):t.value==="dirty"?ce(c.value):c});{if(t.value==="aborted")return h;let a=this._def.schema._parseSync({data:i,path:r.path,parent:r});return a.status==="aborted"?h:a.status==="dirty"?ce(a.value):t.value==="dirty"?ce(a.value):a}}if(n.type==="refinement"){let i=a=>{let c=n.refinement(a,o);if(r.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return a};if(r.common.async===!1){let a=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?h:(a.status==="dirty"&&t.dirty(),i(a.value),{status:t.value,value:a.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(a=>a.status==="aborted"?h:(a.status==="dirty"&&t.dirty(),i(a.value).then(()=>({status:t.value,value:a.value}))))}if(n.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!te(i))return h;let a=n.transform(i.value,o);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>te(i)?Promise.resolve(n.transform(i.value,o)).then(a=>({status:t.value,value:a})):h);k.assertNever(n)}};H.create=(s,e,t)=>new H({schema:s,typeName:g.ZodEffects,effect:e,...E(t)});H.createWithPreprocess=(s,e,t)=>new H({schema:e,effect:{type:"preprocess",transform:s},typeName:g.ZodEffects,...E(t)});var P=class extends T{_parse(e){return this._getType(e)===m.undefined?w(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};P.create=(s,e)=>new P({innerType:s,typeName:g.ZodOptional,...E(e)});var G=class extends T{_parse(e){return this._getType(e)===m.null?w(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};G.create=(s,e)=>new G({innerType:s,typeName:g.ZodNullable,...E(e)});var Te=class extends T{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===m.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};Te.create=(s,e)=>new Te({innerType:s,typeName:g.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...E(e)});var be=class extends T{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Ie(n)?n.then(o=>({status:"valid",value:o.status==="valid"?o.value:this._def.catchValue({get error(){return new U(r.common.issues)},input:r.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new U(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};be.create=(s,e)=>new be({innerType:s,typeName:g.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...E(e)});var Me=class extends T{_parse(e){if(this._getType(e)!==m.nan){let r=this._getOrReturnCtx(e);return p(r,{code:l.invalid_type,expected:m.nan,received:r.parsedType}),h}return{status:"valid",value:e.data}}};Me.create=s=>new Me({typeName:g.ZodNaN,...E(s)});var Xs=Symbol("zod_brand"),$e=class extends T{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},Pe=class s extends T{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let o=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?h:o.status==="dirty"?(t.dirty(),ce(o.value)):this._def.out._parseAsync({data:o.value,path:r.path,parent:r})})();{let n=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return n.status==="aborted"?h:n.status==="dirty"?(t.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:r.path,parent:r})}}static create(e,t){return new s({in:e,out:t,typeName:g.ZodPipeline})}},Se=class extends T{_parse(e){let t=this._def.innerType._parse(e),r=n=>(te(n)&&(n.value=Object.freeze(n.value)),n);return Ie(t)?t.then(n=>r(n)):r(t)}unwrap(){return this._def.innerType}};Se.create=(s,e)=>new Se({innerType:s,typeName:g.ZodReadonly,...E(e)});function Et(s,e){let t=typeof s=="function"?s(e):typeof s=="string"?{message:s}:s;return typeof t=="string"?{message:t}:t}function Ot(s,e={},t){return s?re.create().superRefine((r,n)=>{let o=s(r);if(o instanceof Promise)return o.then(i=>{if(!i){let a=Et(e,r),c=a.fatal??t??!0;n.addIssue({code:"custom",...a,fatal:c})}});if(!o){let i=Et(e,r),a=i.fatal??t??!0;n.addIssue({code:"custom",...i,fatal:a})}}):re.create()}var zs={object:j.lazycreate},g;(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(g||(g={}));var Vs=(s,e={message:`Input not instance of ${s.name}`})=>Ot(t=>t instanceof s,e),kt=se.create,xt=de.create,Zs=Me.create,Gs=le.create,Rt=ue.create,Ks=pe.create,Ys=Ce.create,qs=me.create,Js=fe.create,Qs=re.create,er=J.create,tr=z.create,sr=we.create,rr=Q.create,nr=j.create,or=j.strictCreate,ir=_e.create,ar=Xe.create,cr=he.create,dr=Z.create,lr=ze.create,ur=Le.create,pr=De.create,mr=Ve.create,fr=ge.create,_r=ye.create,hr=Ee.create,gr=ve.create,yr=ne.create,Er=H.create,vr=P.create,Tr=G.create,br=H.createWithPreprocess,Sr=Pe.create,Or=()=>kt().optional(),kr=()=>xt().optional(),xr=()=>Rt().optional(),Rr={string:(s=>se.create({...s,coerce:!0})),number:(s=>de.create({...s,coerce:!0})),boolean:(s=>ue.create({...s,coerce:!0})),bigint:(s=>le.create({...s,coerce:!0})),date:(s=>pe.create({...s,coerce:!0}))};var Nr=h;var Nt=u.object({type:u.literal("text"),text:u.string()}),Ir=u.object({type:u.literal("thinking"),thinking:u.string(),signature:u.string().optional()}),Ar=u.object({type:u.literal("tool_use"),id:u.string(),name:u.string(),input:u.record(u.any())}),It=u.object({type:u.literal("tool_result"),tool_use_id:u.string(),content:u.union([u.string(),u.array(u.record(u.any()))]),is_error:u.boolean().optional()}),Cr=u.object({type:u.literal("image"),source:u.object({type:u.literal("base64"),media_type:u.string(),data:u.string()})}),wr=u.union([Ir,Nt,Ar,It]),Lr=u.object({id:u.string(),container:u.null().optional(),type:u.literal("message"),role:u.literal("assistant"),model:u.string(),content:u.array(wr),stop_reason:u.string().nullable(),stop_sequence:u.string().nullable(),usage:u.object({input_tokens:u.number(),cache_creation_input_tokens:u.number().optional(),cache_read_input_tokens:u.number().optional(),cache_creation:u.object({ephemeral_5m_input_tokens:u.number(),ephemeral_1h_input_tokens:u.number()}).optional(),output_tokens:u.number(),service_tier:u.string().nullable().optional(),server_tool_use:u.object({web_search_requests:u.number()}).optional()})}),Dr=u.union([Nt,It,Cr]),Mr=u.object({role:u.literal("user"),content:u.union([u.string(),u.array(Dr)])}),nt=u.object({isSidechain:u.boolean(),userType:u.enum(["external"]),cwd:u.string(),sessionId:u.string(),version:u.string(),uuid:u.string().uuid(),timestamp:u.string(),parentUuid:u.string().uuid().nullable(),isMeta:u.boolean().optional(),toolUseResult:u.unknown().optional(),gitBranch:u.string().optional(),isCompactSummary:u.boolean().optional()}),At=nt.extend({type:u.literal("assistant"),message:Lr,requestId:u.string().optional(),isApiErrorMessage:u.boolean().optional()}),Ur=nt.extend({type:u.literal("user"),message:Mr,toolUseResult:u.unknown().optional()}),jr=u.object({type:u.literal("summary"),summary:u.string(),leafUuid:u.string(),cwd:u.string().optional()}),Fr=nt.extend({type:u.literal("system"),content:u.string(),level:u.string().optional()}),$r=u.object({type:u.literal("queue-operation"),operation:u.enum(["enqueue","dequeue"]),timestamp:u.string(),sessionId:u.string(),content:u.array(u.any()).optional()}),So=u.union([Ur,At,jr,Fr,$r]);function Pr(s){try{return{success:!0,data:At.parse(s)}}catch(e){if(e instanceof u.ZodError)return{success:!1,error:e};throw e}}function Br(s){return s.issues.map(e=>`${e.path.join(".")}: ${e.message}`).join("; ")}function Ct(s,e="AssistantEntry"){let t=Pr(s);return t.success?(y.debug("VALIDATOR",`Valid ${e}`,{entry:s}),!0):(y.error("VALIDATOR",`Invalid ${e}`,{errors:Br(t.error),entry:s}),!1)}var qr=new Set(["ListMcpResourcesTool","SlashCommand","Skill","TodoWrite","AskUserQuestion"]);function Ze(s,e){if(!s)return[];if(Array.isArray(s))return s;try{let t=JSON.parse(s);return Array.isArray(t)?t:[]}catch(t){return y.debug("HOOK",`Failed to parse ${e}`,{field:s,error:t}),[]}}function Jr(s){let e=[];e.push(`## ${s.title}`),s.subtitle&&e.push(s.subtitle),s.narrative&&e.push(s.narrative);let t=Ze(s.facts,"facts");t.length>0&&e.push(`Facts: ${t.join("; ")}`);let r=Ze(s.concepts,"concepts");r.length>0&&e.push(`Concepts: ${r.join(", ")}`);let n=Ze(s.files_read,"files_read");n.length>0&&e.push(`Files read: ${n.join(", ")}`);let o=Ze(s.files_modified,"files_modified");return o.length>0&&e.push(`Files modified: ${o.join(", ")}`),e.join(`

`)}async function Qr(s){let e=new Set;try{let t=Vr(s),r=Yr({input:t,crlfDelay:1/0});for await(let i of r)if(i.includes("agentId"))try{let a=JSON.parse(i);a.toolUseResult?.agentId&&e.add(a.toolUseResult.agentId)}catch{}let n=Zr(s),o=Array.from(e).map(i=>Gr(n,`agent-${i}.jsonl`)).filter(i=>zr(i));return y.debug("HOOK","Discovered agent transcripts",{agentCount:e.size,filesFound:o.length,agentFiles:o.map(i=>Kr(i))}),o}catch(t){return y.warn("HOOK","Failed to discover agent files",{mainTranscriptPath:s},t),[]}}async function Mt(s,e,t=[]){let r=await Qr(s),n=await Lt(s,e,t),o=0,i=0;for(let a of r)try{let c=await Lt(a,e,[]);o+=c.originalTokens,i+=c.compressedTokens}catch(c){y.warn("HOOK","Failed to transform agent transcript",{agentFile:a},c)}return{originalTokens:n.originalTokens+o,compressedTokens:n.compressedTokens+i}}async function Lt(s,e,t=[]){try{xe(ke);let S=pt(s);Xr(s,S),y.info("HOOK","Created transcript backup",{original:s,backup:S})}catch(S){throw y.error("HOOK","Failed to create transcript backup",{transcriptPath:s},S),new Error("Backup creation failed - aborting transformation for safety")}let n=wt(s,"utf-8").trim().split(`
`),o={totalOriginalSize:0,totalCompressedSize:0,transformCount:0},i=new ie,a=i.getAllObservationsForToolUseId(e);if(a.length===0)return i.close(),y.debug("HOOK","No observations found for rolling replacement",{toolUseId:e}),{originalTokens:0,compressedTokens:0};let c=new Set(t);c.add(e),y.info("HOOK","Rolling replacement scope",{toolUseId:e,cycleSize:c.size,observationCount:a.length});let d=a.map(S=>Jr(S)).join(`

`),_=null;for(let S of n)if(S.trim())try{let C=JSON.parse(S);if(C.type==="assistant"){_=C;break}}catch{continue}if(!_)throw i.close(),y.error("HOOK","No assistant entry found in transcript to use as template",{transcriptPath:s}),new Error("Cannot create replacement message without template");let v={..._,message:{..._.message,content:[{type:"text",text:d}]}};if(!Ct(v,"Replacement assistant message"))throw i.close(),y.error("HOOK","Created invalid assistant message - aborting transformation",{toolUseId:e,transcriptPath:s}),new Error("Generated assistant message failed schema validation");let O=d.length,x=new Set,L=new Set,N=new Set;for(let S of n)if(S.trim())try{let C=JSON.parse(S);if(C.type==="assistant"&&Array.isArray(C.message?.content)){for(let I of C.message.content)if(I.type==="tool_use"){let ee=I;ee.id&&c.has(ee.id)&&L.add(ee.id)}}if(C.type==="user"&&Array.isArray(C.message?.content)){for(let I of C.message.content)if(I.type==="tool_result"){let ee=I;ee.tool_use_id&&c.has(ee.tool_use_id)&&N.add(ee.tool_use_id)}}}catch{continue}for(let S of c)L.has(S)&&N.has(S)&&x.add(S);if(y.info("HOOK","Validated tool pairs for replacement",{requestedIds:c.size,validatedIds:x.size,toolUseOnly:Array.from(L).filter(S=>!N.has(S)),toolResultOnly:Array.from(N).filter(S=>!L.has(S))}),x.size===0)return i.close(),y.debug("HOOK","No complete tool_use/tool_result pairs found for replacement",{toolUseId:e}),{originalTokens:0,compressedTokens:0};let b=[],D=!1,$=-1,W=0,oe=!1;for(let S=0;S<n.length;S++){let C=n[S];if(!C.trim()){b.push(C);continue}try{let I=JSON.parse(C);if(I.type==="assistant"&&Array.isArray(I.message?.content)){let Oe=I;for(let Ue of Oe.message.content)if(Ue.type==="tool_use"){let F=Ue;if(F.id&&x.has(F.id)){D||(D=!0,$=S,y.debug("HOOK","Replacement zone start",{toolUseId:F.id,lineIndex:S}));try{et(F.id,JSON.stringify(F.input),Date.now())}catch(ct){y.warn("HOOK","Failed to backup original tool input",{toolUseId:F.id},ct)}W+=C.length,oe=!0;break}}if(D&&oe)continue}if(I.type==="user"&&Array.isArray(I.message?.content)&&oe){let Oe=I;for(let Ue of Oe.message.content)if(Ue.type==="tool_result"){let F=Ue;if(F.tool_use_id&&x.has(F.tool_use_id)){try{et(F.tool_use_id,JSON.stringify(F.content),Date.now())}catch(Pt){y.warn("HOOK","Failed to backup original tool output",{toolUseId:F.tool_use_id},Pt)}W+=C.length,F.tool_use_id===e&&(b.push(JSON.stringify(v)),D=!1,oe=!1,o.totalOriginalSize+=W,o.totalCompressedSize+=O,o.transformCount++,y.success("HOOK","Rolling replacement complete",{zoneStart:$,zoneEnd:S,toolsReplaced:x.size,originalSize:W,compressedSize:O,savings:`${Math.round((1-O/W)*100)}%`}));continue}}}(!D||!oe)&&((Oe=>!!(Oe.toolUseID&&x.has(Oe.toolUseID)))(I)?y.debug("HOOK","Skipping entry with reference to deleted tool_use_id",{toolUseID:I.toolUseID,entryType:I.type}):b.push(C))}catch(I){throw y.warn("HOOK","Malformed JSONL line in transcript",{lineIndex:S,error:I}),new Error(`Malformed JSONL line at index ${S}: ${I.message}`)}}i.close();let Ge=`${s}.tmp`;Hr(Ge,b.join(`
`)+`
`,"utf-8");let jt=wt(Ge,"utf-8").trim().split(`
`);for(let S of jt)S.trim()&&JSON.parse(S);Wr(Ge,s);let at=4,Ft=Math.ceil(o.totalOriginalSize/at),$t=Math.ceil(o.totalCompressedSize/at);y.success("HOOK","Transcript transformation complete",{toolUseId:e,transformCount:o.transformCount,totalOriginalSize:o.totalOriginalSize,totalCompressedSize:o.totalCompressedSize,savings:o.totalOriginalSize>0?`${Math.round((1-o.totalCompressedSize/o.totalOriginalSize)*100)}%`:"0%"});try{let S=ae.getConfig();S.maxToolHistoryMB>0&&(ht(S.maxToolHistoryMB),y.debug("HOOK","Trimmed tool output backup",{maxSizeMB:S.maxToolHistoryMB}))}catch(S){y.warn("HOOK","Failed to trim tool output backup",{},S)}return{originalTokens:Ft,compressedTokens:$t}}async function en(s){s||(y.warn("HOOK","PostToolUse called with no input"),console.log(X("PostToolUse",!0)),process.exit(0));let{session_id:e,cwd:t,tool_name:r,tool_input:n,tool_response:o,transcript_path:i,tool_use_id:a}=s;qr.has(r)&&(console.log(X("PostToolUse",!0)),process.exit(0)),await Be();let c=new ie,d=c.createSDKSession(e,"",""),_=c.getPromptCounter(d);c.close();let v=y.formatTool(r,n),O=Re(),x=a;x||(y.warn("HOOK","No tool_use_id provided - skipping observation",{toolName:r}),console.log(X("PostToolUse",!0)),process.exit(0)),y.dataIn("HOOK",`PostToolUse: ${v}`,{sessionDbId:d,claudeSessionId:e,workerPort:O,toolUseId:x});let L=ae.getConfig(),N=i?.includes("/agent-")||!1,b=!!(L.enabled&&x&&i&&!N);y.debug("HOOK","Endless Mode check",{enabled:L.enabled,hasToolUseId:!!x,toolUseId:x,isSubagent:N,willWaitSynchronously:b});try{let D=b?parseInt(process.env.CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS||(R("CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS not set, using default 90000ms"),"90000"),10):2e3,$=await fetch(`http://127.0.0.1:${O}/sessions/${d}/observations?wait_until_obs_is_saved=${b}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tool_name:r,tool_input:n!==void 0?JSON.stringify(n):"{}",tool_response:o!==void 0?JSON.stringify(o):"{}",prompt_number:_,cwd:t||R("save-hook: cwd missing",{sessionDbId:d,tool_name:r}),tool_use_id:x,transcript_path:i||R("save-hook: transcript_path missing",{sessionDbId:d,tool_name:r})}),signal:AbortSignal.timeout(D)});if(!$.ok){let oe=await $.text();y.failure("HOOK","Failed to send observation",{sessionDbId:d,status:$.status},oe),console.log(X("PostToolUse",!0)),process.exit(0)}let W=await $.json();W.status==="completed"?console.log("[save-hook] \u2705 Observation created, transcript transformed"):W.status==="skipped"?console.log("[save-hook] \u23ED\uFE0F  No observation needed, continuing"):W.status==="timeout"&&console.warn(`[save-hook] \u23F1\uFE0F  Timeout after ${D}ms - processing async`),y.debug("HOOK","Observation sent successfully",{sessionDbId:d,toolName:r,mode:b?"synchronous (Endless Mode)":"async"})}catch(D){if(D.cause?.code==="ECONNREFUSED"){let $="Worker connection failed. Try: pm2 restart claude-mem-worker";y.failure("HOOK","Worker connection refused",{sessionDbId:d},D),console.error(`[save-hook] ${$}`),console.log(X("PostToolUse",!1,{reason:$})),process.exit(2)}console.warn("[save-hook] \u274C Failed to send observation:",D.message),y.warn("HOOK","Observation request failed - continuing anyway",{sessionDbId:d,toolName:r,error:D.message}),console.log(X("PostToolUse",!0)),process.exit(0)}console.log(X("PostToolUse",!0)),process.exit(0)}var ot="";Dt.on("data",s=>ot+=s);Dt.on("end",async()=>{try{let s=ot?JSON.parse(ot):void 0;await en(s)}catch(s){console.error(`[save-hook] Unhandled error: ${s.message}`),console.log(X("PostToolUse",!1,{reason:s.message})),process.exit(1)}});async function sn(s){if(!s)throw new Error("newHook requires input");let{session_id:e,cwd:t,prompt:r,transcript_path:n}=s;R("[new-hook] Input received",{session_id:e,cwd:t,cwd_type:typeof t,cwd_length:t?.length,has_cwd:!!t,prompt_length:r?.length});let o=tn.basename(t);R("[new-hook] Project extracted",{project:o,project_type:typeof o,project_length:o?.length,is_empty:o==="",cwd_was:t}),await Be();let i=new ie,a=i.createSDKSession(e,o,r),c=i.incrementPromptCounter(a);if(i.saveUserPrompt(e,c,r),console.error(`[new-hook] Session ${a}, prompt #${c}`),i.close(),ae.getConfig().enabled&&n)try{y.info("HOOK","\u{1F504} Batch transforming transcript at UserPromptSubmit",{transcriptPath:n});let O=await Mt(n,`user-prompt-${c}`);y.success("HOOK","\u2705 Batch transformation complete",{originalTokens:O.originalTokens,compressedTokens:O.compressedTokens,savings:`${Math.round((1-O.compressedTokens/O.originalTokens)*100)}%`})}catch(O){y.warn("HOOK","Batch transformation failed - continuing anyway",{transcriptPath:n},O)}let _=Re(),v=r.startsWith("/")?r.substring(1):r;try{let O=await fetch(`http://127.0.0.1:${_}/sessions/${a}/init`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project:o,userPrompt:v,promptNumber:c}),signal:AbortSignal.timeout(5e3)});if(!O.ok){let x=await O.text();throw new Error(`Failed to initialize session: ${O.status} ${x}`)}}catch(O){throw O.cause?.code==="ECONNREFUSED"||O.name==="TimeoutError"||O.message.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):O}console.log(X("UserPromptSubmit",!0))}var it="";Ut.on("data",s=>it+=s);Ut.on("end",async()=>{let s=it?JSON.parse(it):void 0;await sn(s)});
