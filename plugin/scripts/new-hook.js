#!/usr/bin/env node
import W from"path";import{stdin as E}from"process";function D(t,e,r){return t==="PreCompact"?e?{continue:!0,suppressOutput:!0}:{continue:!1,stopReason:r.reason||"Pre-compact operation failed",suppressOutput:!0}:t==="SessionStart"?e&&r.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:r.context}}:{continue:!0,suppressOutput:!0}:t==="UserPromptSubmit"||t==="PostToolUse"?{continue:!0,suppressOutput:!0}:t==="Stop"?{continue:!0,suppressOutput:!0}:{continue:e,suppressOutput:!0,...r.reason&&!e?{stopReason:r.reason}:{}}}function h(t,e,r={}){let s=D(t,e,r);return JSON.stringify(s)}import S from"path";import{homedir as I}from"os";import{existsSync as w,readFileSync as A}from"fs";import{spawnSync as C}from"child_process";import{join as n,dirname as P,basename as B}from"path";import{homedir as _}from"os";import{fileURLToPath as O}from"url";function b(){return typeof __dirname<"u"?__dirname:P(O(import.meta.url))}var T=b(),a=process.env.CLAUDE_MEM_DATA_DIR||n(_(),".claude-mem"),f=process.env.CLAUDE_CONFIG_DIR||n(_(),".claude"),z=n(a,"archives"),Q=n(a,"logs"),X=n(a,"trash"),Y=n(a,"backups"),Z=n(a,"settings.json"),tt=n(a,"claude-mem.db"),et=n(a,"vector-db"),rt=n(f,"settings.json"),ot=n(f,"commands"),nt=n(f,"CLAUDE.md");function g(){return n(T,"..","..")}var H=100,U=500,$=10;function m(){try{let t=S.join(I(),".claude-mem","settings.json");if(w(t)){let e=JSON.parse(A(t,"utf-8")),r=parseInt(e.env?.CLAUDE_MEM_WORKER_PORT,10);if(!isNaN(r))return r}}catch{}return parseInt(process.env.CLAUDE_MEM_WORKER_PORT||"37777",10)}async function k(){try{let t=m();return(await fetch(`http://127.0.0.1:${t}/health`,{signal:AbortSignal.timeout(H)})).ok}catch{return!1}}async function v(){try{let t=g(),e=S.join(t,"ecosystem.config.cjs");if(!w(e))throw new Error(`Ecosystem config not found at ${e}`);let r=S.join(t,"node_modules",".bin","pm2"),s=process.platform==="win32"?r+".cmd":r,p=w(s)?s:"pm2",c=C(p,["start",e],{cwd:t,stdio:"pipe",encoding:"utf-8",windowsHide:!0});if(c.status!==0)throw new Error(c.stderr||"PM2 start failed");for(let o=0;o<$;o++)if(await new Promise(i=>setTimeout(i,U)),await k())return!0;return!1}catch{return!1}}async function y(){if(await k())return;if(!await v()){let e=m(),r=g();throw new Error(`Worker service failed to start on port ${e}.

To start manually, run:
  cd ${r}
  npx pm2 start ecosystem.config.cjs

If already running, try: npx pm2 restart claude-mem-worker`)}}import{appendFileSync as L}from"fs";import{homedir as N}from"os";import{join as j}from"path";var M=j(N(),".claude-mem","silent.log");function x(t,e,r=""){let s=new Date().toISOString(),i=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),l=i?`${i[1].split("/").pop()}:${i[2]}`:"unknown",u=`[${s}] [${l}] ${t}`;if(e!==void 0)try{u+=` ${JSON.stringify(e)}`}catch(d){u+=` [stringify error: ${d}]`}u+=`
`;try{L(M,u)}catch(d){console.error("[silent-debug] Failed to write to log:",d)}return r}async function F(t){if(!t)throw new Error("newHook requires input");let{session_id:e,cwd:r,prompt:s}=t;x("[new-hook] Input received",{session_id:e,cwd:r,prompt_length:s?.length});let p=W.basename(r);await y();let c=m();try{let o=await fetch(`http://127.0.0.1:${c}/api/sessions/init`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:e,project:p,userPrompt:s}),signal:AbortSignal.timeout(5e3)});if(!o.ok){let l=await o.text();throw new Error(`Failed to initialize session: ${o.status} ${l}`)}let i=await o.json();console.error(`[new-hook] Session ${i.sessionDbId}, prompt #${i.promptNumber}`)}catch(o){throw o.cause?.code==="ECONNREFUSED"||o.name==="TimeoutError"||o.message.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):o}console.log(h("UserPromptSubmit",!0))}var R="";E.on("data",t=>R+=t);E.on("end",async()=>{let t=R?JSON.parse(R):void 0;await F(t)});
