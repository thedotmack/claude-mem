#!/usr/bin/env node
import{stdin as w}from"process";import{readFileSync as Z}from"fs";import{homedir as tt}from"os";import et from"path";function x(n,t,o){return n==="PreCompact"?t?{continue:!0,suppressOutput:!0}:{continue:!1,stopReason:o.reason||"Pre-compact operation failed",suppressOutput:!0}:n==="SessionStart"?t&&o.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:o.context}}:{continue:!0,suppressOutput:!0}:n==="UserPromptSubmit"||n==="PostToolUse"?{continue:!0,suppressOutput:!0}:n==="Stop"?{continue:!0,suppressOutput:!0}:{continue:t,suppressOutput:!0,...o.reason&&!t?{stopReason:o.reason}:{}}}function m(n,t,o={}){let e=x(n,t,o);return JSON.stringify(e)}var O=(s=>(s[s.DEBUG=0]="DEBUG",s[s.INFO=1]="INFO",s[s.WARN=2]="WARN",s[s.ERROR=3]="ERROR",s[s.SILENT=4]="SILENT",s))(O||{}),T=class{level;useColor;constructor(){let t=process.env.CLAUDE_MEM_LOG_LEVEL?.toUpperCase()||"INFO";this.level=O[t]??1,this.useColor=process.stdout.isTTY??!1}correlationId(t,o){return`obs-${t}-${o}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.level===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let o=Object.keys(t);return o.length===0?"{}":o.length<=3?JSON.stringify(t):`{${o.length} keys: ${o.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,o){if(!o)return t;try{let e=typeof o=="string"?JSON.parse(o):o;if(t==="Bash"&&e.command){let r=e.command.length>50?e.command.substring(0,50)+"...":e.command;return`${t}(${r})`}if(t==="Read"&&e.file_path){let r=e.file_path.split("/").pop()||e.file_path;return`${t}(${r})`}if(t==="Edit"&&e.file_path){let r=e.file_path.split("/").pop()||e.file_path;return`${t}(${r})`}if(t==="Write"&&e.file_path){let r=e.file_path.split("/").pop()||e.file_path;return`${t}(${r})`}return t}catch{return t}}log(t,o,e,r,s){if(t<this.level)return;let i=new Date().toISOString().replace("T"," ").substring(0,23),a=O[t].padEnd(5),l=o.padEnd(6),g="";r?.correlationId?g=`[${r.correlationId}] `:r?.sessionId&&(g=`[session-${r.sessionId}] `);let f="";s!=null&&(this.level===0&&typeof s=="object"?f=`
`+JSON.stringify(s,null,2):f=" "+this.formatData(s));let c="";if(r){let{sessionId:it,sdkSessionId:at,correlationId:ct,...D}=r;Object.keys(D).length>0&&(c=` {${Object.entries(D).map(([b,k])=>`${b}=${k}`).join(", ")}}`)}let E=`[${i}] [${a}] [${l}] ${g}${e}${c}${f}`;t===3?console.error(E):console.log(E)}debug(t,o,e,r){this.log(0,t,o,e,r)}info(t,o,e,r){this.log(1,t,o,e,r)}warn(t,o,e,r){this.log(2,t,o,e,r)}error(t,o,e,r){this.log(3,t,o,e,r)}dataIn(t,o,e,r){this.info(t,`\u2192 ${o}`,e,r)}dataOut(t,o,e,r){this.info(t,`\u2190 ${o}`,e,r)}success(t,o,e,r){this.info(t,`\u2713 ${o}`,e,r)}failure(t,o,e,r){this.error(t,`\u2717 ${o}`,e,r)}timing(t,o,e,r){this.info(t,`\u23F1 ${o}`,r,{duration:`${e}ms`})}},p=new T;import M from"path";import{homedir as X}from"os";import{spawnSync as V}from"child_process";import{join as u,dirname as P,basename as Et}from"path";import{homedir as y}from"os";import{fileURLToPath as $}from"url";function H(){return typeof __dirname<"u"?__dirname:P($(import.meta.url))}var W=H(),_=process.env.CLAUDE_MEM_DATA_DIR||u(y(),".claude-mem"),C=process.env.CLAUDE_CONFIG_DIR||u(y(),".claude"),St=u(_,"archives"),dt=u(_,"logs"),Ot=u(_,"trash"),Tt=u(_,"backups"),Ct=u(_,"settings.json"),At=u(_,"claude-mem.db"),Mt=u(_,"vector-db"),ht=u(C,"settings.json"),Dt=u(C,"commands"),yt=u(C,"CLAUDE.md");function A(){return u(W,"..","..")}import{readFileSync as B,existsSync as K}from"fs";var F=["bugfix","feature","refactor","discovery","decision","change"],j=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var R=F.join(","),N=j.join(",");var S=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:R,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:N,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_ENDLESS_MODE:"false",CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS:"90000"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return process.env[t]||this.DEFAULTS[t]}static getInt(t){let o=this.get(t);return parseInt(o,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){if(!K(t))return this.getAllDefaults();let o=B(t,"utf-8"),r=JSON.parse(o).env||{},s={...this.DEFAULTS};for(let i of Object.keys(this.DEFAULTS))r[i]!==void 0&&(s[i]=r[i]);return s}};var G=100,J=500,Y=10;function d(){let n=M.join(X(),".claude-mem","settings.json"),t=S.loadFromFile(n);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function L(){try{let n=d();return(await fetch(`http://127.0.0.1:${n}/health`,{signal:AbortSignal.timeout(G)})).ok}catch{return!1}}async function q(){try{let n=A(),t=M.join(n,"ecosystem.config.cjs");if(!existsSync(t))throw new Error(`Ecosystem config not found at ${t}`);let o=M.join(n,"node_modules",".bin","pm2"),e=process.platform==="win32"?o+".cmd":o,r=existsSync(e)?e:"pm2",s=V(r,["start",t],{cwd:n,stdio:"pipe",encoding:"utf-8",windowsHide:!0});if(s.status!==0)throw new Error(s.stderr||"PM2 start failed");for(let i=0;i<Y;i++)if(await new Promise(a=>setTimeout(a,J)),await L())return!0;return!1}catch{return!1}}async function U(){if(await L())return;if(!await q()){let t=d(),o=A();throw new Error(`Worker service failed to start on port ${t}.

To start manually, run:
  cd ${o}
  npx pm2 start ecosystem.config.cjs

If already running, try: npx pm2 restart claude-mem-worker`)}}import{readFile as Q,writeFile as z}from"fs/promises";async function I(n,t){let o=0;try{let e=await Q(n,"utf-8"),r=JSON.parse(e),s=!1;for(let i of r)if(!(!i.content||!Array.isArray(i.content))){for(let a of i.content)if(a.type==="tool_use"&&a.id===t&&a.input&&Object.keys(a.input).length>0){let l=JSON.stringify(a.input);o=Math.floor(l.length/4),a.input={},s=!0}}s&&await z(n,JSON.stringify(r,null,2),"utf-8")}catch(e){console.error(`Failed to clear tool input in transcript: ${e.message}`)}return o}function v(n){let o={decision:"\u2696\uFE0F",bugfix:"\u{1F534}",feature:"\u{1F7E3}",refactor:"\u{1F504}",discovery:"\u{1F535}",change:"\u2705"}[n.type]||"\u{1F4DD}",e=`**#${n.id}** ${o} **${n.title||"Observation"}**

`;if(n.subtitle&&(e+=`${n.subtitle}

`),n.narrative&&(e+=`${n.narrative}

`),n.facts)try{let i=JSON.parse(n.facts);i.length>0&&(e+=`**Facts:**
${i.map(a=>`- ${a}`).join(`
`)}

`)}catch{}if(n.concepts)try{let i=JSON.parse(n.concepts);i.length>0&&(e+=`**Concepts:** ${i.join(", ")}

`)}catch{}let r=n.files_read?JSON.parse(n.files_read):[],s=n.files_modified?JSON.parse(n.files_modified):[];return(r.length>0||s.length>0)&&(e+=`**Files:**
`,r.length>0&&(e+=`- Read: ${r.join(", ")}
`),s.length>0&&(e+=`- Modified: ${s.join(", ")}
`),e+=`
`),e+=`Read: ~${Math.ceil((n.text?.length||0)/4)}, Work: \u{1F50D} ${n.discovery_tokens}`,e.trim()}var ot=new Set(["ListMcpResourcesTool","SlashCommand","Skill","TodoWrite","AskUserQuestion"]);function nt(){try{let n=et.join(tt(),".claude-mem","settings.json"),t=Z(n,"utf-8"),e=JSON.parse(t).env||{};return{enabled:e.CLAUDE_MEM_ENDLESS_MODE==="true",waitTimeoutMs:parseInt(e.CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS||"90000",10)}}catch{return{enabled:!1,waitTimeoutMs:9e4}}}async function rt(n,t,o){let e=Date.now(),r=500;for(;Date.now()-e<o;){try{let s=await fetch(`http://127.0.0.1:${n}/api/sessions/observations-for-tool-use/${t}`,{signal:AbortSignal.timeout(2e3)});if(s.ok){let i=await s.json();if(i.observations&&i.observations.length>0)return i.observations}}catch{}await new Promise(s=>setTimeout(s,r))}return[]}async function st(n){if(!n)throw new Error("saveHook requires input");let{session_id:t,transcript_path:o,cwd:e,tool_name:r,tool_input:s,tool_response:i,tool_use_id:a}=n;if(ot.has(r)){console.log(m("PostToolUse",!0));return}await U();let l=d(),g=p.formatTool(r,s);p.dataIn("HOOK",`PostToolUse: ${g}`,{workerPort:l});try{let c=await fetch(`http://127.0.0.1:${l}/api/sessions/observations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,tool_name:r,tool_input:s,tool_response:i,cwd:e||"",toolUseId:a}),signal:AbortSignal.timeout(2e3)});if(!c.ok){let E=await c.text();throw p.failure("HOOK","Failed to send observation",{status:c.status},E),new Error(`Failed to send observation to worker: ${c.status} ${E}`)}p.debug("HOOK","Observation sent successfully",{toolName:r})}catch(c){throw c.cause?.code==="ECONNREFUSED"||c.name==="TimeoutError"||c.message.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):c}let f=nt();if(!f.enabled||!a||!o){console.log(m("PostToolUse",!0));return}try{p.debug("HOOK","Endless Mode: waiting for observations",{toolUseId:a,timeoutMs:f.waitTimeoutMs});let c=await rt(l,a,f.waitTimeoutMs);if(c.length===0){p.debug("HOOK","Endless Mode: no observations found (timeout)",{toolUseId:a}),console.log(m("PostToolUse",!0));return}p.debug("HOOK","Endless Mode: observations retrieved",{toolUseId:a,count:c.length}),await I(o,a);let E=c.map(v).join(`

---

`);console.log(JSON.stringify({hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:E}}))}catch(c){p.failure("HOOK","Endless Mode error (falling back to normal)",{toolUseId:a},c.message),console.log(m("PostToolUse",!0))}}var h="";w.on("data",n=>h+=n);w.on("end",async()=>{let n=h?JSON.parse(h):void 0;await st(n)});
