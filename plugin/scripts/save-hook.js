#!/usr/bin/env node
import{stdin as Ct}from"process";import{readFileSync as Bt}from"fs";import{homedir as Gt}from"os";import Kt from"path";var j=class extends Error{constructor(t,n){super(t),this.name="ParseError",this.type=n.type,this.field=n.field,this.value=n.value,this.line=n.line}};function J(e){}function pt(e){if(typeof e=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");let{onEvent:t=J,onError:n=J,onRetry:o=J,onComment:s}=e,r="",i=!0,c,d="",E="";function f(l){let p=i?l.replace(/^\xEF\xBB\xBF/,""):l,[D,k]=yt(`${r}${p}`);for(let P of D)_(P);r=k,i=!1}function _(l){if(l===""){y();return}if(l.startsWith(":")){s&&s(l.slice(l.startsWith(": ")?2:1));return}let p=l.indexOf(":");if(p!==-1){let D=l.slice(0,p),k=l[p+1]===" "?2:1,P=l.slice(p+k);C(D,P,l);return}C(l,"",l)}function C(l,p,D){switch(l){case"event":E=p;break;case"data":d=`${d}${p}
`;break;case"id":c=p.includes("\0")?void 0:p;break;case"retry":/^\d+$/.test(p)?o(parseInt(p,10)):n(new j(`Invalid \`retry\` value: "${p}"`,{type:"invalid-retry",value:p,line:D}));break;default:n(new j(`Unknown field "${l.length>20?`${l.slice(0,20)}\u2026`:l}"`,{type:"unknown-field",field:l,value:p,line:D}));break}}function y(){d.length>0&&t({id:c,event:E||void 0,data:d.endsWith(`
`)?d.slice(0,-1):d}),c=void 0,d="",E=""}function w(l={}){r&&l.consume&&_(r),i=!0,c=void 0,d="",E="",r=""}return{feed:f,reset:w}}function yt(e){let t=[],n="",o=0;for(;o<e.length;){let s=e.indexOf("\r",o),r=e.indexOf(`
`,o),i=-1;if(s!==-1&&r!==-1?i=Math.min(s,r):s!==-1?s===e.length-1?i=-1:i=s:r!==-1&&(i=r),i===-1){n=e.slice(o);break}else{let c=e.slice(o,i);t.push(c),o=i+1,e[o-1]==="\r"&&e[o]===`
`&&o++}}return[t,n]}var G=class extends Event{constructor(t,n){var o,s;super(t),this.code=(o=n?.code)!=null?o:void 0,this.message=(s=n?.message)!=null?s:void 0}[Symbol.for("nodejs.util.inspect.custom")](t,n,o){return o(ft(this),n)}[Symbol.for("Deno.customInspect")](t,n){return t(ft(this),n)}};function vt(e){let t=globalThis.DOMException;return typeof t=="function"?new t(e,"SyntaxError"):new SyntaxError(e)}function Y(e){return e instanceof Error?"errors"in e&&Array.isArray(e.errors)?e.errors.map(Y).join(", "):"cause"in e&&e.cause instanceof Error?`${e}: ${Y(e.cause)}`:e.message:`${e}`}function ft(e){return{type:e.type,message:e.message,code:e.code,defaultPrevented:e.defaultPrevented,cancelable:e.cancelable,timeStamp:e.timeStamp}}var ht=e=>{throw TypeError(e)},ot=(e,t,n)=>t.has(e)||ht("Cannot "+n),a=(e,t,n)=>(ot(e,t,"read from private field"),n?n.call(e):t.get(e)),h=(e,t,n)=>t.has(e)?ht("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),u=(e,t,n,o)=>(ot(e,t,"write to private field"),t.set(e,n),n),T=(e,t,n)=>(ot(e,t,"access private method"),n),g,N,L,B,K,H,b,F,v,U,x,I,$,S,q,Q,z,dt,Z,tt,W,et,nt,M=class extends EventTarget{constructor(t,n){var o,s;super(),h(this,S),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,h(this,g),h(this,N),h(this,L),h(this,B),h(this,K),h(this,H),h(this,b),h(this,F,null),h(this,v),h(this,U),h(this,x,null),h(this,I,null),h(this,$,null),h(this,Q,async r=>{var i;a(this,U).reset();let{body:c,redirected:d,status:E,headers:f}=r;if(E===204){T(this,S,W).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(d?u(this,L,new URL(r.url)):u(this,L,void 0),E!==200){T(this,S,W).call(this,`Non-200 status code (${E})`,E);return}if(!(f.get("content-type")||"").startsWith("text/event-stream")){T(this,S,W).call(this,'Invalid content type, expected "text/event-stream"',E);return}if(a(this,g)===this.CLOSED)return;u(this,g,this.OPEN);let _=new Event("open");if((i=a(this,$))==null||i.call(this,_),this.dispatchEvent(_),typeof c!="object"||!c||!("getReader"in c)){T(this,S,W).call(this,"Invalid response body, expected a web ReadableStream",E),this.close();return}let C=new TextDecoder,y=c.getReader(),w=!0;do{let{done:l,value:p}=await y.read();p&&a(this,U).feed(C.decode(p,{stream:!l})),l&&(w=!1,a(this,U).reset(),T(this,S,et).call(this))}while(w)}),h(this,z,r=>{u(this,v,void 0),!(r.name==="AbortError"||r.type==="aborted")&&T(this,S,et).call(this,Y(r))}),h(this,Z,r=>{typeof r.id=="string"&&u(this,F,r.id);let i=new MessageEvent(r.event||"message",{data:r.data,origin:a(this,L)?a(this,L).origin:a(this,N).origin,lastEventId:r.id||""});a(this,I)&&(!r.event||r.event==="message")&&a(this,I).call(this,i),this.dispatchEvent(i)}),h(this,tt,r=>{u(this,H,r)}),h(this,nt,()=>{u(this,b,void 0),a(this,g)===this.CONNECTING&&T(this,S,q).call(this)});try{if(t instanceof URL)u(this,N,t);else if(typeof t=="string")u(this,N,new URL(t,Mt()));else throw new Error("Invalid URL")}catch{throw vt("An invalid or illegal string was specified")}u(this,U,pt({onEvent:a(this,Z),onRetry:a(this,tt)})),u(this,g,this.CONNECTING),u(this,H,3e3),u(this,K,(o=n?.fetch)!=null?o:globalThis.fetch),u(this,B,(s=n?.withCredentials)!=null?s:!1),T(this,S,q).call(this)}get readyState(){return a(this,g)}get url(){return a(this,N).href}get withCredentials(){return a(this,B)}get onerror(){return a(this,x)}set onerror(t){u(this,x,t)}get onmessage(){return a(this,I)}set onmessage(t){u(this,I,t)}get onopen(){return a(this,$)}set onopen(t){u(this,$,t)}addEventListener(t,n,o){let s=n;super.addEventListener(t,s,o)}removeEventListener(t,n,o){let s=n;super.removeEventListener(t,s,o)}close(){a(this,b)&&clearTimeout(a(this,b)),a(this,g)!==this.CLOSED&&(a(this,v)&&a(this,v).abort(),u(this,g,this.CLOSED),u(this,v,void 0))}};g=new WeakMap,N=new WeakMap,L=new WeakMap,B=new WeakMap,K=new WeakMap,H=new WeakMap,b=new WeakMap,F=new WeakMap,v=new WeakMap,U=new WeakMap,x=new WeakMap,I=new WeakMap,$=new WeakMap,S=new WeakSet,q=function(){u(this,g,this.CONNECTING),u(this,v,new AbortController),a(this,K)(a(this,N),T(this,S,dt).call(this)).then(a(this,Q)).catch(a(this,z))},Q=new WeakMap,z=new WeakMap,dt=function(){var e;let t={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...a(this,F)?{"Last-Event-ID":a(this,F)}:void 0},cache:"no-store",signal:(e=a(this,v))==null?void 0:e.signal};return"window"in globalThis&&(t.credentials=this.withCredentials?"include":"same-origin"),t},Z=new WeakMap,tt=new WeakMap,W=function(e,t){var n;a(this,g)!==this.CLOSED&&u(this,g,this.CLOSED);let o=new G("error",{code:t,message:e});(n=a(this,x))==null||n.call(this,o),this.dispatchEvent(o)},et=function(e,t){var n;if(a(this,g)===this.CLOSED)return;u(this,g,this.CONNECTING);let o=new G("error",{code:t,message:e});(n=a(this,x))==null||n.call(this,o),this.dispatchEvent(o),u(this,b,setTimeout(a(this,nt),a(this,H)))},nt=new WeakMap,M.CONNECTING=0,M.OPEN=1,M.CLOSED=2;Object.defineProperty(M,Symbol.for("eventsource.supports-fetch-override"),{value:!0,writable:!1,configurable:!1,enumerable:!1});function Mt(){let e="document"in globalThis?globalThis.document:void 0;return e&&typeof e=="object"&&"baseURI"in e&&typeof e.baseURI=="string"?e.baseURI:void 0}function At(e,t,n){return e==="PreCompact"?t?{continue:!0,suppressOutput:!0}:{continue:!1,stopReason:n.reason||"Pre-compact operation failed",suppressOutput:!0}:e==="SessionStart"?t&&n.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:n.context}}:{continue:!0,suppressOutput:!0}:e==="UserPromptSubmit"||e==="PostToolUse"?{continue:!0,suppressOutput:!0}:e==="Stop"?{continue:!0,suppressOutput:!0}:{continue:t,suppressOutput:!0,...n.reason&&!t?{stopReason:n.reason}:{}}}function A(e,t,n={}){let o=At(e,t,n);return JSON.stringify(o)}var st=(r=>(r[r.DEBUG=0]="DEBUG",r[r.INFO=1]="INFO",r[r.WARN=2]="WARN",r[r.ERROR=3]="ERROR",r[r.SILENT=4]="SILENT",r))(st||{}),rt=class{level;useColor;constructor(){let t=process.env.CLAUDE_MEM_LOG_LEVEL?.toUpperCase()||"INFO";this.level=st[t]??1,this.useColor=process.stdout.isTTY??!1}correlationId(t,n){return`obs-${t}-${n}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.level===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let n=Object.keys(t);return n.length===0?"{}":n.length<=3?JSON.stringify(t):`{${n.length} keys: ${n.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,n){if(!n)return t;try{let o=typeof n=="string"?JSON.parse(n):n;if(t==="Bash"&&o.command){let s=o.command.length>50?o.command.substring(0,50)+"...":o.command;return`${t}(${s})`}if(t==="Read"&&o.file_path){let s=o.file_path.split("/").pop()||o.file_path;return`${t}(${s})`}if(t==="Edit"&&o.file_path){let s=o.file_path.split("/").pop()||o.file_path;return`${t}(${s})`}if(t==="Write"&&o.file_path){let s=o.file_path.split("/").pop()||o.file_path;return`${t}(${s})`}return t}catch{return t}}log(t,n,o,s,r){if(t<this.level)return;let i=new Date().toISOString().replace("T"," ").substring(0,23),c=st[t].padEnd(5),d=n.padEnd(6),E="";s?.correlationId?E=`[${s.correlationId}] `:s?.sessionId&&(E=`[session-${s.sessionId}] `);let f="";r!=null&&(this.level===0&&typeof r=="object"?f=`
`+JSON.stringify(r,null,2):f=" "+this.formatData(r));let _="";if(s){let{sessionId:y,sdkSessionId:w,correlationId:l,...p}=s;Object.keys(p).length>0&&(_=` {${Object.entries(p).map(([k,P])=>`${k}=${P}`).join(", ")}}`)}let C=`[${i}] [${c}] [${d}] ${E}${o}${_}${f}`;t===3?console.error(C):console.log(C)}debug(t,n,o,s){this.log(0,t,n,o,s)}info(t,n,o,s){this.log(1,t,n,o,s)}warn(t,n,o,s){this.log(2,t,n,o,s)}error(t,n,o,s){this.log(3,t,n,o,s)}dataIn(t,n,o,s){this.info(t,`\u2192 ${n}`,o,s)}dataOut(t,n,o,s){this.info(t,`\u2190 ${n}`,o,s)}success(t,n,o,s){this.info(t,`\u2713 ${n}`,o,s)}failure(t,n,o,s){this.error(t,`\u2717 ${n}`,o,s)}timing(t,n,o,s){this.info(t,`\u23F1 ${n}`,s,{duration:`${o}ms`})}},O=new rt;import ct from"path";import{homedir as xt}from"os";import{spawnSync as kt}from"child_process";import{join as m,dirname as wt,basename as ne}from"path";import{homedir as Et}from"os";import{fileURLToPath as Dt}from"url";function Nt(){return typeof __dirname<"u"?__dirname:wt(Dt(import.meta.url))}var Rt=Nt(),R=process.env.CLAUDE_MEM_DATA_DIR||m(Et(),".claude-mem"),it=process.env.CLAUDE_CONFIG_DIR||m(Et(),".claude"),ie=m(R,"archives"),ae=m(R,"logs"),ce=m(R,"trash"),le=m(R,"backups"),ue=m(R,"settings.json"),pe=m(R,"claude-mem.db"),fe=m(R,"vector-db"),de=m(it,"settings.json"),he=m(it,"commands"),Ee=m(it,"CLAUDE.md");function at(){return m(Rt,"..","..")}import{readFileSync as It,existsSync as bt}from"fs";var Lt=["bugfix","feature","refactor","discovery","decision","change"],Ut=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var _t=Lt.join(","),gt=Ut.join(",");var X=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:_t,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:gt,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_ENDLESS_MODE:"false",CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS:"90000"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return process.env[t]||this.DEFAULTS[t]}static getInt(t){let n=this.get(t);return parseInt(n,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){if(!bt(t))return this.getAllDefaults();let n=It(t,"utf-8"),s=JSON.parse(n).env||{},r={...this.DEFAULTS};for(let i of Object.keys(this.DEFAULTS))s[i]!==void 0&&(r[i]=s[i]);return r}};var Pt=100,$t=500,Wt=10;function V(){let e=ct.join(xt(),".claude-mem","settings.json"),t=X.loadFromFile(e);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function mt(){try{let e=V();return(await fetch(`http://127.0.0.1:${e}/health`,{signal:AbortSignal.timeout(Pt)})).ok}catch{return!1}}async function Ht(){try{let e=at(),t=ct.join(e,"ecosystem.config.cjs");if(!existsSync(t))throw new Error(`Ecosystem config not found at ${t}`);let n=ct.join(e,"node_modules",".bin","pm2"),o=process.platform==="win32"?n+".cmd":n,s=existsSync(o)?o:"pm2",r=kt(s,["start",t],{cwd:e,stdio:"pipe",encoding:"utf-8",windowsHide:!0});if(r.status!==0)throw new Error(r.stderr||"PM2 start failed");for(let i=0;i<Wt;i++)if(await new Promise(c=>setTimeout(c,$t)),await mt())return!0;return!1}catch{return!1}}async function St(){if(await mt())return;if(!await Ht()){let t=V(),n=at();throw new Error(`Worker service failed to start on port ${t}.

To start manually, run:
  cd ${n}
  npx pm2 start ecosystem.config.cjs

If already running, try: npx pm2 restart claude-mem-worker`)}}import{readFile as Ft,writeFile as jt}from"fs/promises";async function Ot(e,t){let n=0;try{let o=await Ft(e,"utf-8"),s=JSON.parse(o),r=!1;for(let i of s)if(!(!i.content||!Array.isArray(i.content))){for(let c of i.content)if(c.type==="tool_use"&&c.id===t&&c.input&&Object.keys(c.input).length>0){let d=JSON.stringify(c.input);n=Math.floor(d.length/4),c.input={},r=!0}}r&&await jt(e,JSON.stringify(s,null,2),"utf-8")}catch(o){console.error(`Failed to clear tool input in transcript: ${o.message}`)}return n}function Tt(e){let n={decision:"\u2696\uFE0F",bugfix:"\u{1F534}",feature:"\u{1F7E3}",refactor:"\u{1F504}",discovery:"\u{1F535}",change:"\u2705"}[e.type]||"\u{1F4DD}",o=`**#${e.id}** ${n} **${e.title||"Observation"}**

`;if(e.subtitle&&(o+=`${e.subtitle}

`),e.narrative&&(o+=`${e.narrative}

`),e.facts)try{let i=JSON.parse(e.facts);i.length>0&&(o+=`**Facts:**
${i.map(c=>`- ${c}`).join(`
`)}

`)}catch{}if(e.concepts)try{let i=JSON.parse(e.concepts);i.length>0&&(o+=`**Concepts:** ${i.join(", ")}

`)}catch{}let s=e.files_read?JSON.parse(e.files_read):[],r=e.files_modified?JSON.parse(e.files_modified):[];return(s.length>0||r.length>0)&&(o+=`**Files:**
`,s.length>0&&(o+=`- Read: ${s.join(", ")}
`),r.length>0&&(o+=`- Modified: ${r.join(", ")}
`),o+=`
`),o+=`Read: ~${Math.ceil((e.text?.length||0)/4)}, Work: \u{1F50D} ${e.discovery_tokens}`,o.trim()}var Xt=new Set(["ListMcpResourcesTool","SlashCommand","Skill","TodoWrite","AskUserQuestion"]);function Vt(){try{let e=Kt.join(Gt(),".claude-mem","settings.json"),t=Bt(e,"utf-8"),o=JSON.parse(t).env||{};return{enabled:o.CLAUDE_MEM_ENDLESS_MODE==="true",waitTimeoutMs:parseInt(o.CLAUDE_MEM_ENDLESS_WAIT_TIMEOUT_MS||"90000",10)}}catch{return{enabled:!1,waitTimeoutMs:9e4}}}var lt=Vt();async function Jt(e,t){return new Promise(n=>{let o=setTimeout(()=>{s?.close(),n(!1)},t),s=null;try{s=new M(`http://127.0.0.1:${e}/events`),s.addEventListener("processing_status",r=>{try{JSON.parse(r.data).queueDepth===0&&(clearTimeout(o),s?.close(),n(!0))}catch{}}),s.onerror=()=>{clearTimeout(o),s?.close(),n(!1)}}catch{clearTimeout(o),n(!1)}})}async function Yt(e){if(!e)throw new Error("saveHook requires input");let{session_id:t,transcript_path:n,cwd:o,tool_name:s,tool_input:r,tool_response:i,tool_use_id:c}=e;if(Xt.has(s)){console.log(A("PostToolUse",!0));return}await St();let d=V(),E=O.formatTool(s,r);O.dataIn("HOOK",`PostToolUse: ${E}`,{workerPort:d});try{let f=await fetch(`http://127.0.0.1:${d}/api/sessions/observations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,tool_name:s,tool_input:r,tool_response:i,cwd:o||"",toolUseId:c}),signal:AbortSignal.timeout(2e3)});if(!f.ok){let _=await f.text();throw O.failure("HOOK","Failed to send observation",{status:f.status},_),new Error(`Failed to send observation to worker: ${f.status} ${_}`)}O.debug("HOOK","Observation sent successfully",{toolName:s})}catch(f){throw f.cause?.code==="ECONNREFUSED"||f.name==="TimeoutError"||f.message.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):f}if(!c||!n){console.log(A("PostToolUse",!0));return}try{if(O.debug("HOOK","Waiting for observations to be processed",{toolUseId:c,timeoutMs:lt.waitTimeoutMs}),!await Jt(d,lt.waitTimeoutMs)){O.debug("HOOK","Timeout waiting for observations",{toolUseId:c}),console.log(A("PostToolUse",!0));return}let _=await fetch(`http://127.0.0.1:${d}/api/sessions/observations-for-tool-use/${c}`,{signal:AbortSignal.timeout(2e3)});if(!_.ok){console.log(A("PostToolUse",!0));return}let y=(await _.json()).observations||[];if(y.length===0){O.debug("HOOK","No observations found for tool_use_id",{toolUseId:c}),console.log(A("PostToolUse",!0));return}if(!lt.enabled){console.log(A("PostToolUse",!0));return}O.debug("HOOK","Endless Mode: observations retrieved",{toolUseId:c,count:y.length}),await Ot(n,c);let w=y.map(Tt).join(`

---

`);console.log(JSON.stringify({hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:w}}))}catch(f){O.failure("HOOK","Error waiting for observations (falling back to normal)",{toolUseId:c},f.message),console.log(A("PostToolUse",!0))}}var ut="";Ct.on("data",e=>ut+=e);Ct.on("end",async()=>{let e=ut?JSON.parse(ut):void 0;await Yt(e)});
