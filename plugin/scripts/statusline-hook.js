#!/usr/bin/env bun
import{stdin as u}from"process";var s={reset:"\x1B[0m",green:"\x1B[32m",yellow:"\x1B[33m",red:"\x1B[31m",cyan:"\x1B[36m",dim:"\x1B[2m",bold:"\x1B[1m"};function c(t){return t<60?`${s.green}\u{1F7E2}${s.reset}`:t<80?`${s.yellow}\u{1F7E1}${s.reset}`:`${s.red}\u{1F534}${s.reset}`}function m(t){if(!t||!t.current_usage)return 0;let{current_usage:n,context_window_size:o}=t,e=n.input_tokens+n.cache_creation_input_tokens+n.cache_read_input_tokens;return Math.round(e/o*100)}async function d(){try{let t=new AbortController,n=setTimeout(()=>t.abort(),500),o=await fetch("http://127.0.0.1:37777/api/stats",{signal:t.signal});if(clearTimeout(n),o.ok){let e=await o.json();return{observations:e.database?.observations??null,savings:e.savings?.current?.savings??null,savingsPercent:e.savings?.current?.savingsPercent??null}}}catch{}return{observations:null,savings:null,savingsPercent:null}}async function _(t){if(!t)return{observationsCount:null,totalTokens:null,promptsCount:null};try{let n=new AbortController,o=setTimeout(()=>n.abort(),500),e=await fetch(`http://127.0.0.1:37777/api/session/${t}/stats`,{signal:n.signal});if(clearTimeout(o),e.ok){let a=await e.json();return{observationsCount:a.observationsCount??null,totalTokens:a.totalTokens??null,promptsCount:a.promptsCount??null}}}catch{}return{observationsCount:null,totalTokens:null,promptsCount:null}}function l(t){return t>=1e6?`${(t/1e6).toFixed(1)}M`:t>=1e3?`${(t/1e3).toFixed(0)}k`:t.toString()}async function b(t){let n=[],o=t.model?.display_name||"Claude";if(n.push(`${s.cyan}[${o}]${s.reset}`),t.context_window){let r=m(t.context_window),i=c(r);n.push(`${i} ${r}%`)}let[e,a]=await Promise.all([d(),_(t.session_id)]);if(a.observationsCount!==null&&a.observationsCount>0){let r=a.totalTokens?` ${l(a.totalTokens)}t`:"";n.push(`${s.bold}\u{1F4DD} ${a.observationsCount}${r}${s.reset}`)}if(e.observations!==null&&n.push(`${s.dim}${e.observations} total${s.reset}`),e.savings!==null&&e.savings>0){let r=l(e.savings),i=e.savingsPercent!==null?` (${e.savingsPercent}%)`:"";n.push(`${s.green}\u{1F4B0} ${r}t saved${i}${s.reset}`)}if(t.workspace?.current_dir){let r=t.workspace.current_dir.split("/").pop()||"";n.push(`${s.dim}\u{1F4C1} ${r}${s.reset}`)}if(t.cost?.total_cost_usd&&t.cost.total_cost_usd>0){let r=t.cost.total_cost_usd.toFixed(4);n.push(`${s.dim}$${r}${s.reset}`)}return n.join(" | ")}async function p(){let t="";u.on("data",n=>{t+=n}),u.on("end",async()=>{try{let n=t?JSON.parse(t):{},o=await b(n);console.log(o)}catch{console.log(`${s.cyan}[Claude-Mem]${s.reset}`)}})}p().catch(()=>{console.log("[Claude-Mem]")});
