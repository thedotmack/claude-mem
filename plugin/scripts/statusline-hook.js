#!/usr/bin/env bun
import{stdin as l}from"process";var s={reset:"\x1B[0m",green:"\x1B[32m",yellow:"\x1B[33m",red:"\x1B[31m",cyan:"\x1B[36m",dim:"\x1B[2m",bold:"\x1B[1m"};function m(t){return t<60?`${s.green}\u{1F7E2}${s.reset}`:t<80?`${s.yellow}\u{1F7E1}${s.reset}`:`${s.red}\u{1F534}${s.reset}`}function d(t){if(!t||!t.current_usage)return 0;let{current_usage:n,context_window_size:r}=t,i=n.input_tokens+n.cache_creation_input_tokens+n.cache_read_input_tokens;return Math.round(i/r*100)}function p(t){if(!t||t.trim()==="")return null;let n=t.split("/").filter(Boolean);return n.length>0?n[n.length-1]:null}async function g(t){try{let n=new AbortController,r=setTimeout(()=>n.abort(),500),i=t?`http://127.0.0.1:37777/api/stats?project=${encodeURIComponent(t)}`:"http://127.0.0.1:37777/api/stats",e=await fetch(i,{signal:n.signal});if(clearTimeout(r),e.ok){let a=await e.json();return{observations:a.database?.observations??null,savings:a.savings?.current?.savings??null,savingsPercent:a.savings?.current?.savingsPercent??null}}}catch{}return{observations:null,savings:null,savingsPercent:null}}async function _(t){if(!t)return{observationsCount:null,totalTokens:null,promptsCount:null};try{let n=new AbortController,r=setTimeout(()=>n.abort(),500),i=await fetch(`http://127.0.0.1:37777/api/session/${t}/stats`,{signal:n.signal});if(clearTimeout(r),i.ok){let e=await i.json();return{observationsCount:e.observationsCount??null,totalTokens:e.totalTokens??null,promptsCount:e.promptsCount??null}}}catch{}return{observationsCount:null,totalTokens:null,promptsCount:null}}function c(t){return t>=1e6?`${(t/1e6).toFixed(1)}M`:t>=1e3?`${(t/1e3).toFixed(0)}k`:t.toString()}async function b(t){let n=[],r=t.model?.display_name||"Claude";if(n.push(`${s.cyan}[${r}]${s.reset}`),t.context_window){let o=d(t.context_window),u=m(o);n.push(`${u} ${o}%`)}let i=p(t.workspace?.current_dir),[e,a]=await Promise.all([g(i),_(t.session_id)]);if(a.observationsCount!==null&&a.observationsCount>0){let o=a.totalTokens?` ${c(a.totalTokens)}t`:"";n.push(`${s.bold}\u{1F4DD} ${a.observationsCount}${o}${s.reset}`)}if(e.observations!==null&&n.push(`${s.dim}${e.observations} total${s.reset}`),e.savings!==null&&e.savings>0){let o=c(e.savings),u=e.savingsPercent!==null?` (${e.savingsPercent}%)`:"";n.push(`${s.green}\u{1F4B0} ${o}t saved${u}${s.reset}`)}if(t.workspace?.current_dir){let o=t.workspace.current_dir.split("/").pop()||"";n.push(`${s.dim}\u{1F4C1} ${o}${s.reset}`)}if(t.cost?.total_cost_usd&&t.cost.total_cost_usd>0){let o=t.cost.total_cost_usd.toFixed(4);n.push(`${s.dim}$${o}${s.reset}`)}return n.join(" | ")}async function $(){let t="";l.on("data",n=>{t+=n}),l.on("end",async()=>{try{let n=t?JSON.parse(t):{},r=await b(n);console.log(r)}catch{console.log(`${s.cyan}[Claude-Mem]${s.reset}`)}})}$().catch(()=>{console.log("[Claude-Mem]")});
